"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6299],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>u});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=i.createContext({}),c=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return i.createElement(l.Provider,{value:n},e.children)},h="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=c(t),d=r,u=h["".concat(l,".").concat(d)]||h[d]||m[d]||a;return t?i.createElement(u,s(s({ref:n},p),{},{components:t})):i.createElement(u,s({ref:n},p))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,s=new Array(a);s[0]=d;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o[h]="string"==typeof e?e:r,s[1]=o;for(var c=2;c<a;c++)s[c]=t[c];return i.createElement.apply(null,s)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},6413:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var i=t(7462),r=(t(7294),t(3905));const a={},s="Watch",o={unversionedId:"webpack-resolve/hmr-watch",id:"webpack-resolve/hmr-watch",title:"Watch",description:"\u542f\u7528 Watch \u6a21\u5f0f\u3002\u8fd9\u610f\u5473\u7740\u5728\u521d\u59cb\u6784\u5efa\u4e4b\u540e\uff0cwebpack \u5c06\u7ee7\u7eed\u76d1\u542c\u4efb\u4f55\u5df2\u89e3\u6790\u6587\u4ef6\u7684\u66f4\u6539\u3002Watch \u6a21\u5f0f\u9ed8\u8ba4\u5173\u95ed\u3002",source:"@site/docs/webpack-resolve/hmr-watch.md",sourceDirName:"webpack-resolve",slug:"/webpack-resolve/hmr-watch",permalink:"/docs/webpack-resolve/hmr-watch",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"cli",permalink:"/docs/webpack-resolve/cli"},next:{title:"\u6a21\u5757\u70ed\u66ff\u6362",permalink:"/docs/webpack-resolve/hmr"}},l={},c=[],p={toc:c},h="wrapper";function m(e){let{components:n,...a}=e;return(0,r.kt)(h,(0,i.Z)({},p,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"watch"},"Watch"),(0,r.kt)("p",null,"\u542f\u7528 Watch \u6a21\u5f0f\u3002\u8fd9\u610f\u5473\u7740\u5728\u521d\u59cb\u6784\u5efa\u4e4b\u540e\uff0cwebpack \u5c06\u7ee7\u7eed\u76d1\u542c\u4efb\u4f55\u5df2\u89e3\u6790\u6587\u4ef6\u7684\u66f4\u6539\u3002Watch \u6a21\u5f0f\u9ed8\u8ba4\u5173\u95ed\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"watch: true\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"webpack-dev-server")," \u548c ",(0,r.kt)("strong",{parentName:"p"},"webpack-dev-middleware")," \u91cc Watch \u6a21\u5f0f\u9ed8\u8ba4\u5f00\u542f\u3002",(0,r.kt)("br",{parentName:"p"}),"\n",(0,r.kt)("a",{parentName:"p",href:"https://www.webpackjs.com/configuration/watch/"},"watch \u548c watchOptions | webpack \u4e2d\u6587\u7f51"))),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(4024).Z,width:"687",height:"991"})),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(5094).Z,width:"687",height:"1121"})),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(834).Z,width:"808",height:"1001"})),(0,r.kt)("p",null,"\u5728\u4e00\u5f00\u59cb\u7684\u521b\u5efa compiler \u5bf9\u8c61\u6dfb\u52a0\u6587\u4ef6\u7684\u5904\u7406\u65b9\u6cd5\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// webpack.js\nconst webpack = (options, callback) => {\n    // ...\n    new NodeEnvironmentPlugin({2\n        infrastructureLogging: options.infrastructureLogging\n    }).apply(compiler);\n    // ...\n}\n\n\n// /node/NodeEnvironmentPlugin.js\nclass NodeEnvironmentPlugin {\n      apply(compiler) {\n          // ...\n        compiler.inputFileSystem = new CachedInputFileSystem(\n            new NodeJsInputFileSystem(),\n            60000\n        );\n        const inputFileSystem = compiler.inputFileSystem;\n        compiler.outputFileSystem = new NodeOutputFileSystem();\n        compiler.watchFileSystem = new NodeWatchFileSystem(\n            compiler.inputFileSystem\n        ); // \u751f\u6210\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u6ca1\u6709\u7ed1\u5b9a\u4efb\u4f55\u4e8b\u4ef6\n        compiler.hooks.beforeRun.tap("NodeEnvironmentPlugin", compiler => {\n            if (compiler.inputFileSystem === inputFileSystem) inputFileSystem.purge();\n        });\n    }\n}\n')),(0,r.kt)("p",null,"\u666e\u901a\u6a21\u5f0f\u4e0b\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"compiler.run")," \u65b9\u6cd5\u3002\u5728\u5f00\u542f\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"watch")," \u6a21\u5f0f\u540e\uff0c\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"compiler.watch")," \u65b9\u6cd5\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"watch(watchOptions, handler) {\n      // ...\n      return new Watching(this, watchOptions, handler);\n}\n")),(0,r.kt)("p",null,"\u521d\u59cb\u5316",(0,r.kt)("inlineCode",{parentName:"p"},"new Watching"),"\uff0c\u5185\u90e8\u6700\u7ec8\u6267\u884c\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"this._go()"),"\uff0c\u5185\u90e8\u4e0e ",(0,r.kt)("inlineCode",{parentName:"p"},"compiler.run")," \u6709\u4e9b\u7c7b\u4f3c\uff0c\u6700\u7ec8\u4f1a\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"this._done(null, compilation)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"class Watching {\n    constructor(compiler, watchOptions, handler) {\n        // ...\n        this.compiler.readRecords((err) => {\n            if (err) return this._done(err);\n\n            this._go();\n        });\n    }\n\n    _go() {\n        this.startTime = Date.now();\n        this.running = true;\n        this.invalid = false;\n        this.compiler.hooks.watchRun.callAsync(this.compiler, (err) => {\n            if (err) return this._done(err);\n            const onCompiled = (err, compilation) => {\n                if (err) return this._done(err);\n                if (this.invalid) return this._done();\n\n                if (\n                    this.compiler.hooks.shouldEmit.call(compilation) === false\n                ) {\n                    return this._done(null, compilation);\n                }\n\n                this.compiler.emitAssets(compilation, (err) => {\n                    if (err) return this._done(err);\n                    if (this.invalid) return this._done();\n                    this.compiler.emitRecords((err) => {\n                        if (err) return this._done(err);\n\n                        if (compilation.hooks.needAdditionalPass.call()) {\n                            compilation.needAdditionalPass = true;\n\n                            const stats = new Stats(compilation);\n                            stats.startTime = this.startTime;\n                            stats.endTime = Date.now();\n                            this.compiler.hooks.done.callAsync(stats, (err) => {\n                                if (err) return this._done(err);\n\n                                this.compiler.hooks.additionalPass.callAsync(\n                                    (err) => {\n                                        if (err) return this._done(err);\n                                        this.compiler.compile(onCompiled);\n                                    }\n                                );\n                            });\n                            return;\n                        }\n                        return this._done(null, compilation);\n                    });\n                });\n            };\n            this.compiler.compile(onCompiled);\n        });\n    }\n}\n")),(0,r.kt)("p",null,"\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"this._done"),"\u4e2d\uff0c\u89e6\u53d1\u4e86 hooks.done \u3002\u5728\u6784\u5efa\u5b8c\u6210\u4e4b\u540e\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"this.watch")," \u4e3a\u6587\u4ef6\u6dfb\u52a0\u76d1\u542c\u5668\u3002\u4f20\u5165",(0,r.kt)("inlineCode",{parentName:"p"},"fileDependencies"),",",(0,r.kt)("inlineCode",{parentName:"p"},"contextDependencies"),",",(0,r.kt)("inlineCode",{parentName:"p"},"missingDependencies"),"\u8fd9 3 \u4e2a\u53c2\u6570\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"    _done(err, compilation) {\n        this.running = false;\n        if (this.invalid) return this._go();\n\n        const stats = compilation ? this._getStats(compilation) : null;\n        if (err) {\n            this.compiler.hooks.failed.call(err);\n            this.handler(err, stats);\n            return;\n        }\n        this.compiler.hooks.done.callAsync(stats, () => {\n            this.handler(null, stats);\n            if (!this.closed) {\n                this.watch(\n                    Array.from(compilation.fileDependencies),\n                    Array.from(compilation.contextDependencies),\n                    Array.from(compilation.missingDependencies)\n                );\n            }\n            for (const cb of this.callbacks) cb();\n            this.callbacks.length = 0;\n        });\n    }\n\n    watch(files, dirs, missing) {\n        this.pausedWatcher = null;\n        this.watcher = this.compiler.watchFileSystem.watch(\n            files,\n            dirs,\n            missing,\n            this.startTime,\n            this.watchOptions,\n            (\n                err,\n                filesModified,\n                contextModified,\n                missingModified,\n                fileTimestamps,\n                contextTimestamps,\n                removedFiles\n            ) => {\n                this.pausedWatcher = this.watcher;\n                this.watcher = null;\n                if (err) {\n                    return this.handler(err);\n                }\n                this.compiler.fileTimestamps = fileTimestamps;\n                this.compiler.contextTimestamps = contextTimestamps;\n                this.compiler.removedFiles = removedFiles;\n                if (!this.suspended) {\n                    this._invalidate();\n                }\n            },\n            (fileName, changeTime) => {\n                this.compiler.hooks.invalid.call(fileName, changeTime);\n            }\n        );\n    }\n")),(0,r.kt)("p",null,"Watcher \u7ee7\u627f\u81f3 node \u7684 EventEmitter\uff0c\u53ef\u4ee5\u8fdb\u884c\u4e8b\u4ef6\u7684\u7ed1\u5b9a\u76d1\u542c\u3002\u7ed1\u5b9a\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"change"),"\uff0c ",(0,r.kt)("inlineCode",{parentName:"p"},"aggregated"),"\u4e8b\u4ef6\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"this.watcher.once('change', callbackUndelayed);\nthis.watcher.once('aggregated', (changes, removals) => {\n    changes = changes.concat(removals);\n    if (this.inputFileSystem && this.inputFileSystem.purge) {\n        this.inputFileSystem.purge(changes);\n    }\n    const times = objectToMap(this.watcher.getTimes());\n    files = new Set(files);\n    dirs = new Set(dirs);\n    missing = new Set(missing);\n    removals = new Set(removals.filter((file) => files.has(file)));\n    callback(\n        null,\n        changes.filter((file) => files.has(file)).sort(),\n        changes.filter((file) => dirs.has(file)).sort(),\n        changes.filter((file) => missing.has(file)).sort(),\n        times,\n        times,\n        removals\n    );\n});\n")),(0,r.kt)("p",null,"fileWatcher \u4f7f\u7528 chokidar \u8fdb\u884c\u76d1\u542c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"var chokidar = require('./chokidar');\n\nthis.watcher = chokidar.watch(directoryPath, {\n    ignoreInitial: true,\n    persistent: true,\n    followSymlinks: false,\n    depth: 0,\n    atomic: false,\n    alwaysStat: true,\n    ignorePermissionErrors: true,\n    ignored: options.ignored,\n    usePolling: options.poll ? true : undefined,\n    interval: interval,\n    binaryInterval: interval,\n    disableGlobbing: true\n});\nthis.watcher.on('add', this.onFileAdded.bind(this));\nthis.watcher.on('addDir', this.onDirectoryAdded.bind(this));\nthis.watcher.on('change', this.onChange.bind(this));\nthis.watcher.on('unlink', this.onFileUnlinked.bind(this));\nthis.watcher.on('unlinkDir', this.onDirectoryUnlinked.bind(this));\nthis.watcher.on('error', this.onWatcherError.bind(this));\n")),(0,r.kt)("p",null,"\u5728 done.hooks \u4e2d\u4e3a\u6bcf\u4e2a\u6587\u4ef6\u589e\u52a0\u4e00\u4e2a\u76d1\u542c\u5668\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{src:t(9673).Z,width:"821",height:"451"})),(0,r.kt)("p",null,"#webpack"))}m.isMDXComponent=!0},4024:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/build_flow-f3b4a434a0e69e81263f83be904d4583.png"},834:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/change_watch_flow-8c9f4c3860b5202368b463e8d354314a.png"},9673:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/watch-c675f11c44309514b1a02b93b23403de.png"},5094:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/watch_flow-e0ebf8ed77cca9c5eaec40243631851c.png"}}]);