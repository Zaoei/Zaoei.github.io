"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6103],{5603:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>i});var t=r(4848),s=r(5680);const o={},a="webpack modules",l={id:"webpack-resolve/module",title:"webpack modules",description:"\u6a21\u5757\u7684\u7c7b\u578b",source:"@site/docs/webpack-resolve/module.md",sourceDirName:"webpack-resolve",slug:"/webpack-resolve/module",permalink:"/docs/webpack-resolve/module",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"loader",permalink:"/docs/webpack-resolve/loader"},next:{title:"whoami",permalink:"/docs/whoami"}},c={},i=[{value:"\u6a21\u5757\u7684\u7c7b\u578b",id:"\u6a21\u5757\u7684\u7c7b\u578b",level:2},{value:"\u6267\u884c\u8fc7\u7a0b",id:"\u6267\u884c\u8fc7\u7a0b",level:2},{value:"chunk \u751f\u6210",id:"chunk-\u751f\u6210",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.RP)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"webpack-modules",children:"webpack modules"}),"\n",(0,t.jsx)(n.h2,{id:"\u6a21\u5757\u7684\u7c7b\u578b",children:"\u6a21\u5757\u7684\u7c7b\u578b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"NormalModule: \u666e\u901a\u6a21\u5757\uff0c\u6211\u4eec\u7684\u5165\u53e3\u6a21\u5757\uff0cloader"}),"\n",(0,t.jsx)(n.li,{children:"ContextModule: ['./a.js', './b.js'], \u5c1a\u672a\u786e\u5b9a\u5e72\u561b\u7528\u7684"}),"\n",(0,t.jsx)(n.li,{children:"ExternalModule: \u5916\u90e8\u6a21\u5757 module.exports = jQuery"}),"\n",(0,t.jsx)(n.li,{children:"DelegatedModule: \u59d4\u6258\u6a21\u5757\uff0c\u5728\u5f00\u542f DLLPlugin \u7684\u65f6\u5019\uff0c\u4f1a\u751f\u6210 manifest \u6587\u4ef6\uff0c\u8fd9\u4e2a manifest \u5c31\u662f\u59d4\u6258\u6a21\u5757"}),"\n",(0,t.jsx)(n.li,{children:"RawModule: \u539f\u59cb\u6a21\u5757"}),"\n",(0,t.jsx)(n.li,{children:"RuntimeModule: \u8fd0\u884c\u65f6\u6a21\u5757"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6a21\u5757\u7684\u5206\u7c7b\uff0c\u4e0d\u540c\u7684\u6a21\u5757\u4f7f\u7528\u4e0d\u540c\u7684\u7c7b\u3002\n",(0,t.jsx)(n.img,{src:r(893).A+"",width:"2742",height:"978"})]}),"\n",(0,t.jsx)(n.h2,{id:"\u6267\u884c\u8fc7\u7a0b",children:"\u6267\u884c\u8fc7\u7a0b"}),"\n",(0,t.jsx)(n.p,{children:"webpack \u6267\u884c Complier.run(), \u6700\u7ec8\u6267\u884c compile \u65b9\u6cd5\uff0c\u5f00\u59cb\u521b\u5efa compilation \u5bf9\u8c61\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/Compiler.js 419\nconst run = () => {\n    this.hooks.beforeRun.callAsync(this, (err) => {\n        if (err) return finalCallback(err);\n\n        this.hooks.run.callAsync(this, (err) => {\n            if (err) return finalCallback(err);\n\n            this.readRecords((err) => {\n                if (err) return finalCallback(err);\n\n                this.compile(onCompiled);\n            });\n        });\n    });\n};\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u521b\u5efa compilation \u5bf9\u8c61\uff0c\u5e76\u4e14\u6267\u884c make \u94a9\u5b50\uff0c\u8fdb\u884c\u7f16\u8bd1\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/Compiler.js 1092\ncompile(callback) {\n    const params = this.newCompilationParams();\n    this.hooks.beforeCompile.callAsync(params, err => {\n        /* ... */\n        this.hooks.compile.call(params);\n\n        const compilation = this.newCompilation(params);\n\n        this.hooks.make.callAsync(compilation, err => {\n          /* ... */\n        });\n    });\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5728 EntryPlugin \u63d2\u4ef6\u4e2d\u6ce8\u518c make \u94a9\u5b50\uff0c\u6267\u884c compilation.addEntry \u65b9\u6cd5\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/EntryPlugin.js 48\ncompiler.hooks.make.tapAsync('EntryPlugin', (compilation, callback) => {\n    compilation.addEntry(context, dep, options, (err) => {\n        callback(err);\n    });\n});\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6267\u884c addEntry \u7684 hooks\u3002\u53ef\u4ee5\u505a ProgressPlugin \u63d2\u4ef6\u7684\u903b\u8f91\uff0c\u7528\u6765\u63a7\u5236\u8fdb\u5ea6\u6761\u7b49\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/Compilation.js 2174\nthis.hooks.addEntry.call(entry, options);\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"moduleFactory.create"}),"\uff0c\u521b\u5efa module"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/Compilation.js 1968\nfactory.create(/* ... */);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4e00\u5f00\u59cb\u4f1a\u5148\u5224\u65ad\u4e00\u4e0b\u8fd9\u4e2a\u6a21\u5757\u6709\u6ca1\u6709\u88ab\u6784\u5efa\u8fc7\uff0c\u6216\u8005\u5728\u7f13\u5b58\u4e2d\u662f\u5426\u6709\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"const dependencies = data.dependencies;\nconst cacheEntry = dependencyCache.get(dependencies[0]);\nif (cacheEntry) return callback(null, cacheEntry);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u67e5\u770b\u5f53\u524d\u6a21\u5757\u662f\u5426\u6709 resolveOptions \u914d\u7f6e\uff08\u4ece\u8fd9\u91cc\u5f00\u59cb\u8fdb\u5165\u89e3\u6790\uff09"}),"\n",(0,t.jsxs)(n.p,{children:["\u4ec0\u4e48\u662f resolveoptions \uff0c ",(0,t.jsx)(n.a,{href:"https://webpack.js.org/configuration/resolve/",children:"Resolve | webpack"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"const path = require('path');\n\nmodule.exports = {\n    //...\n    resolve: {\n        alias: {\n            Utilities: path.resolve(__dirname, 'src/utilities/'),\n            Templates: path.resolve(__dirname, 'src/templates/')\n        }, // \u522b\u540d\n        extensions: ['.js', '.json', '.wasm'] // \u5ffd\u7565\u6587\u4ef6\u540e\u7f00\n    }\n};\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6267\u884c beforeResolve \u94a9\u5b50, \u5728\u56de\u8c03\u4e2d\u89e6\u53d1 factory\u3001resolver \u94a9\u5b50\uff0c\u4f7f\u7528",(0,t.jsx)(n.code,{children:"asyncLib.parallel"}),"\uff0c\u540c\u65f6\u8c03\u7528 loader \u89e3\u6790\u5668\u548c\u6a21\u5757\u89e3\u6790\u5668\uff0c\u6700\u7ec8\u8fd4\u56de\u4e00\u4e2a\u6570\u7ec4\n\uff0c\u7d22\u5f15 0 \u4e3a\u884c\u5185 lodaer \u7684\u8def\u5f84\u7ed3\u679c\uff0c\u7d22\u5f15 1 \u4e3a\u6a21\u5757\u7684\u8def\u5f84\u7ed3\u679c\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// lib/NormalModuleFactory.js 395 v4\nconst factory = this.hooks.factory.call(null);\n\n// lib/NormalModuleFactory.js 123 v4\nthis.hooks.factory.tap('NormalModuleFactory', () => (result, callback) => {\n    let resolver = this.hooks.resolver.call(null);\n\n    // Ignored\n    if (!resolver) return callback();\n\n    resolver(result, (err, data) => {\n        if (err) return callback(err);\n\n        // Ignored\n        if (!data) return callback();\n\n        // direct module\n        if (typeof data.source === 'function') return callback(null, data);\n\n        this.hooks.afterResolve.callAsync(data, (err, result) => {\n            if (err) return callback(err);\n\n            // Ignored\n            if (!result) return callback();\n\n            let createdModule = this.hooks.createModule.call(result);\n            if (!createdModule) {\n                if (!result.request) {\n                    return callback(new Error('Empty dependency (no request)'));\n                }\n\n                createdModule = new NormalModule(result);\n            }\n\n            createdModule = this.hooks.module.call(createdModule, result);\n\n            return callback(null, createdModule);\n        });\n    });\n});\nthis.hooks.resolver.tap('NormalModuleFactory', () => (data, callback) => {\n    const contextInfo = data.contextInfo;\n    const context = data.context;\n    const request = data.request;\n\n    const loaderResolver = this.getResolver('loader'); // \u83b7\u53d6 loader \u8def\u5f84\u7684\u89e3\u6790\u5668\n    const normalResolver = this.getResolver('normal', data.resolveOptions); // \u83b7\u53d6\u6a21\u5757\u8def\u5f84\u7684\u89e3\u6790\u5668\n\n    let matchResource = undefined;\n    let requestWithoutMatchResource = request;\n    const matchResourceMatch = MATCH_RESOURCE_REGEX.exec(request);\n    if (matchResourceMatch) {\n        matchResource = matchResourceMatch[1];\n        if (/^\\.\\.?\\//.test(matchResource)) {\n            matchResource = path.join(context, matchResource);\n        }\n        requestWithoutMatchResource = request.substr(\n            matchResourceMatch[0].length\n        );\n    }\n\n    const noPreAutoLoaders = requestWithoutMatchResource.startsWith('-!');\n    const noAutoLoaders =\n        noPreAutoLoaders || requestWithoutMatchResource.startsWith('!');\n    const noPrePostAutoLoaders = requestWithoutMatchResource.startsWith('!!');\n    let elements = requestWithoutMatchResource\n        .replace(/^-?!+/, '')\n        .replace(/!!+/g, '!')\n        .split('!');\n    let resource = elements.pop();\n    elements = elements.map(identToLoaderRequest);\n\n    asyncLib.parallel(\n        [\n            (callback) =>\n                this.resolveRequestArray(\n                    contextInfo,\n                    context,\n                    elements,\n                    loaderResolver,\n                    callback\n                ),\n            (callback) => {\n                if (resource === '' || resource[0] === '?') {\n                    return callback(null, {\n                        resource\n                    });\n                }\n\n                normalResolver.resolve(\n                    contextInfo,\n                    context,\n                    resource,\n                    {},\n                    (err, resource, resourceResolveData) => {\n                        if (err) return callback(err);\n                        callback(null, {\n                            resourceResolveData,\n                            resource\n                        });\n                    }\n                );\n            }\n        ],\n        (err, results) => {\n            if (err) return callback(err);\n            let loaders = results[0]; // \u884c\u5185 loaders \u7684\u7ed3\u679c\n            const resourceResolveData = results[1].resourceResolveData;\n            resource = results[1].resource; // \u6a21\u5757\u7684\u8def\u5f84\u7ed3\u679c\n\n            // translate option idents\n            try {\n                for (const item of loaders) {\n                    if (\n                        typeof item.options === 'string' &&\n                        item.options[0] === '?'\n                    ) {\n                        const ident = item.options.substr(1);\n                        item.options = this.ruleSet.findOptionsByIdent(ident);\n                        item.ident = ident;\n                    }\n                }\n            } catch (e) {\n                return callback(e);\n            }\n\n            if (resource === false) {\n                // ignored\n                return callback(\n                    null,\n                    new RawModule(\n                        '/* (ignored) */',\n                        `ignored ${context} ${request}`,\n                        `${request} (ignored)`\n                    )\n                );\n            }\n\n            const userRequest =\n                (matchResource !== undefined ? `${matchResource}!=!` : '') +\n                loaders.map(loaderToIdent).concat([resource]).join('!');\n\n            let resourcePath =\n                matchResource !== undefined ? matchResource : resource;\n            let resourceQuery = '';\n            const queryIndex = resourcePath.indexOf('?');\n            if (queryIndex >= 0) {\n                resourceQuery = resourcePath.substr(queryIndex);\n                resourcePath = resourcePath.substr(0, queryIndex);\n            }\n\n            const result = this.ruleSet.exec({\n                resource: resourcePath,\n                realResource:\n                    matchResource !== undefined\n                        ? resource.replace(/\\?.*/, '')\n                        : resourcePath,\n                resourceQuery,\n                issuer: contextInfo.issuer,\n                compiler: contextInfo.compiler\n            });\n            const settings = {};\n            const useLoadersPost = [];\n            const useLoaders = [];\n            const useLoadersPre = [];\n            for (const r of result) {\n                if (r.type === 'use') {\n                    // \u5904\u7406\u524d\u7f6eloader\uff0c\u540e\u7f6eloader\uff0c\u4ee5\u53ca\u666e\u901a loader\n                    if (r.enforce === 'post' && !noPrePostAutoLoaders) {\n                        useLoadersPost.push(r.value);\n                    } else if (\n                        r.enforce === 'pre' &&\n                        !noPreAutoLoaders &&\n                        !noPrePostAutoLoaders\n                    ) {\n                        useLoadersPre.push(r.value);\n                    } else if (\n                        !r.enforce &&\n                        !noAutoLoaders &&\n                        !noPrePostAutoLoaders\n                    ) {\n                        useLoaders.push(r.value);\n                    }\n                } else if (\n                    typeof r.value === 'object' &&\n                    r.value !== null &&\n                    typeof settings[r.type] === 'object' &&\n                    settings[r.type] !== null\n                ) {\n                    settings[r.type] = cachedCleverMerge(\n                        settings[r.type],\n                        r.value\n                    );\n                } else {\n                    settings[r.type] = r.value;\n                }\n            }\n            asyncLib.parallel(\n                [\n                    this.resolveRequestArray.bind(\n                        this,\n                        contextInfo,\n                        this.context,\n                        useLoadersPost,\n                        loaderResolver\n                    ),\n                    this.resolveRequestArray.bind(\n                        this,\n                        contextInfo,\n                        this.context,\n                        useLoaders,\n                        loaderResolver\n                    ),\n                    this.resolveRequestArray.bind(\n                        this,\n                        contextInfo,\n                        this.context,\n                        useLoadersPre,\n                        loaderResolver\n                    )\n                ],\n                (err, results) => {\n                    // results[0]: post loader \u96c6\u5408\n                    // results[1]: normal loader \u96c6\u5408\n                    // results[2]: pre loader \u96c6\u5408\n                    // loaders: inline loader \u96c6\u5408\n                    if (err) return callback(err);\n                    if (matchResource === undefined) {\n                        loaders = results[0].concat(\n                            loaders,\n                            results[1],\n                            results[2]\n                        );\n                    } else {\n                        loaders = results[0].concat(\n                            results[1],\n                            loaders,\n                            results[2]\n                        );\n                    }\n                    process.nextTick(() => {\n                        const type = settings.type;\n                        const resolveOptions = settings.resolve;\n                        callback(null, {\n                            context: context,\n                            request: loaders\n                                .map(loaderToIdent)\n                                .concat([resource])\n                                .join('!'),\n                            dependencies: data.dependencies,\n                            userRequest,\n                            rawRequest: request,\n                            loaders,\n                            resource,\n                            matchResource,\n                            resourceResolveData,\n                            settings,\n                            type,\n                            parser: this.getParser(type, settings.parser),\n                            generator: this.getGenerator(\n                                type,\n                                settings.generator\n                            ),\n                            resolveOptions\n                        });\n                    });\n                }\n            );\n        }\n    );\n});\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u89e6\u53d1 afterResolve \u94a9\u5b50\uff0c\u6267\u884c\u56de\u8c03\uff0c\u901a\u8fc7\u4f20\u5165\u7684\u6570\u636e\uff0c\u521d\u59cb\u5316 NormalModule \u5bf9\u8c61\uff0c\u5230\u8fd9\u6a21\u5757\u7684\u751f\u6210\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u8981\u5bf9\u6a21\u5757\u8fdb\u884c build \u5904\u7406"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// result \u5373\u4e3a resolver \u8fd4\u56de\u7684\u7ec4\u5408\u5bf9\u8c61 data\nif (!createdModule) {\n    if (!result.request) {\n        return callback(new Error('Empty dependency (no request)'));\n    }\n\n    createdModule = new NormalModule(result);\n}\ncreatedModule = this.hooks.module.call(createdModule, result);\n\nreturn callback(null, createdModule);\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6267\u884c buildModule \u65b9\u6cd5\u5f00\u59cb build \u6a21\u5757"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"//  lib/Compilation.js 1111 v4\nthis.buildModule(module, false, null, null, err => {\n    /* */\n    afterBuild();\n});\n\nbuildModule(module, optional, origin, dependencies, thisCallback) {\n    /**/\n\t\tmodule.build(\n      /**/\n    )\n}\n\nbuild()\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6700\u7ec8\u4f1a\u627e\u5230 doBuild \u65b9\u6cd5\uff0c\u5f00\u59cb\u5bf9\u6a21\u5757\u8fdb\u884c loader \u7684\u5904\u7406\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'doBuild(options, compilation, resolver, fs, callback) {\n  const loaderContext = this.createLoaderContext(\n    resolver,\n    options,\n    compilation,\n    fs\n  );\n\n  runLoaders(\n    {\n      resource: this.resource,\n      loaders: this.loaders,\n      context: loaderContext,\n      readResource: fs.readFile.bind(fs)\n    },\n    (err, result) => {\n      /* ... */\n      this._source = this.createSource(\n        this.binary ? asBuffer(source) : asString(source),\n        resourceBuffer,\n        sourceMap\n      );\n      this._sourceSize = null;\n      this._ast =\n        typeof extraInfo === "object" &&\n        extraInfo !== null &&\n        extraInfo.webpackAST !== undefined\n          ? extraInfo.webpackAST\n          : null;\n      return callback();\n    }\n  );\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"loader \u5904\u7406\u5b8c\u540e\uff0c\u6267\u884c doBuild \u7684\u56de\u8c03\u3002\u8c03\u7528 this.parser.parse \u5bf9 module \u8fdb\u884c ast \u7684\u8f6c\u8bd1\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"this.doBuild(options, compilation, resolver, fs, err => {\n    /* ... */\n    try {\n        const result = this.parser.parse(\n            this._ast || this._source.source(),\n            {\n                current: this,\n                module: this,\n                compilation: compilation,\n                options: options\n            },\n            (err, result) => {\n                if (err) {\n                    handleParseError(err);\n                } else {\n                    handleParseResult(result);\n                }\n            }\n        );\n        if (result !== undefined) {\n            // parse is sync\n            handleParseResult(result);\n        }\n    } catch (e) {\n        handleParseError(e);\n    }\n})\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528 acorn \u5305\u8fdb\u884c ast \u5904\u7406"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'parse(source, initialState) {\n    let ast;\n    let comments;\n    if (typeof source === "object" && source !== null) {\n        ast = source;\n        comments = source.comments;\n    } else {\n        comments = [];\n        ast = Parser.parse(source, {\n            sourceType: this.sourceType,\n            onComment: comments\n        });\n    }\n\n    const oldScope = this.scope;\n    const oldState = this.state;\n    const oldComments = this.comments;\n    this.scope = {\n        topLevelScope: true,\n        inTry: false,\n        inShorthand: false,\n        isStrict: false,\n        isAsmJs: false,\n        definitions: new StackedSetMap(),\n        renames: new StackedSetMap()\n    };\n    const state = (this.state = initialState || {});\n    this.comments = comments;\n    if (this.hooks.program.call(ast, comments) === undefined) {\n        // \u4fbf\u5229 ast, \u6536\u96c6 Statements \u4e0a\u7684\u58f0\u660e\uff0c\u53d8\u91cf\u7b49\n        this.detectMode(ast.body);\n        this.prewalkStatements(ast.body);\n        this.blockPrewalkStatements(ast.body);\n        this.walkStatements(ast.body);\n    }\n    this.scope = oldScope;\n    this.state = oldState;\n    this.comments = oldComments;\n    return state;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\uff0c\u5e76\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u901a\u8fc7 program \u94a9\u5b50\u6536\u96c6 module \u7684\u4f9d\u8d56\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'parser.hooks.program.tap("HarmonyDetectionParserPlugin", ast => {\n    const isStrictHarmony = parser.state.module.type === "javascript/esm";\n    const isHarmony =\n        isStrictHarmony ||\n        ast.body.some(\n            statement =>\n                statement.type === "ImportDeclaration" ||\n                statement.type === "ExportDefaultDeclaration" ||\n                statement.type === "ExportNamedDeclaration" ||\n                statement.type === "ExportAllDeclaration"\n        );\n    if (isHarmony) {\n        const module = parser.state.module;\n        const compatDep = new HarmonyCompatibilityDependency(module);\n        compatDep.loc = {\n            start: {\n                line: -1,\n                column: 0\n            },\n            end: {\n                line: -1,\n                column: 0\n            },\n            index: -3\n        };\n        module.addDependency(compatDep);\n        const initDep = new HarmonyInitDependency(module);\n        initDep.loc = {\n            start: {\n                line: -1,\n                column: 0\n            },\n            end: {\n                line: -1,\n                column: 0\n            },\n            index: -2\n        };\n        module.addDependency(initDep);\n        parser.state.harmonyParserScope = parser.state.harmonyParserScope || {};\n        parser.scope.isStrict = true;\n        module.buildMeta.exportsType = "namespace";\n        module.buildInfo.strict = true;\n        module.buildInfo.exportsArgument = "__webpack_exports__";\n        if (isStrictHarmony) {\n            module.buildMeta.strictHarmonyModule = true;\n            module.buildInfo.moduleArgument = "__webpack_module__";\n        }\n    }\n});\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\u5c31\u662f\u6536\u96c6\u6211\u4eec\u7684\u6807\u8bc6\u7b26\uff0c\u5728\u540e\u7eed\u7684 ",(0,t.jsx)(n.code,{children:"tree shaking"})," \u4e2d\u4f7f\u7528\uff0c\u6682\u65f6\u4e0d\u8bf4\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6267\u884c ",(0,t.jsx)(n.code,{children:"handleParseResult"})," \u65b9\u6cd5\uff0c\u8bbe\u7f6e ",(0,t.jsx)(n.code,{children:"module"})," \u7684 ",(0,t.jsx)(n.code,{children:"_buildHash"}),"\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'const handleParseResult = result => {\n    this._lastSuccessfulBuildMeta = this.buildMeta;\n    this._initBuildHash(compilation);\n    return callback();\n};\n\n_initBuildHash(compilation) {\n    const hash = createHash(compilation.outputOptions.hashFunction);\n    if (this._source) {\n        hash.update("source");\n        this._source.updateHash(hash);\n    }\n    hash.update("meta");\n    hash.update(JSON.stringify(this.buildMeta));\n    this._buildHash = /** @type {string} */ (hash.digest("hex"));\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u56de\u5230 build \u7684\u56de\u8c03\u4e2d,\u8fdb\u884c\u4e00\u4e9b\u9519\u8bef\u7684\u5904\u7406\uff0c\u5bf9 dependencies \u8fdb\u884c\u6392\u5e8f\uff0c\u6700\u7ec8\u6267\u884c this.hooks.succeedModule.call(module); \u94a9\u5b50\uff0c\u6807\u5fd7\u7740\u5f53\u524d module build \u7684\u5b8c\u6210\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'module.build(\n    this.options,\n    this,\n    this.resolverFactory.get("normal", module.resolveOptions),\n    this.inputFileSystem,\n    error => {\n        const errors = module.errors;\n        for (let indexError = 0; indexError < errors.length; indexError++) {\n            const err = errors[indexError];\n            err.origin = origin;\n            err.dependencies = dependencies;\n            if (optional) {\n                this.warnings.push(err);\n            } else {\n                this.errors.push(err);\n            }\n        }\n\n        const warnings = module.warnings;\n        for (\n            let indexWarning = 0;\n            indexWarning < warnings.length;\n            indexWarning++\n        ) {\n            const war = warnings[indexWarning];\n            war.origin = origin;\n            war.dependencies = dependencies;\n            this.warnings.push(war);\n        }\n        const originalMap = module.dependencies.reduce((map, v, i) => {\n            map.set(v, i);\n            return map;\n        }, new Map());\n        module.dependencies.sort((a, b) => {\n            const cmp = compareLocations(a.loc, b.loc);\n            if (cmp) return cmp;\n            return originalMap.get(a) - originalMap.get(b);\n        });\n        if (error) {\n            this.hooks.failedModule.call(module, error);\n            return callback(error);\n        }\n        this.hooks.succeedModule.call(module);\n        return callback();\n    }\n);\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u6267\u884c buildModule \u56de\u8c03\uff0c\u8c03\u7528 afterBuild \u65b9\u6cd5\uff0c\u5f00\u59cb\u6839\u636e\u6536\u96c6\u5230\u7684 dependencies \u8fdb\u884c\u904d\u5386\u6a21\u5757\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"const afterBuild = () => {\n    /* ... */\n    this.processModuleDependencies(module, err => {\n        if (err) return callback(err);\n        callback(null, module);\n    });\n};\n\nprocessModuleDependencies(module, callback) {\n    const dependencies = new Map();\n\n    const addDependency = dep => {\n        const resourceIdent = dep.getResourceIdentifier();\n        if (resourceIdent) {\n            const factory = this.dependencyFactories.get(dep.constructor);\n            if (factory === undefined) {\n                throw new Error(\n                    `No module factory available for dependency type: ${dep.constructor.name}`\n                );\n            }\n            let innerMap = dependencies.get(factory);\n            if (innerMap === undefined) {\n                dependencies.set(factory, (innerMap = new Map()));\n            }\n            let list = innerMap.get(resourceIdent);\n            if (list === undefined) innerMap.set(resourceIdent, (list = []));\n            list.push(dep);\n        }\n    };\n\n    const addDependenciesBlock = block => {\n        if (block.dependencies) { // \u666e\u901a\u6a21\u5757\n            iterationOfArrayCallback(block.dependencies, addDependency);\n        }\n        if (block.blocks) { // \u5f02\u6b65\u6a21\u5757\n            iterationOfArrayCallback(block.blocks, addDependenciesBlock);\n        }\n        if (block.variables) {\n            iterationBlockVariable(block.variables, addDependency);\n        }\n    };\n\n    try {\n        addDependenciesBlock(module);\n    } catch (e) {\n        callback(e);\n    }\n\n    const sortedDependencies = [];\n\n    for (const pair1 of dependencies) {\n        for (const pair2 of pair1[1]) {\n            sortedDependencies.push({\n                factory: pair1[0],\n                dependencies: pair2[1]\n            });\n        }\n    }\n\n    this.addModuleDependencies(\n        module,\n        sortedDependencies,\n        this.bail,\n        null,\n        true,\n        callback\n    );\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6700\u7ec8\u4f1a\u5f97\u5230\u4e00\u4e2a sortedDependencies \uff0c\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"{\n    factory: NormalModuleFactory, // \u4f9d\u8d56\u6a21\u5757\u7c7b\u578b\n    dependencies: [HarmonyImportSideEffectDependency, HarmonyImportSpecifierDependency], // Map\n},\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6267\u884c addModuleDependencies \u65b9\u6cd5\uff0c\u6839\u636e sortedDependencies \u8fdb\u884c\u904d\u5386\u3002\u901a\u8fc7 factory.create \u5f00\u59cb\u6267\u884c\u65b0\u7684 module build \u8fc7\u7a0b\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"addModuleDependencies(\n    module,\n    dependencies,\n    bail,\n    cacheGroup,\n    recursive,\n    callback\n) {\n    const start = this.profile && Date.now();\n    const currentProfile = this.profile && {};\n\n    asyncLib.forEach(\n        dependencies,\n        (item, callback) => {\n            const dependencies = item.dependencies;\n            /* ... */\n            const semaphore = this.semaphore;\n            semaphore.acquire(() => {\n                const factory = item.factory;\n                factory.create(\n                    {\n                        contextInfo: {\n                            issuer: module.nameForCondition && module.nameForCondition(),\n                            compiler: this.compiler.name\n                        },\n                        resolveOptions: module.resolveOptions,\n                        context: module.context,\n                        dependencies: dependencies\n                    },\n                    (err, dependentModule) => {\n                        /* ... */\n                        if (addModuleResult.build) {\n                            this.buildModule(\n                                dependentModule,\n                                isOptional(),\n                                module,\n                                dependencies,\n                                err => {\n                                    if (err) {\n                                        semaphore.release();\n                                        return errorOrWarningAndCallback(err);\n                                    }\n\n                                    if (currentProfile) {\n                                        const afterBuilding = Date.now();\n                                        currentProfile.building = afterBuilding - afterFactory;\n                                    }\n\n                                    semaphore.release();\n                                    afterBuild();\n                                }\n                            );\n                        } else {\n                            semaphore.release();\n                            this.waitForBuildingFinished(dependentModule, afterBuild);\n                        }\n                    }\n                );\n            });\n        },\n        err => {\n            // In V8, the Error objects keep a reference to the functions on the stack. These warnings &\n            // errors are created inside closures that keep a reference to the Compilation, so errors are\n            // leaking the Compilation object.\n\n            if (err) {\n                // eslint-disable-next-line no-self-assign\n                err.stack = err.stack;\n                return callback(err);\n            }\n\n            return process.nextTick(callback);\n        }\n    );\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5728\u6240\u6709\u7684\u4f9d\u8d56\u6267\u884c\u540e\uff0c\u4f1a\u6267\u884c\u56de\u8c03\u751f\u6210\u5165\u53e3 module \u4fe1\u606f\n\u8fd9\u91cc\u6807\u5fd7\u7740 addEntry \u7684\u7ed3\u675f"}),"\n",(0,t.jsx)(n.h2,{id:"chunk-\u751f\u6210",children:"chunk \u751f\u6210"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(5250).A+"",width:"590",height:"3174"})})]})}function u(e={}){const{wrapper:n}={...(0,s.RP)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},5680:(e,n,r)=>{r.d(n,{RP:()=>i});var t=r(6540);function s(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function a(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){s(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,t,s=function(e,n){if(null==e)return{};var r,t,s={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||(s[r]=e[r]);return s}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}var c=t.createContext({}),i=function(e){var n=t.useContext(c),r=n;return e&&(r="function"==typeof e?e(n):a(a({},n),e)),r},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var r=e.components,s=e.mdxType,o=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=i(r),h=s,m=p["".concat(c,".").concat(h)]||p[h]||d[h]||o;return r?t.createElement(m,a(a({ref:n},u),{},{components:r})):t.createElement(m,a({ref:n},u))}));u.displayName="MDXCreateElement"},893:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/module-class-d697cd83b898a45037bcedff36a6876f.png"},5250:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/module-38c92cd80ec7b60f0248fd2b4b976e6e.png"}}]);