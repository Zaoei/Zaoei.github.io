"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[981],{5822:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>d,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var i=t(4848),r=t(5680);const s={},c="Watch",o={id:"webpack-resolve/hmr-watch",title:"Watch",description:"\u542f\u7528 Watch \u6a21\u5f0f\u3002\u8fd9\u610f\u5473\u7740\u5728\u521d\u59cb\u6784\u5efa\u4e4b\u540e\uff0cwebpack \u5c06\u7ee7\u7eed\u76d1\u542c\u4efb\u4f55\u5df2\u89e3\u6790\u6587\u4ef6\u7684\u66f4\u6539\u3002Watch \u6a21\u5f0f\u9ed8\u8ba4\u5173\u95ed\u3002",source:"@site/docs/webpack-resolve/hmr-watch.md",sourceDirName:"webpack-resolve",slug:"/webpack-resolve/hmr-watch",permalink:"/docs/webpack-resolve/hmr-watch",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"cli",permalink:"/docs/webpack-resolve/cli"},next:{title:"\u6a21\u5757\u70ed\u66ff\u6362",permalink:"/docs/webpack-resolve/hmr"}},a={},l=[];function h(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.RP)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"watch",children:"Watch"}),"\n",(0,i.jsx)(n.p,{children:"\u542f\u7528 Watch \u6a21\u5f0f\u3002\u8fd9\u610f\u5473\u7740\u5728\u521d\u59cb\u6784\u5efa\u4e4b\u540e\uff0cwebpack \u5c06\u7ee7\u7eed\u76d1\u542c\u4efb\u4f55\u5df2\u89e3\u6790\u6587\u4ef6\u7684\u66f4\u6539\u3002Watch \u6a21\u5f0f\u9ed8\u8ba4\u5173\u95ed\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"watch: true\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"webpack-dev-server"})," \u548c ",(0,i.jsx)(n.strong,{children:"webpack-dev-middleware"})," \u91cc Watch \u6a21\u5f0f\u9ed8\u8ba4\u5f00\u542f\u3002",(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.a,{href:"https://www.webpackjs.com/configuration/watch/",children:"watch \u548c watchOptions | webpack \u4e2d\u6587\u7f51"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(4181).A+"",width:"687",height:"991"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(9670).A+"",width:"687",height:"1121"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(1115).A+"",width:"808",height:"1001"})}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u4e00\u5f00\u59cb\u7684\u521b\u5efa compiler \u5bf9\u8c61\u6dfb\u52a0\u6587\u4ef6\u7684\u5904\u7406\u65b9\u6cd5\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'// webpack.js\nconst webpack = (options, callback) => {\n\t// ...\n\tnew NodeEnvironmentPlugin({2\n\t\tinfrastructureLogging: options.infrastructureLogging\n\t}).apply(compiler);\n    // ...\n}\n\n\n// /node/NodeEnvironmentPlugin.js\nclass NodeEnvironmentPlugin {\n\t  apply(compiler) {\n\t\t  // ...\n        compiler.inputFileSystem = new CachedInputFileSystem(\n            new NodeJsInputFileSystem(),\n            60000\n        );\n        const inputFileSystem = compiler.inputFileSystem;\n        compiler.outputFileSystem = new NodeOutputFileSystem();\n        compiler.watchFileSystem = new NodeWatchFileSystem(\n            compiler.inputFileSystem\n        ); // \u751f\u6210\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u6ca1\u6709\u7ed1\u5b9a\u4efb\u4f55\u4e8b\u4ef6\n        compiler.hooks.beforeRun.tap("NodeEnvironmentPlugin", compiler => {\n            if (compiler.inputFileSystem === inputFileSystem) inputFileSystem.purge();\n        });\n    }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u666e\u901a\u6a21\u5f0f\u4e0b\u6267\u884c ",(0,i.jsx)(n.code,{children:"compiler.run"})," \u65b9\u6cd5\u3002\u5728\u5f00\u542f\u4e86",(0,i.jsx)(n.code,{children:"watch"})," \u6a21\u5f0f\u540e\uff0c\u6267\u884c ",(0,i.jsx)(n.code,{children:"compiler.watch"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"watch(watchOptions, handler) {\n\t  // ...\n\t  return new Watching(this, watchOptions, handler);\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u521d\u59cb\u5316",(0,i.jsx)(n.code,{children:"new Watching"}),"\uff0c\u5185\u90e8\u6700\u7ec8\u6267\u884c\u5230 ",(0,i.jsx)(n.code,{children:"this._go()"}),"\uff0c\u5185\u90e8\u4e0e ",(0,i.jsx)(n.code,{children:"compiler.run"})," \u6709\u4e9b\u7c7b\u4f3c\uff0c\u6700\u7ec8\u4f1a\u6267\u884c ",(0,i.jsx)(n.code,{children:"this._done(null, compilation)"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"class Watching {\n  constructor(compiler, watchOptions, handler) {\n    // ...\n    this.compiler.readRecords((err) => {\n      if (err) return this._done(err);\n\n      this._go();\n    });\n  }\n\n  _go() {\n    this.startTime = Date.now();\n    this.running = true;\n    this.invalid = false;\n    this.compiler.hooks.watchRun.callAsync(this.compiler, (err) => {\n      if (err) return this._done(err);\n      const onCompiled = (err, compilation) => {\n        if (err) return this._done(err);\n        if (this.invalid) return this._done();\n\n        if (this.compiler.hooks.shouldEmit.call(compilation) === false) {\n          return this._done(null, compilation);\n        }\n\n        this.compiler.emitAssets(compilation, (err) => {\n          if (err) return this._done(err);\n          if (this.invalid) return this._done();\n          this.compiler.emitRecords((err) => {\n            if (err) return this._done(err);\n\n            if (compilation.hooks.needAdditionalPass.call()) {\n              compilation.needAdditionalPass = true;\n\n              const stats = new Stats(compilation);\n              stats.startTime = this.startTime;\n              stats.endTime = Date.now();\n              this.compiler.hooks.done.callAsync(stats, (err) => {\n                if (err) return this._done(err);\n\n                this.compiler.hooks.additionalPass.callAsync((err) => {\n                  if (err) return this._done(err);\n                  this.compiler.compile(onCompiled);\n                });\n              });\n              return;\n            }\n            return this._done(null, compilation);\n          });\n        });\n      };\n      this.compiler.compile(onCompiled);\n    });\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728 ",(0,i.jsx)(n.code,{children:"this._done"}),"\u4e2d\uff0c\u89e6\u53d1\u4e86 hooks.done \u3002\u5728\u6784\u5efa\u5b8c\u6210\u4e4b\u540e\u6267\u884c ",(0,i.jsx)(n.code,{children:"this.watch"})," \u4e3a\u6587\u4ef6\u6dfb\u52a0\u76d1\u542c\u5668\u3002\u4f20\u5165",(0,i.jsx)(n.code,{children:"fileDependencies"}),",",(0,i.jsx)(n.code,{children:"contextDependencies"}),",",(0,i.jsx)(n.code,{children:"missingDependencies"}),"\u8fd9 3 \u4e2a\u53c2\u6570\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"    _done(err, compilation) {\n        this.running = false;\n        if (this.invalid) return this._go();\n\n        const stats = compilation ? this._getStats(compilation) : null;\n        if (err) {\n            this.compiler.hooks.failed.call(err);\n            this.handler(err, stats);\n            return;\n        }\n        this.compiler.hooks.done.callAsync(stats, () => {\n            this.handler(null, stats);\n            if (!this.closed) {\n                this.watch(\n                    Array.from(compilation.fileDependencies),\n                    Array.from(compilation.contextDependencies),\n                    Array.from(compilation.missingDependencies)\n                );\n            }\n            for (const cb of this.callbacks) cb();\n            this.callbacks.length = 0;\n        });\n    }\n\n    watch(files, dirs, missing) {\n        this.pausedWatcher = null;\n        this.watcher = this.compiler.watchFileSystem.watch(\n            files,\n            dirs,\n            missing,\n            this.startTime,\n            this.watchOptions,\n            (\n                err,\n                filesModified,\n                contextModified,\n                missingModified,\n                fileTimestamps,\n                contextTimestamps,\n                removedFiles\n            ) => {\n                this.pausedWatcher = this.watcher;\n                this.watcher = null;\n                if (err) {\n                    return this.handler(err);\n                }\n                this.compiler.fileTimestamps = fileTimestamps;\n                this.compiler.contextTimestamps = contextTimestamps;\n                this.compiler.removedFiles = removedFiles;\n                if (!this.suspended) {\n                    this._invalidate();\n                }\n            },\n            (fileName, changeTime) => {\n                this.compiler.hooks.invalid.call(fileName, changeTime);\n            }\n        );\n    }\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Watcher \u7ee7\u627f\u81f3 node \u7684 EventEmitter\uff0c\u53ef\u4ee5\u8fdb\u884c\u4e8b\u4ef6\u7684\u7ed1\u5b9a\u76d1\u542c\u3002\u7ed1\u5b9a\u4e86 ",(0,i.jsx)(n.code,{children:"change"}),"\uff0c ",(0,i.jsx)(n.code,{children:"aggregated"}),"\u4e8b\u4ef6\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"this.watcher.once('change', callbackUndelayed);\nthis.watcher.once('aggregated', (changes, removals) => {\n  changes = changes.concat(removals);\n  if (this.inputFileSystem && this.inputFileSystem.purge) {\n    this.inputFileSystem.purge(changes);\n  }\n  const times = objectToMap(this.watcher.getTimes());\n  files = new Set(files);\n  dirs = new Set(dirs);\n  missing = new Set(missing);\n  removals = new Set(removals.filter((file) => files.has(file)));\n  callback(\n    null,\n    changes.filter((file) => files.has(file)).sort(),\n    changes.filter((file) => dirs.has(file)).sort(),\n    changes.filter((file) => missing.has(file)).sort(),\n    times,\n    times,\n    removals\n  );\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"fileWatcher \u4f7f\u7528 chokidar \u8fdb\u884c\u76d1\u542c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"var chokidar = require('./chokidar');\n\nthis.watcher = chokidar.watch(directoryPath, {\n  ignoreInitial: true,\n  persistent: true,\n  followSymlinks: false,\n  depth: 0,\n  atomic: false,\n  alwaysStat: true,\n  ignorePermissionErrors: true,\n  ignored: options.ignored,\n  usePolling: options.poll ? true : undefined,\n  interval: interval,\n  binaryInterval: interval,\n  disableGlobbing: true\n});\nthis.watcher.on('add', this.onFileAdded.bind(this));\nthis.watcher.on('addDir', this.onDirectoryAdded.bind(this));\nthis.watcher.on('change', this.onChange.bind(this));\nthis.watcher.on('unlink', this.onFileUnlinked.bind(this));\nthis.watcher.on('unlinkDir', this.onDirectoryUnlinked.bind(this));\nthis.watcher.on('error', this.onWatcherError.bind(this));\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5728 done.hooks \u4e2d\u4e3a\u6bcf\u4e2a\u6587\u4ef6\u589e\u52a0\u4e00\u4e2a\u76d1\u542c\u5668\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(5881).A+"",width:"821",height:"451"})}),"\n",(0,i.jsx)(n.p,{children:"#webpack"})]})}function d(e={}){const{wrapper:n}={...(0,r.RP)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},5680:(e,n,t)=>{t.d(n,{RP:()=>l});var i=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)t=s[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)t=s[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var a=i.createContext({}),l=function(e){var n=i.useContext(a),t=n;return e&&(t="function"==typeof e?e(n):c(c({},n),e)),t},h={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,a=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),p=l(t),m=r,u=p["".concat(a,".").concat(m)]||p[m]||h[m]||s;return t?i.createElement(u,c(c({ref:n},d),{},{components:t})):i.createElement(u,c({ref:n},d))}));d.displayName="MDXCreateElement"},4181:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/build_flow-f3b4a434a0e69e81263f83be904d4583.png"},1115:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/change_watch_flow-8c9f4c3860b5202368b463e8d354314a.png"},5881:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/watch-c675f11c44309514b1a02b93b23403de.png"},9670:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/watch_flow-e0ebf8ed77cca9c5eaec40243631851c.png"}}]);