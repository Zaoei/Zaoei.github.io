<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-webpack-resolve/module" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">webpack modules | Zaoei Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://blog.palashsh.me/docs/webpack-resolve/module"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:card" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:site" content="@battleofplassey"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="webpack modules | Zaoei Blog"><meta data-rh="true" name="description" content="模块的类型"><meta data-rh="true" property="og:description" content="模块的类型"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.palashsh.me/docs/webpack-resolve/module"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/webpack-resolve/module" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/webpack-resolve/module" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2KDKKFPT4A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Zaoei Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Zaoei Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Zaoei Blog JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5V7R63B0J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R5V7R63B0J",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Zaoei Blog" href="/opensearch.xml">
<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><link rel="stylesheet" href="/assets/css/styles.09761036.css">
<script src="/assets/js/runtime~main.d0e4631e.js" defer="defer"></script>
<script src="/assets/js/main.46e122de.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="blog" href="/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="doc" doclink="docs/webpack-resolve/README.md" href="/docs/webpack-resolve/">docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Zaoei" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" externallink="https://github.com/Zaoei" link="external" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/algorithm">algorithm</a><button aria-label="Expand sidebar category &#x27;algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/micfrontend">micfrontend</a><button aria-label="Expand sidebar category &#x27;micfrontend&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/operating-system">operating system</a><button aria-label="Expand sidebar category &#x27;operating system&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/single sign on/CAS">single sign on</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-optimize">webpack-optimize</a><button aria-label="Expand sidebar category &#x27;webpack-optimize&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/webpack-resolve">webpack-resolve</a><button aria-label="Collapse sidebar category &#x27;webpack-resolve&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/Chunk">chunk</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/Plugin">webpack-plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/">README</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/cli">cli</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/hmr-watch">Watch</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/hmr">模块热替换</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/initCompiler">initCompiler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-resolve/loader">loader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/webpack-resolve/module">webpack modules</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/whoami">whoami</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/webpack-resolve"><span itemprop="name">webpack-resolve</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">webpack modules</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="webpack-modules">webpack modules</h1>
<h2 id="模块的类型">模块的类型</h2>
<ul>
<li>NormalModule: 普通模块，我们的入口模块，loader</li>
<li>ContextModule: [&#x27;./a.js&#x27;, &#x27;./b.js&#x27;], 尚未确定干嘛用的</li>
<li>ExternalModule: 外部模块 module.exports = jQuery</li>
<li>DelegatedModule: 委托模块，在开启 DLLPlugin 的时候，会生成 manifest 文件，这个 manifest 就是委托模块</li>
<li>RawModule: 原始模块</li>
<li>RuntimeModule: 运行时模块</li>
</ul>
<p>模块的分类，不同的模块使用不同的类。
<img src="/assets/images/module-class-d697cd83b898a45037bcedff36a6876f.png" width="2742" height="978"></p>
<h2 id="执行过程">执行过程</h2>
<p>webpack 执行 Complier.run(), 最终执行 compile 方法，开始创建 compilation 对象。</p>
<pre><code class="language-js">// lib/Compiler.js 419
const run = () =&gt; {
    this.hooks.beforeRun.callAsync(this, (err) =&gt; {
        if (err) return finalCallback(err);

        this.hooks.run.callAsync(this, (err) =&gt; {
            if (err) return finalCallback(err);

            this.readRecords((err) =&gt; {
                if (err) return finalCallback(err);

                this.compile(onCompiled);
            });
        });
    });
};
</code></pre>
<p>创建 compilation 对象，并且执行 make 钩子，进行编译。</p>
<pre><code class="language-js">// lib/Compiler.js 1092
compile(callback) {
    const params = this.newCompilationParams();
    this.hooks.beforeCompile.callAsync(params, err =&gt; {
        /* ... */
        this.hooks.compile.call(params);

        const compilation = this.newCompilation(params);

        this.hooks.make.callAsync(compilation, err =&gt; {
          /* ... */
        });
    });
}
</code></pre>
<p>在 EntryPlugin 插件中注册 make 钩子，执行 compilation.addEntry 方法。</p>
<pre><code class="language-js">// lib/EntryPlugin.js 48
compiler.hooks.make.tapAsync(&#x27;EntryPlugin&#x27;, (compilation, callback) =&gt; {
    compilation.addEntry(context, dep, options, (err) =&gt; {
        callback(err);
    });
});
</code></pre>
<p>执行 addEntry 的 hooks。可以做 ProgressPlugin 插件的逻辑，用来控制进度条等。</p>
<pre><code class="language-js">// lib/Compilation.js 2174
this.hooks.addEntry.call(entry, options);
</code></pre>
<p>调用 <code>moduleFactory.create</code>，创建 module</p>
<pre><code class="language-js">// lib/Compilation.js 1968
factory.create(/* ... */);
</code></pre>
<p>一开始会先判断一下这个模块有没有被构建过，或者在缓存中是否有。</p>
<pre><code class="language-js">const dependencies = data.dependencies;
const cacheEntry = dependencyCache.get(dependencies[0]);
if (cacheEntry) return callback(null, cacheEntry);
</code></pre>
<p>查看当前模块是否有 resolveOptions 配置（从这里开始进入解析）</p>
<p>什么是 resolveoptions ， <a href="https://webpack.js.org/configuration/resolve/">Resolve | webpack</a></p>
<pre><code class="language-javascript">const path = require(&#x27;path&#x27;);

module.exports = {
    //...
    resolve: {
        alias: {
            Utilities: path.resolve(__dirname, &#x27;src/utilities/&#x27;),
            Templates: path.resolve(__dirname, &#x27;src/templates/&#x27;)
        }, // 别名
        extensions: [&#x27;.js&#x27;, &#x27;.json&#x27;, &#x27;.wasm&#x27;] // 忽略文件后缀
    }
};
</code></pre>
<p>执行 beforeResolve 钩子, 在回调中触发 factory、resolver 钩子，使用<code>asyncLib.parallel</code>，同时调用 loader 解析器和模块解析器，最终返回一个数组
，索引 0 为行内 lodaer 的路径结果，索引 1 为模块的路径结果。</p>
<pre><code class="language-js">// lib/NormalModuleFactory.js 395 v4
const factory = this.hooks.factory.call(null);

// lib/NormalModuleFactory.js 123 v4
this.hooks.factory.tap(&#x27;NormalModuleFactory&#x27;, () =&gt; (result, callback) =&gt; {
    let resolver = this.hooks.resolver.call(null);

    // Ignored
    if (!resolver) return callback();

    resolver(result, (err, data) =&gt; {
        if (err) return callback(err);

        // Ignored
        if (!data) return callback();

        // direct module
        if (typeof data.source === &#x27;function&#x27;) return callback(null, data);

        this.hooks.afterResolve.callAsync(data, (err, result) =&gt; {
            if (err) return callback(err);

            // Ignored
            if (!result) return callback();

            let createdModule = this.hooks.createModule.call(result);
            if (!createdModule) {
                if (!result.request) {
                    return callback(new Error(&#x27;Empty dependency (no request)&#x27;));
                }

                createdModule = new NormalModule(result);
            }

            createdModule = this.hooks.module.call(createdModule, result);

            return callback(null, createdModule);
        });
    });
});
this.hooks.resolver.tap(&#x27;NormalModuleFactory&#x27;, () =&gt; (data, callback) =&gt; {
    const contextInfo = data.contextInfo;
    const context = data.context;
    const request = data.request;

    const loaderResolver = this.getResolver(&#x27;loader&#x27;); // 获取 loader 路径的解析器
    const normalResolver = this.getResolver(&#x27;normal&#x27;, data.resolveOptions); // 获取模块路径的解析器

    let matchResource = undefined;
    let requestWithoutMatchResource = request;
    const matchResourceMatch = MATCH_RESOURCE_REGEX.exec(request);
    if (matchResourceMatch) {
        matchResource = matchResourceMatch[1];
        if (/^\.\.?\//.test(matchResource)) {
            matchResource = path.join(context, matchResource);
        }
        requestWithoutMatchResource = request.substr(
            matchResourceMatch[0].length
        );
    }

    const noPreAutoLoaders = requestWithoutMatchResource.startsWith(&#x27;-!&#x27;);
    const noAutoLoaders =
        noPreAutoLoaders || requestWithoutMatchResource.startsWith(&#x27;!&#x27;);
    const noPrePostAutoLoaders = requestWithoutMatchResource.startsWith(&#x27;!!&#x27;);
    let elements = requestWithoutMatchResource
        .replace(/^-?!+/, &#x27;&#x27;)
        .replace(/!!+/g, &#x27;!&#x27;)
        .split(&#x27;!&#x27;);
    let resource = elements.pop();
    elements = elements.map(identToLoaderRequest);

    asyncLib.parallel(
        [
            (callback) =&gt;
                this.resolveRequestArray(
                    contextInfo,
                    context,
                    elements,
                    loaderResolver,
                    callback
                ),
            (callback) =&gt; {
                if (resource === &#x27;&#x27; || resource[0] === &#x27;?&#x27;) {
                    return callback(null, {
                        resource
                    });
                }

                normalResolver.resolve(
                    contextInfo,
                    context,
                    resource,
                    {},
                    (err, resource, resourceResolveData) =&gt; {
                        if (err) return callback(err);
                        callback(null, {
                            resourceResolveData,
                            resource
                        });
                    }
                );
            }
        ],
        (err, results) =&gt; {
            if (err) return callback(err);
            let loaders = results[0]; // 行内 loaders 的结果
            const resourceResolveData = results[1].resourceResolveData;
            resource = results[1].resource; // 模块的路径结果

            // translate option idents
            try {
                for (const item of loaders) {
                    if (
                        typeof item.options === &#x27;string&#x27; &amp;&amp;
                        item.options[0] === &#x27;?&#x27;
                    ) {
                        const ident = item.options.substr(1);
                        item.options = this.ruleSet.findOptionsByIdent(ident);
                        item.ident = ident;
                    }
                }
            } catch (e) {
                return callback(e);
            }

            if (resource === false) {
                // ignored
                return callback(
                    null,
                    new RawModule(
                        &#x27;/* (ignored) */&#x27;,
                        `ignored ${context} ${request}`,
                        `${request} (ignored)`
                    )
                );
            }

            const userRequest =
                (matchResource !== undefined ? `${matchResource}!=!` : &#x27;&#x27;) +
                loaders.map(loaderToIdent).concat([resource]).join(&#x27;!&#x27;);

            let resourcePath =
                matchResource !== undefined ? matchResource : resource;
            let resourceQuery = &#x27;&#x27;;
            const queryIndex = resourcePath.indexOf(&#x27;?&#x27;);
            if (queryIndex &gt;= 0) {
                resourceQuery = resourcePath.substr(queryIndex);
                resourcePath = resourcePath.substr(0, queryIndex);
            }

            const result = this.ruleSet.exec({
                resource: resourcePath,
                realResource:
                    matchResource !== undefined
                        ? resource.replace(/\?.*/, &#x27;&#x27;)
                        : resourcePath,
                resourceQuery,
                issuer: contextInfo.issuer,
                compiler: contextInfo.compiler
            });
            const settings = {};
            const useLoadersPost = [];
            const useLoaders = [];
            const useLoadersPre = [];
            for (const r of result) {
                if (r.type === &#x27;use&#x27;) {
                    // 处理前置loader，后置loader，以及普通 loader
                    if (r.enforce === &#x27;post&#x27; &amp;&amp; !noPrePostAutoLoaders) {
                        useLoadersPost.push(r.value);
                    } else if (
                        r.enforce === &#x27;pre&#x27; &amp;&amp;
                        !noPreAutoLoaders &amp;&amp;
                        !noPrePostAutoLoaders
                    ) {
                        useLoadersPre.push(r.value);
                    } else if (
                        !r.enforce &amp;&amp;
                        !noAutoLoaders &amp;&amp;
                        !noPrePostAutoLoaders
                    ) {
                        useLoaders.push(r.value);
                    }
                } else if (
                    typeof r.value === &#x27;object&#x27; &amp;&amp;
                    r.value !== null &amp;&amp;
                    typeof settings[r.type] === &#x27;object&#x27; &amp;&amp;
                    settings[r.type] !== null
                ) {
                    settings[r.type] = cachedCleverMerge(
                        settings[r.type],
                        r.value
                    );
                } else {
                    settings[r.type] = r.value;
                }
            }
            asyncLib.parallel(
                [
                    this.resolveRequestArray.bind(
                        this,
                        contextInfo,
                        this.context,
                        useLoadersPost,
                        loaderResolver
                    ),
                    this.resolveRequestArray.bind(
                        this,
                        contextInfo,
                        this.context,
                        useLoaders,
                        loaderResolver
                    ),
                    this.resolveRequestArray.bind(
                        this,
                        contextInfo,
                        this.context,
                        useLoadersPre,
                        loaderResolver
                    )
                ],
                (err, results) =&gt; {
                    // results[0]: post loader 集合
                    // results[1]: normal loader 集合
                    // results[2]: pre loader 集合
                    // loaders: inline loader 集合
                    if (err) return callback(err);
                    if (matchResource === undefined) {
                        loaders = results[0].concat(
                            loaders,
                            results[1],
                            results[2]
                        );
                    } else {
                        loaders = results[0].concat(
                            results[1],
                            loaders,
                            results[2]
                        );
                    }
                    process.nextTick(() =&gt; {
                        const type = settings.type;
                        const resolveOptions = settings.resolve;
                        callback(null, {
                            context: context,
                            request: loaders
                                .map(loaderToIdent)
                                .concat([resource])
                                .join(&#x27;!&#x27;),
                            dependencies: data.dependencies,
                            userRequest,
                            rawRequest: request,
                            loaders,
                            resource,
                            matchResource,
                            resourceResolveData,
                            settings,
                            type,
                            parser: this.getParser(type, settings.parser),
                            generator: this.getGenerator(
                                type,
                                settings.generator
                            ),
                            resolveOptions
                        });
                    });
                }
            );
        }
    );
});
</code></pre>
<p>触发 afterResolve 钩子，执行回调，通过传入的数据，初始化 NormalModule 对象，到这模块的生成完成了，接下来就要对模块进行 build 处理</p>
<pre><code class="language-js">// result 即为 resolver 返回的组合对象 data
if (!createdModule) {
    if (!result.request) {
        return callback(new Error(&#x27;Empty dependency (no request)&#x27;));
    }

    createdModule = new NormalModule(result);
}
createdModule = this.hooks.module.call(createdModule, result);

return callback(null, createdModule);
</code></pre>
<p>执行 buildModule 方法开始 build 模块</p>
<pre><code class="language-js">//  lib/Compilation.js 1111 v4
this.buildModule(module, false, null, null, err =&gt; {
    /* */
    afterBuild();
});

buildModule(module, optional, origin, dependencies, thisCallback) {
    /**/
		module.build(
      /**/
    )
}

build()
</code></pre>
<p>最终会找到 doBuild 方法，开始对模块进行 loader 的处理。</p>
<pre><code class="language-js">doBuild(options, compilation, resolver, fs, callback) {
  const loaderContext = this.createLoaderContext(
    resolver,
    options,
    compilation,
    fs
  );

  runLoaders(
    {
      resource: this.resource,
      loaders: this.loaders,
      context: loaderContext,
      readResource: fs.readFile.bind(fs)
    },
    (err, result) =&gt; {
      /* ... */
      this._source = this.createSource(
        this.binary ? asBuffer(source) : asString(source),
        resourceBuffer,
        sourceMap
      );
      this._sourceSize = null;
      this._ast =
        typeof extraInfo === &quot;object&quot; &amp;&amp;
        extraInfo !== null &amp;&amp;
        extraInfo.webpackAST !== undefined
          ? extraInfo.webpackAST
          : null;
      return callback();
    }
  );
}
</code></pre>
<p>loader 处理完后，执行 doBuild 的回调。调用 this.parser.parse 对 module 进行 ast 的转译。</p>
<pre><code class="language-js">this.doBuild(options, compilation, resolver, fs, err =&gt; {
    /* ... */
    try {
        const result = this.parser.parse(
            this._ast || this._source.source(),
            {
                current: this,
                module: this,
                compilation: compilation,
                options: options
            },
            (err, result) =&gt; {
                if (err) {
                    handleParseError(err);
                } else {
                    handleParseResult(result);
                }
            }
        );
        if (result !== undefined) {
            // parse is sync
            handleParseResult(result);
        }
    } catch (e) {
        handleParseError(e);
    }
})
</code></pre>
<p>使用 acorn 包进行 ast 处理</p>
<pre><code class="language-js">parse(source, initialState) {
    let ast;
    let comments;
    if (typeof source === &quot;object&quot; &amp;&amp; source !== null) {
        ast = source;
        comments = source.comments;
    } else {
        comments = [];
        ast = Parser.parse(source, {
            sourceType: this.sourceType,
            onComment: comments
        });
    }

    const oldScope = this.scope;
    const oldState = this.state;
    const oldComments = this.comments;
    this.scope = {
        topLevelScope: true,
        inTry: false,
        inShorthand: false,
        isStrict: false,
        isAsmJs: false,
        definitions: new StackedSetMap(),
        renames: new StackedSetMap()
    };
    const state = (this.state = initialState || {});
    this.comments = comments;
    if (this.hooks.program.call(ast, comments) === undefined) {
        // 便利 ast, 收集 Statements 上的声明，变量等
        this.detectMode(ast.body);
        this.prewalkStatements(ast.body);
        this.blockPrewalkStatements(ast.body);
        this.walkStatements(ast.body);
    }
    this.scope = oldScope;
    this.state = oldState;
    this.comments = oldComments;
    return state;
}
</code></pre>
<p>，并在这个过程中通过 program 钩子收集 module 的依赖。</p>
<pre><code class="language-js">parser.hooks.program.tap(&quot;HarmonyDetectionParserPlugin&quot;, ast =&gt; {
    const isStrictHarmony = parser.state.module.type === &quot;javascript/esm&quot;;
    const isHarmony =
        isStrictHarmony ||
        ast.body.some(
            statement =&gt;
                statement.type === &quot;ImportDeclaration&quot; ||
                statement.type === &quot;ExportDefaultDeclaration&quot; ||
                statement.type === &quot;ExportNamedDeclaration&quot; ||
                statement.type === &quot;ExportAllDeclaration&quot;
        );
    if (isHarmony) {
        const module = parser.state.module;
        const compatDep = new HarmonyCompatibilityDependency(module);
        compatDep.loc = {
            start: {
                line: -1,
                column: 0
            },
            end: {
                line: -1,
                column: 0
            },
            index: -3
        };
        module.addDependency(compatDep);
        const initDep = new HarmonyInitDependency(module);
        initDep.loc = {
            start: {
                line: -1,
                column: 0
            },
            end: {
                line: -1,
                column: 0
            },
            index: -2
        };
        module.addDependency(initDep);
        parser.state.harmonyParserScope = parser.state.harmonyParserScope || {};
        parser.scope.isStrict = true;
        module.buildMeta.exportsType = &quot;namespace&quot;;
        module.buildInfo.strict = true;
        module.buildInfo.exportsArgument = &quot;__webpack_exports__&quot;;
        if (isStrictHarmony) {
            module.buildMeta.strictHarmonyModule = true;
            module.buildInfo.moduleArgument = &quot;__webpack_module__&quot;;
        }
    }
});
</code></pre>
<p>接下来就是收集我们的标识符，在后续的 <code>tree shaking</code> 中使用，暂时不说。</p>
<p>执行 <code>handleParseResult</code> 方法，设置 <code>module</code> 的 <code>_buildHash</code>。</p>
<pre><code class="language-js">const handleParseResult = result =&gt; {
    this._lastSuccessfulBuildMeta = this.buildMeta;
    this._initBuildHash(compilation);
    return callback();
};

_initBuildHash(compilation) {
    const hash = createHash(compilation.outputOptions.hashFunction);
    if (this._source) {
        hash.update(&quot;source&quot;);
        this._source.updateHash(hash);
    }
    hash.update(&quot;meta&quot;);
    hash.update(JSON.stringify(this.buildMeta));
    this._buildHash = /** @type {string} */ (hash.digest(&quot;hex&quot;));
}
</code></pre>
<p>回到 build 的回调中,进行一些错误的处理，对 dependencies 进行排序，最终执行 this.hooks.succeedModule.call(module); 钩子，标志着当前 module build 的完成。</p>
<pre><code class="language-js">module.build(
    this.options,
    this,
    this.resolverFactory.get(&quot;normal&quot;, module.resolveOptions),
    this.inputFileSystem,
    error =&gt; {
        const errors = module.errors;
        for (let indexError = 0; indexError &lt; errors.length; indexError++) {
            const err = errors[indexError];
            err.origin = origin;
            err.dependencies = dependencies;
            if (optional) {
                this.warnings.push(err);
            } else {
                this.errors.push(err);
            }
        }

        const warnings = module.warnings;
        for (
            let indexWarning = 0;
            indexWarning &lt; warnings.length;
            indexWarning++
        ) {
            const war = warnings[indexWarning];
            war.origin = origin;
            war.dependencies = dependencies;
            this.warnings.push(war);
        }
        const originalMap = module.dependencies.reduce((map, v, i) =&gt; {
            map.set(v, i);
            return map;
        }, new Map());
        module.dependencies.sort((a, b) =&gt; {
            const cmp = compareLocations(a.loc, b.loc);
            if (cmp) return cmp;
            return originalMap.get(a) - originalMap.get(b);
        });
        if (error) {
            this.hooks.failedModule.call(module, error);
            return callback(error);
        }
        this.hooks.succeedModule.call(module);
        return callback();
    }
);
</code></pre>
<p>执行 buildModule 回调，调用 afterBuild 方法，开始根据收集到的 dependencies 进行遍历模块。</p>
<pre><code class="language-js">const afterBuild = () =&gt; {
    /* ... */
    this.processModuleDependencies(module, err =&gt; {
        if (err) return callback(err);
        callback(null, module);
    });
};

processModuleDependencies(module, callback) {
    const dependencies = new Map();

    const addDependency = dep =&gt; {
        const resourceIdent = dep.getResourceIdentifier();
        if (resourceIdent) {
            const factory = this.dependencyFactories.get(dep.constructor);
            if (factory === undefined) {
                throw new Error(
                    `No module factory available for dependency type: ${dep.constructor.name}`
                );
            }
            let innerMap = dependencies.get(factory);
            if (innerMap === undefined) {
                dependencies.set(factory, (innerMap = new Map()));
            }
            let list = innerMap.get(resourceIdent);
            if (list === undefined) innerMap.set(resourceIdent, (list = []));
            list.push(dep);
        }
    };

    const addDependenciesBlock = block =&gt; {
        if (block.dependencies) { // 普通模块
            iterationOfArrayCallback(block.dependencies, addDependency);
        }
        if (block.blocks) { // 异步模块
            iterationOfArrayCallback(block.blocks, addDependenciesBlock);
        }
        if (block.variables) {
            iterationBlockVariable(block.variables, addDependency);
        }
    };

    try {
        addDependenciesBlock(module);
    } catch (e) {
        callback(e);
    }

    const sortedDependencies = [];

    for (const pair1 of dependencies) {
        for (const pair2 of pair1[1]) {
            sortedDependencies.push({
                factory: pair1[0],
                dependencies: pair2[1]
            });
        }
    }

    this.addModuleDependencies(
        module,
        sortedDependencies,
        this.bail,
        null,
        true,
        callback
    );
}
</code></pre>
<p>最终会得到一个 sortedDependencies ，数据结构如下：</p>
<pre><code class="language-js">{
    factory: NormalModuleFactory, // 依赖模块类型
    dependencies: [HarmonyImportSideEffectDependency, HarmonyImportSpecifierDependency], // Map
},
</code></pre>
<p>执行 addModuleDependencies 方法，根据 sortedDependencies 进行遍历。通过 factory.create 开始执行新的 module build 过程。</p>
<pre><code class="language-js">addModuleDependencies(
    module,
    dependencies,
    bail,
    cacheGroup,
    recursive,
    callback
) {
    const start = this.profile &amp;&amp; Date.now();
    const currentProfile = this.profile &amp;&amp; {};

    asyncLib.forEach(
        dependencies,
        (item, callback) =&gt; {
            const dependencies = item.dependencies;
            /* ... */
            const semaphore = this.semaphore;
            semaphore.acquire(() =&gt; {
                const factory = item.factory;
                factory.create(
                    {
                        contextInfo: {
                            issuer: module.nameForCondition &amp;&amp; module.nameForCondition(),
                            compiler: this.compiler.name
                        },
                        resolveOptions: module.resolveOptions,
                        context: module.context,
                        dependencies: dependencies
                    },
                    (err, dependentModule) =&gt; {
                        /* ... */
                        if (addModuleResult.build) {
                            this.buildModule(
                                dependentModule,
                                isOptional(),
                                module,
                                dependencies,
                                err =&gt; {
                                    if (err) {
                                        semaphore.release();
                                        return errorOrWarningAndCallback(err);
                                    }

                                    if (currentProfile) {
                                        const afterBuilding = Date.now();
                                        currentProfile.building = afterBuilding - afterFactory;
                                    }

                                    semaphore.release();
                                    afterBuild();
                                }
                            );
                        } else {
                            semaphore.release();
                            this.waitForBuildingFinished(dependentModule, afterBuild);
                        }
                    }
                );
            });
        },
        err =&gt; {
            // In V8, the Error objects keep a reference to the functions on the stack. These warnings &amp;
            // errors are created inside closures that keep a reference to the Compilation, so errors are
            // leaking the Compilation object.

            if (err) {
                // eslint-disable-next-line no-self-assign
                err.stack = err.stack;
                return callback(err);
            }

            return process.nextTick(callback);
        }
    );
}
</code></pre>
<p>在所有的依赖执行后，会执行回调生成入口 module 信息
这里标志着 addEntry 的结束</p>
<h2 id="chunk-生成">chunk 生成</h2>
<p><img src="/assets/images/module-38c92cd80ec7b60f0248fd2b4b976e6e.png" width="590" height="3174"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/webpack-resolve/loader"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">loader</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/whoami"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">whoami</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#模块的类型" class="table-of-contents__link toc-highlight">模块的类型</a></li><li><a href="#执行过程" class="table-of-contents__link toc-highlight">执行过程</a></li><li><a href="#chunk-生成" class="table-of-contents__link toc-highlight">chunk 生成</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Navigation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/whoami">Stuff of Legend</a></li><li class="footer__item"><a href="https://github.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">other Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sidtoons.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">SidToons.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://vocab.js.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">vocab.js.org<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tldr.palashsh.me/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TL;DR News<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2024 Blogasaurus by Palash Shrivastava.</div></div></div></footer></div>
</body>
</html>