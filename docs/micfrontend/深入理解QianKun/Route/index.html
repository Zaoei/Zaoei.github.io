<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-micfrontend/深入理解QianKun/Route/Route" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">single-spa中的路由实现 | Zaoei Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://blog.palashsh.me/docs/micfrontend/深入理解QianKun/Route/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:card" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:site" content="@battleofplassey"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="single-spa中的路由实现 | Zaoei Blog"><meta data-rh="true" name="description" content="笔者今天为什么要介绍single-spa中的路由呢，在对QianKun的源码分析中，笔者发现QianKun未对路由进行实现，主要还是调用single-spa中的路由。为了更好的了解微前端的机制，我们有必要对路由这块进行解读，在解读single-spa实现方式之前，笔者先带大家了解下一些路由的前置知识。"><meta data-rh="true" property="og:description" content="笔者今天为什么要介绍single-spa中的路由呢，在对QianKun的源码分析中，笔者发现QianKun未对路由进行实现，主要还是调用single-spa中的路由。为了更好的了解微前端的机制，我们有必要对路由这块进行解读，在解读single-spa实现方式之前，笔者先带大家了解下一些路由的前置知识。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.palashsh.me/docs/micfrontend/深入理解QianKun/Route/"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/micfrontend/深入理解QianKun/Route/" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/micfrontend/深入理解QianKun/Route/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2KDKKFPT4A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Zaoei Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Zaoei Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Zaoei Blog JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5V7R63B0J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R5V7R63B0J",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Zaoei Blog" href="/opensearch.xml">
<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><link rel="stylesheet" href="/assets/css/styles.09761036.css">
<script src="/assets/js/runtime~main.d0e4631e.js" defer="defer"></script>
<script src="/assets/js/main.46e122de.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="blog" href="/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="doc" doclink="docs/webpack-resolve/README.md" href="/docs/webpack-resolve/">docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Zaoei" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" externallink="https://github.com/Zaoei" link="external" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/algorithm">algorithm</a><button aria-label="Expand sidebar category &#x27;algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/micfrontend">micfrontend</a><button aria-label="Collapse sidebar category &#x27;micfrontend&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/">README</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/design/">design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/micfrontend/practice/">qiankun 实践</a><button aria-label="Expand sidebar category &#x27;qiankun 实践&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/micfrontend/深入理解QianKun/CSS SandBox/">深入理解QianKun</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/深入理解QianKun/CSS SandBox/">CSS SandBox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/深入理解QianKun/JS SandBox/">JS SandBox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/深入理解QianKun/Load、Prefetch and Communication/">加载流程、预加载以及通信</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/深入理解QianKun/Review &amp;&amp; Summary/">回顾和总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/micfrontend/深入理解QianKun/Route/">single-spa中的路由实现</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/operating-system">operating system</a><button aria-label="Expand sidebar category &#x27;operating system&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/single sign on/CAS">single sign on</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-optimize">webpack-optimize</a><button aria-label="Expand sidebar category &#x27;webpack-optimize&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-resolve">webpack-resolve</a><button aria-label="Expand sidebar category &#x27;webpack-resolve&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/whoami">whoami</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/micfrontend"><span itemprop="name">micfrontend</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">深入理解QianKun</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">single-spa中的路由实现</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="single-spa中的路由实现">single-spa中的路由实现</h1>
<blockquote>
<p>笔者今天为什么要介绍<code>single-spa</code>中的路由呢，在对<code>QianKun</code>的源码分析中，笔者发现<code>QianKun</code>未对路由进行实现，主要还是调用<code>single-spa</code>中的路由。为了更好的了解微前端的机制，我们有必要对路由这块进行解读，在解读<code>single-spa</code>实现方式之前，笔者先带大家了解下一些路由的前置知识。</p>
</blockquote>
<p>Tips：本文中所涉及的<code>single-spa</code>的版本为<code>v5.9.3</code></p>
<h2 id="路由的前置知识">路由的前置知识</h2>
<p>我们先来聊一聊要实现一个路由主要需要做到哪几个部分呢？</p>
<p>一、当url变化的时候，保持UI界面的同步更新，即加载对应的内容</p>
<p>二、当浏览器刷新的时候，保持当前url地址，并且加载相应的内容</p>
<p>三、浏览器前进后退时，加载相应的内容</p>
<p>而在浏览器中，常见的路由主要分为两种：</p>
<ul>
<li>Browser Router</li>
<li>Hash Router</li>
</ul>
<h3 id="browser-router">Browser Router</h3>
<p>该方式主要是由<code>window</code>对象的<code>history</code>对象提供的，主要是提供了对浏览器会话历史的访问，同时支持以下操作：</p>
<ul>
<li>
<p>向前跳、向后跳以及跳转到会话历史的某个点</p>
<pre><code class="language-jsx">// 向前
window.history.back();

// 向  后
window.history.forward();

// 跳转到某个点，当前页面的相对位置为0
window.history.go(-1)

// 查看浏览器会话历史的页数
window.history.length
</code></pre>
</li>
<li>
<p>添加会话历史</p>
<pre><code class="language-jsx">// 结合onpopstate可以获得state值
const state = {
	page: 1
}
// 大多数浏览器忽略，目前被忽略
const title = &#x27;&#x27;
// 跳转的地址
const url = &#x27;?page=1&#x27;

history.pushState(state, title, url);
</code></pre>
<p>Tips：只会修改url不会去检查url是否存在以及加载页面</p>
</li>
<li>
<p>修改会话历史</p>
<pre><code class="language-jsx">// 这个和上面的添加历史会话使用相同，不同在于修改当前历史会话的url的信息

const state = {
	page: 2
}
const title = &#x27;&#x27;
const url = &#x27;?page=2&#x27;

history.replaceState(state, title, url);
</code></pre>
<p>Tips：只会修改url不会去检查url是否存在以及加载页面</p>
</li>
<li>
<p>监听会话历史的变化</p>
<pre><code class="language-jsx">window.onpopstate = function(event) {
  alert(&quot;location: &quot; + document.location + &quot;, state: &quot; + JSON.stringify(event.state));
}

window.addEventListener(&quot;popstate&quot;, function(event) {
  alert(&quot;location: &quot; + document.location + &quot;, state: &quot; + JSON.stringify(event.state));
});
</code></pre>
<p>Tips：不会在<code>history.pushState</code>和<code>history.replaceState</code>触发</p>
</li>
</ul>
<p>详情可以点击：<strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API">History API</a></strong></p>
<h3 id="hash-router">Hash Router</h3>
<p>主要是根据<code>location.hash</code>的变化来进行页面的更新，该路由的变化主要是通过监听<code>hashchange</code>事件</p>
<pre><code class="language-jsx">window.addEventListener(&#x27;hashchange&#x27;, function (event) {
    // ...
})

window.onhashchange = function (event) { 
    // ... 
}
</code></pre>
<p>详情可以点击：<strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/hashchange_event">Window: hashchange event</a></strong></p>
<h2 id="single-spa中的路由机制">single-spa中的路由机制</h2>
<p>经过👆的讲述，显然我们实现路由机制需要对路由进行监听，而<code>single-spa</code>是支持<code>Browser Router</code>以及<code>Hash Router</code>两种路由方式的，即对<code>popstate</code>和<code>hashchange</code>进行监听</p>
<h3 id="基本流程">基本流程</h3>
<p><img alt="Untitled" src="/assets/images/监听路由-6a48cbc717e259d7270a3d86a37d625a.png" width="900" height="806"></p>
<p>以上流程其实做的事情很简单：</p>
<p>1、第一个步骤设置监听，执行<code>urlReroute</code>是为了先让注册的微应用实现生命周期的转化，比如加载⇒启动、启动⇒挂载等</p>
<p>2、重写监听和移除函数，是为了收集微应用中路由监听的回调事件，存储起来在某一时刻再执行</p>
<p>3、重写<code>pushState</code>和<code>replaceState</code>主要是为了在路由变更的时候去触发微应用的加载</p>
<h3 id="对popstate和hashchange进行监听">对<code>popstate</code>和<code>hashchange</code>进行监听</h3>
<p>src/navigation/navigation-events.js</p>
<pre><code class="language-jsx">// 监听的路由事件数组
export const routingEventsListeningTo = [&quot;hashchange&quot;, &quot;popstate&quot;];

// 记录路由回调
const capturedEventListeners = {
  hashchange: [],
  popstate: [],
}

// 重载路由事件
function urlReroute() {
  reroute([], arguments);
}
</code></pre>
<pre><code class="language-jsx">if (isInBrowser) {
  // 对hashchange以及popstate设置监听，这边回调的处理暂时不看
  window.addEventListener(&quot;hashchange&quot;, urlReroute);
  window.addEventListener(&quot;popstate&quot;, urlReroute);

  // 重写window.addEventListener以及window.removeEventListener方法，收集应用中路由变化的监听回调
  const originalAddEventListener = window.addEventListener;
  const originalRemoveEventListener = window.removeEventListener;

  window.addEventListener = function (eventName, fn) {
		// 记录回调函数到capturedEventListeners中
    if (typeof fn === &quot;function&quot;) {
      if (
        routingEventsListeningTo.indexOf(eventName) &gt;= 0 &amp;&amp;
        !find(capturedEventListeners[eventName], (listener) =&gt; listener === fn)
      ) {
        capturedEventListeners[eventName].push(fn);
        return;
      }
    }

    return originalAddEventListener.apply(this, arguments);
  };

  window.removeEventListener = function (eventName, listenerFn) {
    if (typeof listenerFn === &quot;function&quot;) {
			// 移除路由监听的回调函数
      if (routingEventsListeningTo.indexOf(eventName) &gt;= 0) {
        capturedEventListeners[eventName] = capturedEventListeners[
          eventName
        ].filter((fn) =&gt; fn !== listenerFn);
        return;
      }
    }

    return originalRemoveEventListener.apply(this, arguments);
  };

	// 对pushState以及replaceState进行重写
  window.history.pushState = patchedUpdateState(
    window.history.pushState,
    &quot;pushState&quot;
  );

  window.history.replaceState = patchedUpdateState(
    window.history.replaceState,
    &quot;replaceState&quot;
  );
	......
}
</code></pre>
<h3 id="对pushstate和replacestate的自定义处理">对pushState和replaceState的自定义处理</h3>
<p>进入patchedUpdateState</p>
<pre><code class="language-jsx">function patchedUpdateState(updateState, methodName) {
  return function () {
    const urlBefore = window.location.href;
    const result = updateState.apply(this, arguments);
    const urlAfter = window.location.href;

    if (!urlRerouteOnly || urlBefore !== urlAfter) {
			// single-spa是否已经启动
      if (isStarted()) {
				// 触发PopState事件
        window.dispatchEvent(
          createPopStateEvent(window.history.state, methodName)
        );
      } else {
        reroute([]);
      }
    }

    return result;
  };
}

function createPopStateEvent(state, originalMethodName) {
  let evt;
  try {
    evt = new PopStateEvent(&quot;popstate&quot;, { state });
  } catch (err) {
    // 兼容处理
    evt = document.createEvent(&quot;PopStateEvent&quot;);
    evt.initPopStateEvent(&quot;popstate&quot;, false, false, state);
  }
  evt.singleSpa = true;
  evt.singleSpaTrigger = originalMethodName;
  return evt;
}
</code></pre>
<p>目的：使<code>history.pushState</code>和<code>history.replaceState</code>也会触发<code>popstate</code>事件</p>
<p>Q1：为什么要对isStarted进行判断？</p>
<pre><code class="language-tsx">let started = false;

export function start(opts) {
  started = true;
  if (opts &amp;&amp; opts.urlRerouteOnly) {
    setUrlRerouteOnly(opts.urlRerouteOnly);
  }
  if (isInBrowser) {
    reroute();
  }
}

export function isStarted() {
  return started;
}
</code></pre>
<p>官方文档中是这么说的：在调用 <code>start</code>之前, 应用会被加载, 但不会初始化，挂载或卸载。 <code>start</code>的原因是让你更好的控制你单页应用的性能。比如：你在注册应用之后，需要先去某些接口（比如获取登陆用户的信息），然后才是挂载相应的应用。</p>
<h3 id="路由重载的回调reroute"><strong>路由重载的回调reroute</strong></h3>
<ul>
<li>对处于不同生命周期的微应用进行生命周期的变更</li>
<li>处理收集的<code>hashchange</code>和<code>popstate</code>的回调事件</li>
<li>触发自定义事件</li>
</ul>
<h3 id="基本流程-1">基本流程</h3>
<ul>
<li>关键点说明<!-- -->
<ul>
<li>
<p>appChangeUnderway：是否有应用由于**<code>reroute</code><strong>生命周期处于变更阶段，当存在时后续的</strong><code>reroute</code>**将会返回promise，并且把参数存入<code>peopleWaitingOnAppChange</code>数组中进行等待</p>
</li>
<li>
<p>getAppChanges：根据app.status和当前路由把所以应用划分为四个数组</p>
<ul>
<li>appsToUnload：处于<code>NOT_BOOTSTRAPPED</code>和<code>NOT_MOUNTED</code>的状态，并且和当前URL不匹配的应用</li>
<li>appsToUnmount：处于<code>MOUNTED</code>阶段并且和当前URL不匹配的应用</li>
<li>appsToLoad：处于<code>NOT_LOADED</code>或者是<code>LOADING_SOURCE_CODE</code>的资源，并且和当前URL匹配的应用</li>
<li>appsToMount：处于<code>NOT_BOOTSTRAPPED</code>和<code>NOT_MOUNTED</code>  的状态，并且和当前URL匹配的应用</li>
</ul>
<p><img alt="Untitled" src="/assets/images/应用状态-6615592e46fb95d5b77dd3c1c6ad3e01.png" width="1510" height="1230"></p>
<p>应用加载状态的流程图：</p>
<p>注：出自<a href="https://juejin.cn/post/7074172393001861133">https://juejin.cn/post/7074172393001861133</a></p>
<p>除上面10个状态以外，还有两个状态是在发生错误时定义的</p>
<pre><code class="language-jsx">export const LOAD_ERROR = &quot;LOAD_ERROR&quot;;
export const SKIP_BECAUSE_BROKEN = &quot;SKIP_BECAUSE_BROKEN&quot;;
</code></pre>
</li>
<li>
<p>isStarted：是否调用了<code>single-spa</code>的<code>start</code>方法，如果调用说明接下来使用single-spa渲染应用</p>
</li>
</ul>
</li>
<li>具体流程图</li>
</ul>
<p><img alt="reroute.png" src="/assets/images/reroute-96408b138f9115aa346ac01aec7ad986.png" width="2039" height="4292"></p>
<p><code>single-spa:before-no-app-change</code>**：**在本次<code>reroute</code>的时候，没有应用发生生命周期的转变</p>
<p><code>single-spa:before-app-change</code>：在本次<code>reroute</code>的时候，有应用发生生命周期的转变</p>
<p><code>single-spa:before-routing-event</code>：只要<code>reroute</code>就回触发</p>
<p><code>single-spa:before-mount-routing-event</code>：执行完<code>appsToUnload</code>和<code>appsToUnmount</code>中所有的异步方法后，表示后续要开始加载应用了</p>
<p><code>single-spa:no-app-change</code>：在本次<code>reroute</code>的时候，没有应用发生生命周期的转变（转变完成之后）</p>
<p><code>single-spa:app-change</code>：在本次<code>reroute</code>的时候，有应用发生生命周期的转变（转变完成之后）</p>
<p><code>single-spa:routing-event</code>：发生在<code>reroute</code> 结束的时候</p>
<p>Tips：以上都是基于进入了<code>performAppChanges</code>前提下</p>
<ul>
<li>源码解析</li>
</ul>
<pre><code class="language-jsx">export function reroute(pendingPromises = [], eventArguments) {
  // 是否处于reroute中
  if (appChangeUnderway) {
		// 返回promise，存储到peopleWaitingOnAppChange，reroute之后再进行执行
    return new Promise((resolve, reject) =&gt; {
      peopleWaitingOnAppChange.push({
        resolve,
        reject,
        eventArguments,
      });
    });
  }

	// 获取所有的的微应用状态，存入四个状态的数组中
  const {
    appsToUnload,
    appsToUnmount,
    appsToLoad,
    appsToMount,
  } = getAppChanges();  

  let appsThatChanged,
    navigationIsCanceled = false,
    oldUrl = currentUrl,
    newUrl = (currentUrl = window.location.href);

	// 判断single-spa是否启用
  if (isStarted()) {
    appChangeUnderway = true;
    appsThatChanged = appsToUnload.concat(
      appsToLoad,
      appsToUnmount,
      appsToMount
    );
    return performAppChanges();
  } else {
    appsThatChanged = appsToLoad;
    return loadApps();
  }
	...
}
</code></pre>
<h3 id="加载应用loadapps">加载应用loadApps</h3>
<ul>
<li>执行加载应用的事件</li>
<li>加载完成后执行<code>callAllEventListeners</code>即监听路由变化的回调事件</li>
</ul>
<pre><code class="language-jsx">export function reroute(pendingPromises = [], eventArguments) {
	// ...
	function loadApps() {
	    return Promise.resolve().then(() =&gt; {
	      const loadPromises = appsToLoad.map(toLoadPromise);
	
	      return (
	        Promise.all(loadPromises)
	          .then(callAllEventListeners)
	          .then(() =&gt; [])
	          .catch((err) =&gt; {
	            callAllEventListeners();
	            throw err;
	          })
	      );
	    });
	  }
	
	function callAllEventListeners() {
	  pendingPromises.forEach((pendingPromise) =&gt; {
	    callCapturedEventListeners(pendingPromise.eventArguments);
	  });
	
	  callCapturedEventListeners(eventArguments);
	}
	...
}

// 执行设置路由的回调事件
export function callCapturedEventListeners(eventArguments) {
  if (eventArguments) { 
    const eventType = eventArguments[0].type;
    if (routingEventsListeningTo.indexOf(eventType) &gt;= 0) {
      capturedEventListeners[eventType].forEach((listener) =&gt; {
        try {
          listener.apply(this, eventArguments);
        } catch (e) {
          setTimeout(() =&gt; {
            throw e;
          });
        }
      });
    }
  }
}

export const routingEventsListeningTo = [&quot;hashchange&quot;, &quot;popstate&quot;];
const capturedEventListeners = {
  hashchange: [],
  popstate: [],
}
</code></pre>
<p><strong>toLoadPromise的主要作用</strong></p>
<ul>
<li>应用状态码从<code>LOADING_SOURCE_CODE</code> ⇒ <code>NOT_BOOTSTRAPPED</code></li>
<li>执行<code>app.**loadApp**</code></li>
<li>为app添加<code>bootstrap</code>、<code>mount</code>、<code>unmount</code>、<code>unload</code>生命周期方法</li>
</ul>
<h3 id="执行performappchanges">执行performAppChanges</h3>
<ul>
<li>自定义事件的触发</li>
<li>对不同阶段的应用进行处理</li>
<li>执行<code>callAllEventListeners</code></li>
<li>最终执行<code>finishUpAndReturn</code></li>
</ul>
<pre><code class="language-jsx">function performAppChanges() {
    return Promise.resolve().then(() =&gt; {
      // 一些自定义事件的触发
      window.dispatchEvent(
        new CustomEvent(
          appsThatChanged.length === 0
            ? &quot;single-spa:before-no-app-change&quot;
            : &quot;single-spa:before-app-change&quot;,
          getCustomEventDetail(true)
        )
      );
			...
			// 对于appsToLoad阶段的应用进行加载 =&gt; 启动 =&gt; 挂载
      const loadThenMountPromises = appsToLoad.map((app) =&gt; {
        return toLoadPromise(app).then((app) =&gt;
          tryToBootstrapAndMount(app, unmountAllPromise)
        );
      });

			// 对于appsToMount阶段的应用挂载
      const mountPromises = appsToMount
        .filter((appToMount) =&gt; appsToLoad.indexOf(appToMount) &lt; 0)
        .map((appToMount) =&gt; {
          return tryToBootstrapAndMount(appToMount, unmountAllPromise);
        });

			// 卸载应用 =&gt; 执行callAllEventListeners =&gt; 执行loadThenMountPromises和mountPromises =&gt; finishUpAndReturn
      return unmountAllPromise
        .catch((err) =&gt; {
          callAllEventListeners();
          throw err;
        })
        .then(() =&gt; {
          callAllEventListeners();

          return Promise.all(loadThenMountPromises.concat(mountPromises))
            .catch((err) =&gt; {
              pendingPromises.forEach((promise) =&gt; promise.reject(err));
              throw err;
            })
            .then(finishUpAndReturn);
        });
    });
  }
</code></pre>
<p><strong>finishUpAndReturn</strong></p>
<ul>
<li>触发自定义事件</li>
<li>重置*<code>appChangeUnderway</code>*</li>
<li>对于<strong>peopleWaitingOnAppChange中的事件，调用reroute进行处理</strong></li>
</ul>
<pre><code class="language-jsx">function finishUpAndReturn() {
    const returnValue = getMountedApps();
    pendingPromises.forEach((promise) =&gt; promise.resolve(returnValue));

		// 触发自定义事件
    try {
      const appChangeEventName =
        appsThatChanged.length === 0
          ? &quot;single-spa:no-app-change&quot;
          : &quot;single-spa:app-change&quot;;
      window.dispatchEvent(
        new CustomEvent(appChangeEventName, getCustomEventDetail())
      );
      window.dispatchEvent(
        new CustomEvent(&quot;single-spa:routing-event&quot;, getCustomEventDetail())
      );
    } catch (err) {
      setTimeout(() =&gt; {
        throw err;
      });
    }

    // 重置appChangeUnderway
    appChangeUnderway = false;
	
		// 调用reroute处理peopleWaitingOnAppChange
    if (peopleWaitingOnAppChange.length &gt; 0) {
      const nextPendingPromises = peopleWaitingOnAppChange;
			// 重置为空数组
      peopleWaitingOnAppChange = [];
      reroute(nextPendingPromises);
    }
		...
  }
</code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/micfrontend/深入理解QianKun/Review &amp;&amp; Summary/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">回顾和总结</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/operating-system"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">operating system</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#路由的前置知识" class="table-of-contents__link toc-highlight">路由的前置知识</a><ul><li><a href="#browser-router" class="table-of-contents__link toc-highlight">Browser Router</a></li><li><a href="#hash-router" class="table-of-contents__link toc-highlight">Hash Router</a></li></ul></li><li><a href="#single-spa中的路由机制" class="table-of-contents__link toc-highlight">single-spa中的路由机制</a><ul><li><a href="#基本流程" class="table-of-contents__link toc-highlight">基本流程</a></li><li><a href="#对popstate和hashchange进行监听" class="table-of-contents__link toc-highlight">对<code>popstate</code>和<code>hashchange</code>进行监听</a></li><li><a href="#对pushstate和replacestate的自定义处理" class="table-of-contents__link toc-highlight">对pushState和replaceState的自定义处理</a></li><li><a href="#路由重载的回调reroute" class="table-of-contents__link toc-highlight"><strong>路由重载的回调reroute</strong></a></li><li><a href="#基本流程-1" class="table-of-contents__link toc-highlight">基本流程</a></li><li><a href="#加载应用loadapps" class="table-of-contents__link toc-highlight">加载应用loadApps</a></li><li><a href="#执行performappchanges" class="table-of-contents__link toc-highlight">执行performAppChanges</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Navigation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/whoami">Stuff of Legend</a></li><li class="footer__item"><a href="https://github.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">other Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sidtoons.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">SidToons.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://vocab.js.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">vocab.js.org<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tldr.palashsh.me/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TL;DR News<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2024 Blogasaurus by Palash Shrivastava.</div></div></div></footer></div>
</body>
</html>