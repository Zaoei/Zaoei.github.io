<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/JS SandBox" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">JS SandBox | Zaoei Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://blog.palashsh.me/docs/micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:card" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:site" content="@battleofplassey"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="JS SandBox | Zaoei Blog"><meta data-rh="true" name="description" content="ä»€ä¹ˆæ˜¯æ²™ç®±"><meta data-rh="true" property="og:description" content="ä»€ä¹ˆæ˜¯æ²™ç®±"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.palashsh.me/docs/micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2KDKKFPT4A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Zaoei Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Zaoei Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Zaoei Blog JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5V7R63B0J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R5V7R63B0J",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Zaoei Blog" href="/opensearch.xml">
<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><link rel="stylesheet" href="/assets/css/styles.09761036.css">
<script src="/assets/js/runtime~main.d0e4631e.js" defer="defer"></script>
<script src="/assets/js/main.46e122de.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="blog" href="/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="doc" doclink="docs/webpack-resolve/README.md" href="/docs/webpack-resolve/">docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Zaoei" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" externallink="https://github.com/Zaoei" link="external" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/algorithm">algorithm</a><button aria-label="Expand sidebar category &#x27;algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/micfrontend">micfrontend</a><button aria-label="Collapse sidebar category &#x27;micfrontend&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/">README</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/design/">design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/micfrontend/practice/">qiankun å®è·µ</a><button aria-label="Expand sidebar category &#x27;qiankun å®è·µ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/CSS SandBox/">æ·±å…¥ç†è§£QianKun</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/CSS SandBox/">CSS SandBox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/JS SandBox/">JS SandBox</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/Loadã€Prefetch and Communication/">åŠ è½½æµç¨‹ã€é¢„åŠ è½½ä»¥åŠé€šä¿¡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/Review &amp;&amp; Summary/">å›é¡¾å’Œæ€»ç»“</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/Route/">single-spaä¸­çš„è·¯ç”±å®ç°</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/operating-system">operating system</a><button aria-label="Expand sidebar category &#x27;operating system&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/single sign on/CAS">single sign on</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-optimize">webpack-optimize</a><button aria-label="Expand sidebar category &#x27;webpack-optimize&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-resolve">webpack-resolve</a><button aria-label="Expand sidebar category &#x27;webpack-resolve&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/whoami">whoami</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/micfrontend"><span itemprop="name">micfrontend</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">æ·±å…¥ç†è§£QianKun</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">JS SandBox</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="js-sandbox">JS SandBox</h1>
<h2 id="ä»€ä¹ˆæ˜¯æ²™ç®±">ä»€ä¹ˆæ˜¯æ²™ç®±</h2>
<p>æ²™ç®±å³Â <code>SandBox</code>ï¼Œå®ƒæ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºä¸¥æ ¼æ§åˆ¶è®¿é—®èµ„æºã€‚é€šè¿‡åœ¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒï¼ŒæŠŠä¸€äº›<code>æ¥æºä¸å¯ä¿¡</code>ã€<code>å…·æœ‰ç ´ååŠ›</code>æˆ–è€…åˆæ˜¯<code>æ— æ³•åˆ¤å®šçš„æ¶æ„ç¨‹åº</code>ä½¿å…¶åœ¨è¯¥ç¯å¢ƒä¸‹è¿è¡Œï¼Œéš”ç¦»äº†å¯¹å¤–éƒ¨ç¨‹åºçš„å½±å“ï¼Œè¿™æ ·å³ä½¿å‘ç”Ÿäº†é”™è¯¯æˆ–è€…å®‰å…¨é—®é¢˜éƒ½ä¸ä¼šå½±å“åˆ°å¤–é¢ã€‚</p>
<p>æˆ‘ä»¬æ ¹æ®å®ç°çš„æ–¹æ¡ˆä¸åŒï¼ŒÂ <code>SandBox</code>å¯ä»¥åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>å•å®ä¾‹æ¨¡å¼ï¼šå…¨å±€åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ï¼Œç›´æ¥ä»£ç†åŸç”Ÿçš„<code>window</code>å¯¹è±¡ï¼Œè®°å½•æ¯ä¸ªæ²™ç®±å†…<code>window</code>å¯¹è±¡ä¸Šçš„å¢åˆ æ”¹ç­‰æ“ä½œï¼Œæ¿€æ´»æŸä¸ªæ²™ç®±æ—¶æ¢å¤ä¸Šä¸€æ¬¡å¤±æ´»æ—¶çš„çŠ¶æ€ï¼Œå¤±æ´»æ—¶æ¢å¤åŸæ¥<code>window</code>çš„çŠ¶æ€ã€‚</li>
<li>å¤šå®ä¾‹æ¨¡å¼ï¼šä»£ç†ä¸€ä¸ªå…¨æ–°çš„<code>window</code>å¯¹è±¡ï¼Œæ‰€æœ‰çš„æ›´æ”¹åŸºäºè¿™ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œå¤šä¸ªå®ä¾‹ä¹‹é—´äº’ä¸å½±å“ã€‚</li>
</ul>
<h2 id="æ²™ç®±çš„åº”ç”¨åœºæ™¯">æ²™ç®±çš„åº”ç”¨åœºæ™¯</h2>
<p>åŸºäºä¸Šé¢ğŸ‘†å¯¹æ²™ç®±çš„ä»‹ç»ï¼Œç®€è€Œè¨€ä¹‹æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„è¿˜æ˜¯ä¸ºäº†ä¿éšœç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼Œé€šè¿‡éš”ç¦»çš„æ‰‹æ®µé¿å…é”™è¯¯ã€å¼‚å¸¸æˆ–è€…æ¶æ„ä»£ç çš„å½±å“ï¼Œåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘æˆ–è€…æ¥è§¦ä¸­ï¼Œä¹Ÿæœ‰å¾ˆå¤šè¿™æ ·çš„åœºæ™¯ï¼Œä»¥ä¸‹åˆ—ä¸¾å‡ ä¸ªï¼š</p>
<ul>
<li><strong>å¾®å‰ç«¯</strong>ï¼šå¾®å‰ç«¯åœºæ™¯ä¸‹ï¼Œå„ä¸ªå­åº”ç”¨è¢«é›†æˆåˆ°ä¸€ä¸ªè¿è¡Œæ—¶ï¼Œé¿å…æ¯ä¸ªå­åº”ç”¨äº’ç›¸å½±å“ï¼Œå¯¼è‡´çš„ä¸€äº›å¦‚å…¨å±€æ±¡æŸ“çš„é—®é¢˜ï¼Œä¸‹é¢ğŸ‘‡ä¼šä»¥<code>QianKun</code>ä¸ºä¾‹è¿›è¡Œè¯¦ç»†çš„è®²è¿°</li>
<li><strong>JSONP</strong>ï¼šå½“è¿è¡Œé€šè¿‡Â <code>&lt;script&gt;</code>æ ‡ç­¾çš„urlè¿”å›çš„JSä»£ç æ—¶ï¼Œä¸ºäº†è§„é¿ä¸€å®šç¨‹åº¦ä¸Šçš„é£é™©å¯èƒ½éœ€è¦åœ¨æ²™ç®±ä¸­æ‰§è¡Œ</li>
<li><strong>åœ¨çº¿ç¼–è¾‘å™¨</strong>ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ªç¼–è¾‘å™¨æˆ–è€…ç±»ä¼¼çš„å¯è¾“å…¥ç•Œé¢éœ€è¦ç”¨æˆ·è‡ªä¸»çš„ç¼–è¾‘ä»£ç ï¼Œç„¶åå»æ‰§è¡Œå®ƒï¼Œæ¯”å¦‚ï¼š<code>CodeSandBox</code>å¯¹äºç”¨æˆ·è¾“å…¥çš„ä¸ç¡®å®šä»£ç ä¸ºäº†é˜²æ­¢æ±¡æŸ“æœ€å¥½æ˜¯åœ¨æ²™ç®±ä¸­æ‰§è¡Œ</li>
</ul>
<p>æˆ‘ä»¬æŠŠå®ƒä»¬è¿›è¡ŒæŠ½è±¡çš„å½’ç±»ï¼Œå¤§æ¦‚å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š</p>
<ul>
<li><strong>æ‰§è¡Œæ—¶</strong>ï¼šæ‰§è¡Œä¸ç¡®å®šã€ä¸å¯ä¿¡çš„JSä»£ç </li>
<li><strong>å¼•å…¥æ—¶</strong>ï¼šä¸ºå¼•å…¥çš„<code>JS</code>ä»£ç æä¾›éš”ç¦»ç¯å¢ƒ</li>
<li><strong>è®¿é—®æ—¶</strong>ï¼šæ‰§è¡Œä»£ç å¯¹å…¨å±€å¯¹è±¡çš„è®¿é—®å’Œä¿®æ”¹è¿›è¡Œé™åˆ¶</li>
</ul>
<h2 id="jsæ²™ç®±çš„å¸¸è§è§£å†³æ–¹æ¡ˆ">JSæ²™ç®±çš„å¸¸è§è§£å†³æ–¹æ¡ˆ</h2>
<p>åœ¨å®ç°<code>JS</code>æ²™ç®±é—®é¢˜ä¹‹å‰æˆ‘ä»¬éœ€è¦æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>æ„å»ºç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</li>
<li>æ¨¡æ‹Ÿæµè§ˆå™¨çš„åŸç”Ÿå¯¹è±¡</li>
</ul>
<p>åŸºäºè¿™ä¸¤ç‚¹ï¼Œç›®å‰ç»™å‡ºä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š</p>
<h3 id="with">with</h3>
<p><code>with</code>è¯­å¥å°†æ”¹å˜<code>ä½œç”¨åŸŸ</code>ï¼Œä¼šè®©å†…éƒ¨çš„è®¿é—®ä¼˜å…ˆä»ä¼ å…¥çš„å¯¹è±¡ä¸ŠæŸ¥æ‰¾ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸€æ®µä»£ç ï¼š</p>
<pre><code class="language-jsx">const obj = {
  a: 1
}
const obj2 = {
  b: 2
}
const a = 9

const fun = (obj) =&gt; {
  with(obj) { // ç›¸å½“äº{}å†…è®¿é—®çš„å˜é‡éƒ½ä¼šä»objä¸ŠæŸ¥æ‰¾
    console.log(a)
    a = 3
  }
}

fun(obj) // 1
console.log(obj) // { a: 3 } 
</code></pre>
<p>åœ¨å½“å‰çš„å†…éƒ¨ç¯å¢ƒä¸­æ‰¾ä¸åˆ°æŸä¸ªå˜é‡æ—¶ï¼Œä¼šæ²¿ç€ä½œç”¨ä½œç”¨åŸŸé“¾ä¸€å±‚å±‚å‘ä¸ŠæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±æ‹‹å‡º<code>ReferenceError</code>å¼‚å¸¸ã€‚æˆ‘ä»¬çœ‹ä¸‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-jsx">const obj = {
  a: 1
}
const obj2 = {
  b: 2
}
const b = 9

const fun = (obj) =&gt; {
  with(obj) {
    console.log(a, b)
  }
}

fun(obj) // 1 9
fun(obj2) // ReferenceError: a is not defined
</code></pre>
<p>è™½ç„¶<code>with</code>å®ç°äº†åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾å˜é‡çš„æ•ˆæœï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨ä¸€ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>æ‰¾ä¸åˆ°æ—¶ä¼šæ²¿ç€ä½œç”¨åŸŸé“¾å¾€ä¸ŠæŸ¥æ‰¾</li>
<li>å½“ä¿®æ”¹å­˜åœ¨çš„å˜é‡æ—¶ï¼Œä¼šåŒæ­¥ä¿®æ”¹å¤–å±‚çš„å˜é‡</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–<code>with</code>è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å¼Šç«¯ğŸ‘‰<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/with">è¯¦ç»†äº†è§£</a></p>
<h3 id="es6-proxy">ES6 proxy</h3>
<p>ä¸ºäº†è§£å†³<code>with</code>å­˜åœ¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹<code>proxy</code>æ–¹æ³•ã€‚<code>proxy</code>ç”¨äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†ï¼Œä»è€Œå®ç°å¯¹åŸºæœ¬æ“ä½œçš„æ‹¦æˆªä»¥åŠè‡ªå®šä¹‰ã€‚</p>
<p><strong>åŸºæœ¬è¯­æ³•</strong></p>
<pre><code class="language-jsx">/**
* @param {*} target - ä½¿ç”¨ProxyåŒ…è£…çš„ç›®æ ‡å¯¹è±¡
* @param {*} handler - é€šå¸¸ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„å„ä¸ªå±æ€§åˆ†åˆ«å®šä¹‰äº†æ‰§è¡Œå„ä¸ªæ“ä½œæ—¶çš„ä»£ç†è¡Œä¸º
*/
const p = new Proxy(target, handler)
</code></pre>
<p>ğŸ‘‰<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">è¯¦ç»†äº†è§£</a></p>
<p><strong>æ”¹è¿›æµç¨‹</strong></p>
<p><img alt="Untitled" src="/assets/images/Proxyä»£ç†æµç¨‹å›¾-5eaa9c8e001bc3213837207a6953ec84.png" width="635" height="908"></p>
<p><strong>codeå®ç°</strong></p>
<pre><code class="language-jsx">const obj = {
  a: 1
}
const obj2 = {
  b: 2
}
let b = 3

// ç”¨withæ”¹å˜ä½œç”¨åŸŸ
const withedCode = (code) =&gt; {
  // return (obj)  =&gt; {
  //   with(ctxProxy(obj)){
  //     eval(code)
  //   }
  // }
  code = `with(obj) { ${ code } }`
  const fun = new Function(&#x27;obj&#x27;, code)
  return fun
}

// æ‰§è¡Œä»£ç 
const code = &#x27;console.log(b)&#x27;

// ç™½åå•
const whiteList = [&#x27;console&#x27;, &#x27;b&#x27;]

// // è®¿é—®æ‹¦æˆª
const ctxProxy = (ctx) =&gt; new Proxy(ctx, {
  has: (target, prop) =&gt; { // å½“è¿”å›falseçš„æ—¶å€™ä¼šæ²¿ç€ä½œç”¨åŸŸå‘ä¸ŠæŸ¥æ‰¾ï¼Œtrueä¸ºåœ¨å½“å‰ä½œç”¨åŸŸè¿›è¡ŒæŸ¥æ‰¾
    if(whiteList.includes(prop)) { 
      return false
    }
    if(!target.hasOwnProperty) { 
      throw new Error(`can not find - ${prop}!`)
    }
    return true
  },
})

withedCode(code)(ctxProxy(obj2)) // 3
</code></pre>
<p>æ€è€ƒğŸ¤”ï¼šä¸ºå•¥éœ€è¦æŠŠ<code>console</code>æ·»åŠ åˆ°<code>whiteList</code>ä¸­ï¼Ÿ</p>
<p>Tipsï¼šè¯¥æ¡ˆä¾‹åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæ­£å¸¸ï¼Œåœ¨<code>node</code>ä¸­è¿è¡Œå¯èƒ½å‡ºç°é—®é¢˜ï¼ŒåŸå› æ˜¯ä½¿ç”¨äº†<code>new Function</code>,åˆ›å»ºçš„å‡½æ•°åªèƒ½åœ¨å…¨å±€ä½œç”¨åŸŸä¸­è¿è¡Œï¼Œè€Œåœ¨<code>node</code>ä¸­é¡¶çº§çš„ä½œç”¨åŸŸä¸æ˜¯å…¨å±€ä½œç”¨åŸŸï¼Œå½“å‰å…¨å±€å£°æ˜çš„å˜é‡æ˜¯åœ¨å½“å‰æ¨¡å—çš„ä½œç”¨åŸŸé‡Œçš„ã€‚è¯¦ç»†æŸ¥çœ‹ï¼š<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">Function</a></p>
<p>è¿™æ ·ä¸€ä¸ªç®€å•çš„æ²™ç®±æ˜¯ä¸æ˜¯å®Œæˆäº†ï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä¼šä¸ä¼šæƒ³è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Ÿ</p>
<p>è§£å†³å®Œå¯¹è±¡çš„è®¿é—®æ§åˆ¶ï¼Œæˆ‘ä»¬ç°åœ¨è§£å†³ç¬¬äºŒä¸ªé—®é¢˜å¦‚ä½•æ¨¡æ‹Ÿæµè§ˆå™¨çš„å…¨å±€å¯¹è±¡â€”â€”â€”<code>iframe</code></p>
<p>è¿˜æœ‰äººä¸æ¸…æ¥šä¸ºå•¥éœ€è¦æ¨¡æ‹Ÿæµè§ˆå™¨çš„å¯¹è±¡å—ğŸ¤”ï¼Ÿ</p>
<ul>
<li>ä¸€äº›å…¨å±€å¯¹è±¡æ–¹æ³•çš„ä½¿ç”¨æ¯”å¦‚ä¸Šé¢çš„<code>console.log</code>ç­‰</li>
<li>è·å–å…¨å±€å¯¹è±¡ä¸­çš„ä¸€äº›åˆå§‹å˜é‡</li>
</ul>
<h3 id="with--proxy--iframe">with + proxy + iframe</h3>
<p>æˆ‘ä»¬æŠŠåŸç”Ÿæµè§ˆå™¨çš„å¯¹è±¡å–å‡ºæ¥</p>
<pre><code class="language-jsx">// è®¾ç½®srcä¸ºabout:blankï¼Œä¿è¯æ˜¯åŒåŸŸçš„ï¼Œå› ä¸ºåªæœ‰åŒåŸŸçš„æ‰èƒ½å–å‡ºcontentWindow
const iframe = document.createElement(&#x27;iframe&#x27;, { src:&#x27;about:blank&#x27; })
document.body.append(iframe)
const globalObj = iframe.contentWindow
</code></pre>
<p>åˆ›å»ºä¸€ä¸ªå…¨å±€ä»£ç†å¯¹è±¡çš„ç±»</p>
<pre><code class="language-jsx">class GlobalProxy{
    constructor(shareState) {
        return new Proxy(globalObj, {
            has: (target, prop) =&gt; {
                if(shareState.includes(prop)) {
                    return false
                }
                if(!target.hasOwnProperty(prop)) {
                    throw new Error(`can not find - ${prop}!`)
                }
                return true
            }
        })
    }
}
</code></pre>
<p>å®é™…æ•ˆæœï¼š</p>
<pre><code class="language-jsx">// åˆ›å»ºå…±äº«ç™½åå•
const shareState = []

// åˆ›å»ºä¸€ä¸ªæ²™ç®±å®ä¾‹
const sandBox = new GlobalProxy(shareState)

const withedCode = (code) =&gt; {
    code = `with(obj) { ${ code } }`
    const fun = new Function(&#x27;obj&#x27;, code)
    return fun
}

sandBox.window.abc = 123

// æ‰§è¡Œä»£ç 
const code = &#x27;console.log(window.abc)&#x27;

withedCode(code)(sandBox)
console.log(window.abc)

//------console------
// 123
// undefined
</code></pre>
<h3 id="web-workers">Web Workers</h3>
<p>é€šè¿‡åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æµè§ˆå™¨çº¿ç¨‹æ¥è¾¾åˆ°éš”ç¦»çš„ç›®çš„ï¼Œä½†æ˜¯å…·æœ‰ä¸€å®šçš„å±€é™æ€§</p>
<ul>
<li>ä¸èƒ½ç›´æ¥æ“ä½œ<code>DOM</code>èŠ‚ç‚¹</li>
<li>ä¸èƒ½ä½¿ç”¨window<code>window</code>å¯¹è±¡çš„é»˜è®¤æ–¹æ³•å’Œå±æ€§</li>
</ul>
<p>......</p>
<p>åŸå› åœ¨äº<code>workers</code>è¿è¡Œåœ¨å¦ä¸€ä¸ªå…¨å±€ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸åŒäºå½“å‰çš„windowã€‚</p>
<p>å› æ­¤é€‚ç”¨çš„åœºæ™¯å¤§æ¦‚ç±»ä¼¼äºä¸€äº›è¡¨è¾¾å¼çš„è®¡ç®—ç­‰ã€‚</p>
<p><strong>é€šä¿¡æ–¹å¼</strong></p>
<p>workerså’Œä¸»çº¿ç¨‹ä¹‹é—´é€šè¿‡æ¶ˆæ¯æœºåˆ¶è¿›è¡Œæ•°æ®ä¼ é€’</p>
<ul>
<li><code>postMessage</code>â€”â€”å‘é€æ¶ˆæ¯</li>
<li><code>onmessage</code>â€”â€”å¤„ç†æ¶ˆæ¯</li>
</ul>
<p>æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-jsx">// index.js
window.app = &#x27;æˆ‘æ˜¯å…ƒæ•°æ®&#x27;
const myWorker = new Worker(&#x27;worker.js&#x27;)

myWorker.onmessage = (oEvent) =&gt; {
  console.log(&#x27;Worker said : &#x27; + oEvent.data)
}
myWorker.postMessage(&#x27;æˆ‘æ˜¯ä¸»çº¿ç¨‹ï¼&#x27;)

// worker.js
postMessage(&#x27;æˆ‘æ˜¯å­çº¿ç¨‹ï¼&#x27;);
onmessage = function (oEvent) {
  postMessage(&quot;Hi &quot; + oEvent.data);
	console.log(&#x27;window&#x27;, window)
	console.log(&#x27;DOM&#x27;, document)
}

// -------------console-------------
// Worker said : æˆ‘æ˜¯å­çº¿ç¨‹ï¼
// Worker said : Hi æˆ‘æ˜¯ä¸»çº¿ç¨‹ï¼
// Uncaught ReferenceError: window is not defined
</code></pre>
<p>ğŸ‘‰<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers">è¯¦ç»†äº†è§£</a></p>
<h2 id="æ²™ç®±é€ƒé€¸">æ²™ç®±é€ƒé€¸</h2>
<p>æ²™ç®±é€ƒé€¸å³é€šè¿‡å„ç§æ‰‹æ®µæ‘†è„±æ²™ç®±çš„æŸ  ç¼šï¼Œè®¿é—®æ²™ç®±å¤–çš„å…¨å±€å˜é‡ç”šè‡³æ˜¯ç¯¡æ”¹å®ƒä»¬ï¼Œå®ç°ä¸€ä¸ªæ²™ç®±è¿˜éœ€è¦é¢„é˜²è¿™äº›æƒ…å†µçš„å‘ç”Ÿã€‚</p>
<h3 id="symbolunscopables">Symbol.unscopables</h3>
<p><code>Symbol.unscopables</code>è®¾ç½®äº†<code>true</code>ä¼šå¯¹<code>with</code>è¿›è¡Œæ— è§†ï¼Œæ²¿ç€ä½œç”¨åŸŸè¿›è¡Œå‘ä¸ŠæŸ¥æ‰¾ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-jsx">const obj = {
    a: 1
}

let a = 10

obj[Symbol.unscopables] = {
    a: true
}

with(obj) {
    console.log(a) // 10
}
</code></pre>
<p>æ”¹è¿›ä¸Šè¿°<code>with + proxy + iframe</code>ä¸­çš„å…¨å±€ä»£ç†å¯¹è±¡çš„ç±»</p>
<pre><code class="language-jsx">class GlobalProxy{
    constructor(shareState) {
        return new Proxy(globalObj, {
            has: (target, prop) =&gt; {
                if(shareState.includes(prop)) {
                    return false
                }
                if(!target.hasOwnProperty(prop)) {
                    throw new Error(`can not find - ${prop}!`)
                }
                return true
            },
            get: (target, prop) =&gt; {
								// å¤„ç†Symbol.unscopablesé€ƒé€¸
                if(prop === Symbol.unscopables) return undefined
                return target[prop]
            }
        })
    }
}
</code></pre>
<h3 id="windowparent">window.parent</h3>
<p>å¯ä»¥åœ¨æ²™ç®±çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­é€šè¿‡è¯¥æ–¹æ³•æ‹¿åˆ°å¤–å±‚çš„å…¨å±€å¯¹è±¡</p>
<pre><code class="language-tsx">// è®¾ç½®srcä¸ºabout:blankï¼Œä¿è¯æ˜¯åŒåŸŸçš„ï¼Œå› ä¸ºåªæœ‰åŒåŸŸçš„æ‰èƒ½å–å‡ºcontentWindow
const iframe = document.createElement(&#x27;iframe&#x27;, { src:&#x27;about:blank&#x27; })
document.body.append(iframe)
const globalObj = iframe.contentWindow

class GlobalProxy{
    constructor(shareState) {
        return new Proxy(globalObj, {
            has: (target, prop) =&gt; {
                if(shareState.includes(prop)) {
                    return false
                }
                if(!target.hasOwnProperty(prop)) {
                    throw new Error(`can not find - ${prop}!`)
                }
                return true
            },
            get: (target, prop) =&gt; {
                // å¤„ç†Symbol.unscopablesé€ƒé€¸
                if(prop === Symbol.unscopables) return undefined
                
                return target[prop]
            }
        })
    }
}

// åˆ›å»ºå…±äº«ç™½åå•
const shareState = []

// åˆ›å»ºä¸€ä¸ªæ²™ç®±å®ä¾‹
const sandBox = new GlobalProxy(shareState)

const withedCode = (code) =&gt; {
    code = `with(obj) { ${ code } }`
    const fun = new Function(&#x27;obj&#x27;, code)
    return fun
}

sandBox.window.abc = 123
sandBox.aaa = 789

sandBox[Symbol.unscopables] = {
    aaa: true
}

var aaa = 123

// æ‰§è¡Œä»£ç 
const code = &#x27;console.log(parent.test = 789)&#x27;

withedCode(code)(sandBox)
console.log(window.test) // 789
</code></pre>
<p>æ”¹è¿›æ–¹æ¡ˆ</p>
<pre><code class="language-glsl">get: (target, prop) =&gt; {
    // å¤„ç†Symbol.unscopablesé€ƒé€¸
    if(prop === Symbol.unscopables) return undefined
		// é˜»æ­¢window.parenté€ƒé€¸
    if(prop === &#x27;parent&#x27;) {
        return target
    }
    return target[prop]
}
</code></pre>
<h3 id="åŸå‹é“¾é€ƒé€¸">åŸå‹é“¾é€ƒé€¸</h3>
<p>é€šè¿‡æŸä¸ªå˜é‡çš„åŸå‹é“¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œä»è€Œè¾¾åˆ°ç¯¡æ”¹å…¨å±€å¯¹è±¡çš„ç›®çš„</p>
<pre><code class="language-tsx">const code = `([]).constructor.prototype.toString = () =&gt; {
    return &#x27;Escape!&#x27;
}`

console.log([1,2,3].toString()) // Escape!
</code></pre>
<p>â€¦â€¦</p>
<h2 id="æœªæ¥å¯å°è¯•çš„æ–°æ–¹æ¡ˆ">æœªæ¥å¯å°è¯•çš„æ–°æ–¹æ¡ˆ</h2>
<h3 id="shadowrealms">ShadowRealms</h3>
<p>å®ƒæ˜¯æœªæ¥JSçš„ä¸€é¡¹åŠŸèƒ½ï¼Œç›®å‰å·²ç»è¿›å…¥stage-3ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å…¨å±€ä¸Šä¸‹æ–‡ç¯å¢ƒæ¥æ‰§è¡ŒJSã€‚</p>
<p>å…³äºShadowRealmsçš„æ›´å¤šè¯¦æƒ…ï¼š</p>
<ul>
<li><a href="https://fjolt.com/article/javascript-shadowrealms">https://fjolt.com/article/javascript-shadowrealms</a></li>
<li><a href="https://github.com/tc39/proposal-shadowrealm#APITypeScriptFormat">https://github.com/tc39/proposal-shadowrealm#APITypeScriptFormat</a></li>
</ul>
<h3 id="portals"><strong><strong>Portals</strong></strong></h3>
<p>ç±»ä¼¼äºiframeçš„æ–°æ ‡ç­¾ã€‚</p>
<p>å…³äºportalsçš„æ›´å¤šè¯¦æƒ…</p>
<ul>
<li><a href="https://github.com/WICG/portals/">https://github.com/WICG/portals/</a></li>
</ul>
<h2 id="æ¢ç©¶qiankunä¸­çš„æ²™ç®±">æ¢ç©¶QianKunä¸­çš„æ²™ç®±</h2>
<p>æœ‰äº†ä¸Šé¢çš„çŸ¥è¯†å‚¨å¤‡ä»¥åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹<code>QianKun</code>ä¸­çš„æ²™ç®±æ˜¯æ€ä¹ˆæ ·å­çš„ï¼Œä»¥ä¸‹åªè®²è¿°ä¸€äº›å…³é”®ä»£ç ï¼Œæºç åœ°å€ï¼š<a href="https://github.com/umijs/qiankun/tree/master/src/sandbox">https://github.com/umijs/qiankun/tree/master/src/sandbox</a>ï¼Œç‰ˆæœ¬ä¸º<code>v2.6.3</code></p>
<p>æˆ‘ä»¬è¿›å…¥indexæ–‡ä»¶çœ‹ä¸‹</p>
<pre><code class="language-jsx">// æ˜¯å¦æ”¯æŒProxyä»£ç†
if (window.Proxy) {
  sandbox = useLooseSandbox ? new LegacySandbox(appName, globalContext) : new ProxySandbox(appName, globalContext);
} else {
  sandbox = new SnapshotSandbox(appName);
}
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>QianKun</code>é‡Œçš„æ²™ç®±ä¸»è¦åˆ†ä¸ºä¸‰ç§</p>
<ul>
<li><code>LegacySandbox</code>ï¼šå•å®ä¾‹ä»£ç†æ²™ç®±ï¼Œç®€å•æ¥è®²å°±æ˜¯åªå­˜åœ¨ä¸€ä¸ªwindowå®ä¾‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯å¯¹è¿™ä¸€ä¸ªå®ä¾‹çš„æ“ä½œ</li>
<li><code>ProxySandbox</code>ï¼šå¤šå®ä¾‹ä»£ç†æ²™ç®±ï¼Œé€šè¿‡å¯¹windowçš„æ‹·è´å»ºç«‹å¤šä¸ªå‰¯æœ¬ï¼Œåœ¨æ²™ç®±ä¸­å¯¹å»ºç«‹çš„å‰¯æœ¬è¿›è¡Œæ“ä½œ</li>
<li><code>SnapshotSandbox</code>ï¼šå¿«ç…§æ²™ç®±ï¼ŒåŸºäº diff æ–¹å¼å®ç°çš„æ²™ç®±ï¼Œç”¨äºä¸æ”¯æŒ Proxy çš„ä½ç‰ˆæœ¬æµè§ˆå™¨</li>
</ul>
<h3 id="snapshotsandbox">SnapshotSandbox</h3>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹SnapshotSandboxè¿™ä¸ªæ²™ç®±ï¼Œæºç ï¼š</p>
<pre><code class="language-tsx">// éå†å¯¹è±¡
function iter(obj: typeof window, callbackFn: (prop: any) =&gt; void) {
  for (const prop in obj) {
    if (obj.hasOwnProperty(prop) || prop === &#x27;clearInterval&#x27;) {
      callbackFn(prop);
    }
  }
}

/**
 * åŸºäº diff æ–¹å¼å®ç°çš„æ²™ç®±ï¼Œç”¨äºä¸æ”¯æŒ Proxy çš„ä½ç‰ˆæœ¬æµè§ˆå™¨
 */
export default class SnapshotSandbox implements SandBox {
  proxy: WindowProxy;

  name: string;

  type: SandBoxType;

  sandboxRunning = true;

  private windowSnapshot!: Window;

  private modifyPropsMap: Record&lt;any, any&gt; = {};

  constructor(name: string) {
    this.name = name;
    this.proxy = window;
    this.type = SandBoxType.Snapshot;
  }

  active() {
    // è®°å½•å½“å‰å¿«ç…§
    this.windowSnapshot = {} as Window;
    iter(window, (prop) =&gt; {
      this.windowSnapshot[prop] = window[prop];
    });

    // æ¢å¤ä¹‹å‰çš„å˜æ›´
    Object.keys(this.modifyPropsMap).forEach((p: any) =&gt; {
      window[p] = this.modifyPropsMap[p];
    });

    this.sandboxRunning = true;
  }

  inactive() {
    this.modifyPropsMap = {};

    iter(window, (prop) =&gt; {
      if (window[prop] !== this.windowSnapshot[prop]) {
        // è®°å½•å˜æ›´ï¼Œæ¢å¤ç¯å¢ƒ
        this.modifyPropsMap[prop] = window[prop];
        window[prop] = this.windowSnapshot[prop];
      }
    });

    if (process.env.NODE_ENV === &#x27;development&#x27;) {
      console.info(`[qiankun:sandbox] ${this.name} origin window restore...`, Object.keys(this.modifyPropsMap));
    }

    this.sandboxRunning = false;
  }
}
</code></pre>
<p>ç»“åˆæµç¨‹å›¾</p>
<p><img alt="Untitled" src="/assets/images/SnapshotSandbox-806ca8dfc2329b5395b602c87c83b7a6.png" width="842" height="680"></p>
<p>åˆ†å—è§£è¯»ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠå®ƒåˆ†æˆä¸¤å—æ¥çœ‹</p>
<p><strong>æ¿€æ´»æ—¶</strong></p>
<pre><code class="language-jsx">active() {
  this.windowSnapshot = {} as Window;
  iter(window, (prop) =&gt; { // é€šè¿‡éå†çš„æ–¹å¼è®°å½•å½“å‰windowçš„çŠ¶æ€ï¼Œå³windowçš„å½“å‰å¿«ç…§
    this.windowSnapshot[prop] = window[prop];
  });

  Object.keys(this.modifyPropsMap).forEach((p: any) =&gt; { // 
    window[p] = this.modifyPropsMap[p]; // é€šè¿‡éå†æ¢å¤ä¸Šä¸€æ¬¡å¤±æ´»æ—¶çš„å˜æ›´
  });

  this.sandboxRunning = true;
}
</code></pre>
<p><strong>å¤±æ´»æ—¶</strong></p>
<pre><code class="language-jsx">inactive() {
  this.modifyPropsMap = {}; 

  iter(window, (prop) =&gt; { // éå†windowä¸Šçš„å±æ€§
    if (window[prop] !== this.windowSnapshot[prop]) {
      this.modifyPropsMap[prop] = window[prop]; // è®°å½•å’Œå¿«ç…§ä¸ä¸€è‡´çš„å±æ€§åˆ°ä¿®æ”¹çš„å¯¹è±¡ä¸­
      window[prop] = this.windowSnapshot[prop]; // æ¢å¤windowçš„å±æ€§ä¸ºåˆå§‹çš„å±æ€§
    }
  });

  this.sandboxRunning = false;
}
</code></pre>
<p><code>SnapshotSandbox</code>æ¯”è¾ƒç®€å•ï¼Œç”±äºä¸æ”¯æŒä»£ç†ï¼Œæ‰€æœ‰çš„æ›´æ”¹éƒ½åœ¨<code>window</code>ä¸Šï¼Œåªæ˜¯åœ¨æ¿€æ´»æ²™ç®±çš„æ—¶å€™ä¿å­˜ä¸€ä¸ª<code>window</code>çš„åˆå§‹å¿«ç…§ï¼Œå¹¶åœ¨æœŸé—´å¯¹å˜æ›´çš„å±æ€§è¿›è¡Œè®°å½•ï¼Œå¤±æ´»æ—¶æ¢å¤åˆå§‹çš„<code>window</code>ï¼Œä½†æ˜¯ä¼šé€ æˆå…¨å±€<code>window</code>çš„æ±¡æŸ“</p>
<h3 id="legacysandbox">LegacySandbox</h3>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹LegacySandboxæ²™ç®±ï¼Œè¯¥æ²™ç®±åŸºäºProxyå®ç°çš„</p>
<p><strong>æµç¨‹å›¾</strong></p>
<p><img alt="Untitled" src="/assets/images/LegacySandbox-5dceade07c3c0052c684f67d9f48a97a.png" width="790" height="867"></p>
<p>æºç éƒ¨åˆ†</p>
<pre><code class="language-tsx">// åˆ¤æ–­å¯¹è±¡ä¸Šçš„æŸä¸ªå±æ€§æè¿°æ˜¯å¦æ˜¯å¯æ›´æ”¹æˆ–è€…æ˜¯å¯åˆ é™¤çš„
function isPropConfigurable(target: WindowProxy, prop: PropertyKey) {
  const descriptor = Object.getOwnPropertyDescriptor(target, prop);
  return descriptor ? descriptor.configurable : true;
}

/**
 * åŸºäº Proxy å®ç°çš„æ²™ç®±
 * TODO: ä¸ºäº†å…¼å®¹æ€§ singular æ¨¡å¼ä¸‹ä¾æ—§ä½¿ç”¨è¯¥æ²™ç®±ï¼Œç­‰æ–°æ²™ç®±ç¨³å®šä¹‹åå†åˆ‡æ¢
 */
export default class LegacySandbox implements SandBox {
  /** æ²™ç®±æœŸé—´æ–°å¢çš„å…¨å±€å˜é‡ */
  private addedPropsMapInSandbox = new Map&lt;PropertyKey, any&gt;();

  /** æ²™ç®±æœŸé—´æ›´æ–°çš„å…¨å±€å˜é‡ */
  private modifiedPropsOriginalValueMapInSandbox = new Map&lt;PropertyKey, any&gt;();

  /** æŒç»­è®°å½•æ›´æ–°çš„(æ–°å¢å’Œä¿®æ”¹çš„)å…¨å±€å˜é‡çš„ mapï¼Œç”¨äºåœ¨ä»»æ„æ—¶åˆ»åš snapshot */
  private currentUpdatedPropsValueMap = new Map&lt;PropertyKey, any&gt;();

  name: string;

  proxy: WindowProxy;

  globalContext: typeof window;

  type: SandBoxType;

  sandboxRunning = true;

  latestSetProp: PropertyKey | null = null;

	// è®¾ç½®globalContextå¯¹è±¡ä¸Šçš„å±æ€§
  private setWindowProp(prop: PropertyKey, value: any, toDelete?: boolean) {
    if (value === undefined &amp;&amp; toDelete) {
      delete (this.globalContext as any)[prop];
    } else if (isPropConfigurable(this.globalContext, prop) &amp;&amp; typeof prop !== &#x27;symbol&#x27;) {
      Object.defineProperty(this.globalContext, prop, { writable: true, configurable: true });
      (this.globalContext as any)[prop] = value;
    }
  }

  active() {
    if (!this.sandboxRunning) {
      this.currentUpdatedPropsValueMap.forEach((v, p) =&gt; this.setWindowProp(p, v));
    }

    this.sandboxRunning = true;
  }

  inactive() {
    this.modifiedPropsOriginalValueMapInSandbox.forEach((v, p) =&gt; this.setWindowProp(p, v));
    this.addedPropsMapInSandbox.forEach((_, p) =&gt; this.setWindowProp(p, undefined, true));

    this.sandboxRunning = false;
  }

  constructor(name: string, globalContext = window) {
    this.name = name;
    this.globalContext = globalContext;
    this.type = SandBoxType.LegacyProxy;
    const { addedPropsMapInSandbox, modifiedPropsOriginalValueMapInSandbox, currentUpdatedPropsValueMap } = this;

    const rawWindow = globalContext;
    const fakeWindow = Object.create(null) as Window;

    const setTrap = (p: PropertyKey, value: any, originalValue: any, sync2Window = true) =&gt; {
      if (this.sandboxRunning) {
        if (!rawWindow.hasOwnProperty(p)) {
          addedPropsMapInSandbox.set(p, value);
        } else if (!modifiedPropsOriginalValueMapInSandbox.has(p)) {
          // å¦‚æœå½“å‰ window å¯¹è±¡å­˜åœ¨è¯¥å±æ€§ï¼Œä¸” record map ä¸­æœªè®°å½•è¿‡ï¼Œåˆ™è®°å½•è¯¥å±æ€§åˆå§‹å€¼
          modifiedPropsOriginalValueMapInSandbox.set(p, originalValue);
        }

        currentUpdatedPropsValueMap.set(p, value);

        if (sync2Window) {
          // å¿…é¡»é‡æ–°è®¾ç½® window å¯¹è±¡ä¿è¯ä¸‹æ¬¡ get æ—¶èƒ½æ‹¿åˆ°å·²æ›´æ–°çš„æ•°æ®
          (rawWindow as any)[p] = value;
        }

        this.latestSetProp = p;

        return true;
      }

      // åœ¨ strict-mode ä¸‹ï¼ŒProxy çš„ handler.set è¿”å› false ä¼šæŠ›å‡º TypeErrorï¼Œåœ¨æ²™ç®±å¸è½½çš„æƒ…å†µä¸‹åº”è¯¥å¿½ç•¥é”™è¯¯
      return true;
    };

    const proxy = new Proxy(fakeWindow, {
      set: (_: Window, p: PropertyKey, value: any): boolean =&gt; {
        const originalValue = (rawWindow as any)[p];
        return setTrap(p, value, originalValue, true);
      },

      get(_: Window, p: PropertyKey): any {
        // avoid who using window.window or window.self to escape the sandbox environment to touch the really window
        // or use window.top to check if an iframe context
        // see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13
        if (p === &#x27;top&#x27; || p === &#x27;parent&#x27; || p === &#x27;window&#x27; || p === &#x27;self&#x27;) {
          return proxy;
        }

        const value = (rawWindow as any)[p];
        return getTargetValue(rawWindow, value);
      },

      // trap in operator
      // see https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/constants.js#L12
      has(_: Window, p: string | number | symbol): boolean {
        return p in rawWindow;
      },

      getOwnPropertyDescriptor(_: Window, p: PropertyKey): PropertyDescriptor | undefined {
        const descriptor = Object.getOwnPropertyDescriptor(rawWindow, p);
        // A property cannot be reported as non-configurable, if it does not exists as an own property of the target object
        if (descriptor &amp;&amp; !descriptor.configurable) {
          descriptor.configurable = true;
        }
        return descriptor;
      },

      defineProperty(_: Window, p: string | symbol, attributes: PropertyDescriptor): boolean {
        const originalValue = (rawWindow as any)[p];
        const done = Reflect.defineProperty(rawWindow, p, attributes);
        const value = (rawWindow as any)[p];
        setTrap(p, value, originalValue, false);

        return done;
      },
    });

    this.proxy = proxy;
  }
}
</code></pre>
<p>åŒæ ·çš„æˆ‘ä»¬æ¥åˆ†å—è§£è¯»ä¸€ä¸‹</p>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªä¸»è¦çš„å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“ä¸‹</p>
<pre><code class="language-tsx">/** æ²™ç®±æœŸé—´æ–°å¢çš„å…¨å±€å˜é‡ */
private addedPropsMapInSandbox = new Map&lt;PropertyKey, any&gt;();

/** æ²™ç®±æœŸé—´æ›´æ–°çš„å…¨å±€å˜é‡,è®°å½•çš„æ˜¯æ¿€æ´»å­åº”ç”¨æ—¶windowä¸Šçš„åˆå§‹å€¼ */
private modifiedPropsOriginalValueMapInSandbox = new Map&lt;PropertyKey, any&gt;();

/** æŒç»­è®°å½•æ›´æ–°çš„(æ–°å¢å’Œä¿®æ”¹çš„)å…¨å±€å˜é‡çš„ mapï¼Œç”¨äºåœ¨ä»»æ„æ—¶åˆ»åš snapshot */
private currentUpdatedPropsValueMap = new Map&lt;PropertyKey, any&gt;();

// ç™½åå•ï¼Œæ˜¯å¾®åº”ç”¨ä¹‹é—´å…¨å±€å…±äº«çš„å˜é‡
const variableWhiteList: PropertyKey[] = [
  &#x27;System&#x27;,
  &#x27;__cjsWrapper&#x27;,
  ...variableWhiteListInDev,
]
</code></pre>
<p><strong>æ¿€æ´»æ—¶</strong></p>
<pre><code class="language-jsx">active() {
  if (!this.sandboxRunning) {
		// æŠŠä¸Šä¸€æ¬¡æ²™ç®±æ¿€æ´»æ—¶çš„å˜æ›´ï¼Œè®¾ç½®åˆ°windowä¸Š
    this.currentUpdatedPropsValueMap.forEach((v, p) =&gt; this.setWindowProp(p, v));
  }
  this.sandboxRunning = true;
}
</code></pre>
<p><strong>å¤±æ´»æ—¶</strong></p>
<pre><code class="language-jsx">inactive() {
  ...
	// é€šè¿‡éå†è¿˜åŸwindowä¸Šçš„åˆå§‹å€¼
  this.modifiedPropsOriginalValueMapInSandbox.forEach((v, p) =&gt; this.setWindowProp(p, v));
	// é€šè¿‡å¯¹æ–°å¢å±çš„éå†ï¼Œå»é™¤windowä¸Šæ–°å¢çš„å±æ€§
	this.addedPropsMapInSandbox.forEach((_, p) =&gt; this.setWindowProp(p, undefined, true));
  this.sandboxRunning = false;
}
</code></pre>
<p><strong>Proxyä»£ç†</strong></p>
<pre><code class="language-tsx">const proxy = new Proxy(fakeWindow, {
	set: (_: Window, p: PropertyKey, value: any): boolean =&gt; {
	  const originalValue = (rawWindow as any)[p];
		// æŠŠå˜æ›´çš„å±æ€§åŒæ­¥åˆ°addedPropsMapInSandboxã€modifiedPropsOriginalValueMapInSandboxä»¥åŠcurrentUpdatedPropsValueMap
	  return setTrap(p, value, originalValue, true);
	},
	
	get(_: Window, p: PropertyKey): any {
		// é˜²æ­¢é€šè¿‡ä½¿ç”¨topã€parentã€windowã€selfè®¿é—®å¤–å±‚çœŸå®çš„ç¯å¢ƒ
	  if (p === &#x27;top&#x27; || p === &#x27;parent&#x27; || p === &#x27;window&#x27; || p === &#x27;self&#x27;) {
	    return proxy;
	  }
	
	  const value = (rawWindow as any)[p];
		//ä¸€äº›å¼‚å¸¸å¤„ç†è·å–valueçš„çœŸå®å€¼ï¼Œä¸»è¦å¤„ç†äº†window.consoleã€window.atobè¿™ç±»APIåœ¨å¾®åº”ç”¨ä¸­è°ƒç”¨æ—¶ä¼šæŠ›å‡º Illegal invocationå¼‚å¸¸çš„é—®é¢˜
	  return getTargetValue(rawWindow, value);
	},
	
	has(_: Window, p: string | number | symbol): boolean {
		// è®¿é—®çš„å±æ€§æ˜¯å¦åœ¨rawWindowä¸Šï¼Œä¸åœ¨è¿”å›falseæ²¿ç€ä½œç”¨åŸŸå‘ä¸ŠæŸ¥æ‰¾
	  return p in rawWindow;
	},
	
	// æ‹¦æˆªå¯¹è±¡çš„Object.getOwnPropertyDescriptor()æ“ä½œ
	getOwnPropertyDescriptor(_: Window, p: PropertyKey): PropertyDescriptor | undefined {
	  const descriptor = Object.getOwnPropertyDescriptor(rawWindow, p);
	  // A property cannot be reported as non-configurable, if it does not exists as an own property of the target object
	  if (descriptor &amp;&amp; !descriptor.configurable) {
	    descriptor.configurable = true;
	  }
	  return descriptor;
	},
	
	// æ‹¦æˆªå¯¹è±¡çš„Object.defineProperty()æ“ä½œ
	defineProperty(_: Window, p: string | symbol, attributes: PropertyDescriptor): boolean {
	  const originalValue = (rawWindow as any)[p];
	  const done = Reflect.defineProperty(rawWindow, p, attributes);
	  const value = (rawWindow as any)[p];
	  setTrap(p, value, originalValue, false); // å˜æ›´å±æ€§è®°å½•
	
	  return done;
	},
});

const setTrap = (p: PropertyKey, value: any, originalValue: any, sync2Window = true) =&gt; {
  if (this.sandboxRunning) {
		// åˆ¤æ–­æ˜¯å¦ä¸ºrawWindowè‡ªå·±çš„å±æ€§
    if (!rawWindow.hasOwnProperty(p)) {
			// æ–°å¢çš„å±æ€§å­˜å…¥addedPropsMapInSandbox
      addedPropsMapInSandbox.set(p, value);
    } else if (!modifiedPropsOriginalValueMapInSandbox.has(p)) {
      // ä¿®æ”¹çš„å±æ€§æŠŠåˆå§‹å€¼å­˜å…¥modifiedPropsOriginalValueMapInSandboxä¸­
      modifiedPropsOriginalValueMapInSandbox.set(p, originalValue);
    }
		
		// å½“å‰æ•°æ®çš„æ‰€æœ‰å˜æ›´è®°å½•åœ¨currentUpdatedPropsValueMapä¸­
    currentUpdatedPropsValueMap.set(p, value);

    if (sync2Window) {
      // å¿…é¡»é‡æ–°è®¾ç½® window å¯¹è±¡ä¿è¯ä¸‹æ¬¡ get æ—¶èƒ½æ‹¿åˆ°å·²æ›´æ–°çš„æ•°æ®
      (rawWindow as any)[p] = value;
    }

    this.latestSetProp = p;

    return true;
  }

  // åœ¨ strict-mode ä¸‹ï¼ŒProxy çš„ handler.set è¿”å› false ä¼šæŠ›å‡º TypeErrorï¼Œåœ¨æ²™ç®±å¸è½½çš„æƒ…å†µä¸‹åº”è¯¥å¿½ç•¥é”™è¯¯
  return true;
}
</code></pre>
<p>ä»ç„¶æ˜¯æ“ä½œwindowå¯¹è±¡ï¼Œä¼šé€ æˆå…¨å±€windowçš„æ±¡æŸ“ï¼Œä½†æ˜¯ä¸éœ€è¦è®°å½•windowçš„åˆå§‹å¿«ç…§ï¼Œä¹Ÿä¸éœ€è¦å¯¹windowè¿›è¡Œè‡ªèº«å±æ€§çš„æ•´ä¸ªéå†ç›¸æ¯”äºdiffå¿«ç…§æ•ˆç‡ä¼šé«˜ç‚¹ï¼Œæ€§èƒ½ä¼šå¥½ç‚¹ã€‚</p>
<h3 id="proxysandbox">ProxySandbox</h3>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹ProxySandboxè¿™ä¸ªæ²™ç®±ï¼Œè¯¥æ²™ç®±é€šè¿‡åˆ›å»ºä¸€ä¸ªwindowçš„å‰¯æœ¬<code>fakeWindow</code>å®ç°æ¯ä¸ª<code>ProxySandbox</code>å®ä¾‹ä¹‹é—´å±æ€§äº’ä¸å½±å“</p>
<p>æµç¨‹å›¾</p>
<p><img alt="Untitled" src="/assets/images/ProxySandbox-06cd75d2663e014c96ae997b23e3386d.png" width="1120" height="1164"></p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªwindowå‰¯æœ¬<code>fakeWindow</code>å’Œ<code>propertiesWithGetter</code>,åä¸€ä¸ªæ˜¯ç”¨æ¥è®°å½•æœ‰<code>getter</code>ä¸”ä¸å¯é…ç½®çš„Mapå¯¹è±¡ï¼Œå¤§æ¦‚åŒ…æ‹¬<code>window</code>ã€<code>document</code>ã€<code>location</code>ã€<code>top</code>ç­‰ï¼Œè¿™äº›å±æ€§æ‹·è´ä»¥åä¼šæˆä¸ºéæ³•è°ƒç”¨çš„å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»<code>globalContext</code>ä¸Šè¿›è¡Œè®¿é—®ï¼Œå…·ä½“å®ç°å‚è€ƒ<code>proxy</code>ä¸­çš„getéƒ¨åˆ†</p>
<pre><code class="language-tsx">function createFakeWindow(globalContext: Window) {
	// è®°å½• window å¯¹è±¡ä¸Šçš„ get å±æ€§ï¼ŒåŸç”Ÿçš„æœ‰ï¼šwindowã€documentã€locationã€top
  const propertiesWithGetter = new Map&lt;PropertyKey, boolean&gt;();
  const fakeWindow = {} as FakeWindow;

  Object.getOwnPropertyNames(globalContext)
		// éå†å‡ºwindowä¸Šæ‰€æœ‰ä¸å¯é…ç½®çš„å±æ€§
    .filter((p) =&gt; {
      const descriptor = Object.getOwnPropertyDescriptor(globalContext, p);
      return !descriptor?.configurable;
    })
    .forEach((p) =&gt; {
			// è·å–å±æ€§æè¿°ç¬¦
      const descriptor = Object.getOwnPropertyDescriptor(globalContext, p);
      if (descriptor) {
        const hasGetter = Object.prototype.hasOwnProperty.call(descriptor, &#x27;get&#x27;);

        if (
          p === &#x27;top&#x27; ||
          p === &#x27;parent&#x27; ||
          p === &#x27;self&#x27; ||
          p === &#x27;window&#x27; ||
          (process.env.NODE_ENV === &#x27;test&#x27; &amp;&amp; (p === &#x27;mockTop&#x27; || p === &#x27;mockSafariTop&#x27;))
        ) {
          descriptor.configurable = true;
          
          if (!hasGetter) {
            descriptor.writable = true;
          }
        }

        // æŠŠæœ‰getå±æ€§çš„è®°å½•åˆ°propertiesWithGetter Mapå¯¹è±¡ä¸­
        if (hasGetter) propertiesWithGetter.set(p, true);
				// å†»ç»“æŸä¸ªå±æ€§ï¼Œå†»ç»“ä»¥åè¯¥å±æ€§ä¸å¯ä¿®æ”¹
        rawObjectDefineProperty(fakeWindow, p, Object.freeze(descriptor));
      }
    });

  return {
    fakeWindow,
    propertiesWithGetter,
  };
}
</code></pre>
<p>ProxySandboxæ²™ç®±æºç ï¼š</p>
<pre><code class="language-tsx">export default class ProxySandbox implements SandBox {
  /** window å€¼å˜æ›´è®°å½• */
  private updatedValueSet = new Set&lt;PropertyKey&gt;();

  name: string;

  type: SandBoxType;

  proxy: WindowProxy;

  globalContext: typeof window;

  sandboxRunning = true;

  latestSetProp: PropertyKey | null = null;

  private registerRunningApp(name: string, proxy: Window) {
    if (this.sandboxRunning) {
      const currentRunningApp = getCurrentRunningApp();
      if (!currentRunningApp || currentRunningApp.name !== name) {
        setCurrentRunningApp({ name, window: proxy });
      }
      // FIXME if you have any other good ideas
      // remove the mark in next tick, thus we can identify whether it in micro app or not
      // this approach is just a workaround, it could not cover all complex cases, such as the micro app runs in the same task context with master in some case
      nextTask(() =&gt; {
        setCurrentRunningApp(null);
      });
    }
  }

  active() {
    if (!this.sandboxRunning) activeSandboxCount++;
    this.sandboxRunning = true;
  }

  inactive() {
    if (--activeSandboxCount === 0) {
      variableWhiteList.forEach((p) =&gt; {
        if (this.proxy.hasOwnProperty(p)) {
          // @ts-ignore
          delete this.globalContext[p];
        }
      });
    }

    this.sandboxRunning = false;
  }

  constructor(name: string, globalContext = window) {
    this.name = name;
    this.globalContext = globalContext;
    this.type = SandBoxType.Proxy;
    const { updatedValueSet } = this;

    const { fakeWindow, propertiesWithGetter } = createFakeWindow(globalContext);

    const descriptorTargetMap = new Map&lt;PropertyKey, SymbolTarget&gt;();
    const hasOwnProperty = (key: PropertyKey) =&gt; fakeWindow.hasOwnProperty(key) || globalContext.hasOwnProperty(key);

    const proxy = new Proxy(fakeWindow, {
      set: (target: FakeWindow, p: PropertyKey, value: any): boolean =&gt; {
        if (this.sandboxRunning) {
          this.registerRunningApp(name, proxy);
          // We must kept its description while the property existed in globalContext before
          if (!target.hasOwnProperty(p) &amp;&amp; globalContext.hasOwnProperty(p)) {
            const descriptor = Object.getOwnPropertyDescriptor(globalContext, p);
            const { writable, configurable, enumerable } = descriptor!;
            if (writable) {
              Object.defineProperty(target, p, {
                configurable,
                enumerable,
                writable,
                value,
              });
            }
          } else {
            // @ts-ignore
            target[p] = value;
          }

          if (variableWhiteList.indexOf(p) !== -1) {
            // @ts-ignore
            globalContext[p] = value;
          }

          updatedValueSet.add(p);

          this.latestSetProp = p;

          return true;
        }

        // åœ¨ strict-mode ä¸‹ï¼ŒProxy çš„ handler.set è¿”å› false ä¼šæŠ›å‡º TypeErrorï¼Œåœ¨æ²™ç®±å¸è½½çš„æƒ…å†µä¸‹åº”è¯¥å¿½ç•¥é”™è¯¯
        return true;
      },

      get: (target: FakeWindow, p: PropertyKey): any =&gt; {
        this.registerRunningApp(name, proxy);

        if (p === Symbol.unscopables) return unscopables;
        // avoid who using window.window or window.self to escape the sandbox environment to touch the really window
        // see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13
        if (p === &#x27;window&#x27; || p === &#x27;self&#x27;) {
          return proxy;
        }

        // hijack globalWindow accessing with globalThis keyword
        if (p === &#x27;globalThis&#x27;) {
          return proxy;
        }

        if (
          p === &#x27;top&#x27; ||
          p === &#x27;parent&#x27; ||
          (process.env.NODE_ENV === &#x27;test&#x27; &amp;&amp; (p === &#x27;mockTop&#x27; || p === &#x27;mockSafariTop&#x27;))
        ) {
          // if your master app in an iframe context, allow these props escape the sandbox
          if (globalContext === globalContext.parent) {
            return proxy;
          }
          return (globalContext as any)[p];
        }

        // proxy.hasOwnProperty would invoke getter firstly, then its value represented as globalContext.hasOwnProperty
        if (p === &#x27;hasOwnProperty&#x27;) {
          return hasOwnProperty;
        }

        if (p === &#x27;document&#x27;) {
          return document;
        }

        if (p === &#x27;eval&#x27;) {
          return eval;
        }

        const value = propertiesWithGetter.has(p)
          ? (globalContext as any)[p]
          : p in target
          ? (target as any)[p]
          : (globalContext as any)[p];
        /* Some dom api must be bound to native window, otherwise it would cause exception like &#x27;TypeError: Failed to execute &#x27;fetch&#x27; on &#x27;Window&#x27;: Illegal invocation&#x27;
           See this code:
             const proxy = new Proxy(window, {});
             const proxyFetch = fetch.bind(proxy);
             proxyFetch(&#x27;https://qiankun.com&#x27;);
        */
        const boundTarget = useNativeWindowForBindingsProps.get(p) ? nativeGlobal : globalContext;
        return getTargetValue(boundTarget, value);
      },

      // trap in operator
      // see https://github.com/styled-components/styled-components/blob/master/packages/styled-components/src/constants.js#L12
      has(target: FakeWindow, p: string | number | symbol): boolean {
        return p in unscopables || p in target || p in globalContext;
      },

      getOwnPropertyDescriptor(target: FakeWindow, p: string | number | symbol): PropertyDescriptor | undefined {
        /*
         as the descriptor of top/self/window/mockTop in raw window are configurable but not in proxy target, we need to get it from target to avoid TypeError
         see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor
         &gt; A property cannot be reported as non-configurable, if it does not exists as an own property of the target object or if it exists as a configurable own property of the target object.
         */
        if (target.hasOwnProperty(p)) {
          const descriptor = Object.getOwnPropertyDescriptor(target, p);
          descriptorTargetMap.set(p, &#x27;target&#x27;);
          return descriptor;
        }

        if (globalContext.hasOwnProperty(p)) {
          const descriptor = Object.getOwnPropertyDescriptor(globalContext, p);
          descriptorTargetMap.set(p, &#x27;globalContext&#x27;);
          // A property cannot be reported as non-configurable, if it does not exists as an own property of the target object
          if (descriptor &amp;&amp; !descriptor.configurable) {
            descriptor.configurable = true;
          }
          return descriptor;
        }

        return undefined;
      },

      // trap to support iterator with sandbox
      ownKeys(target: FakeWindow): ArrayLike&lt;string | symbol&gt; {
        return uniq(Reflect.ownKeys(globalContext).concat(Reflect.ownKeys(target)));
      },

      defineProperty(target: Window, p: PropertyKey, attributes: PropertyDescriptor): boolean {
        const from = descriptorTargetMap.get(p);
        /*
         Descriptor must be defined to native window while it comes from native window via Object.getOwnPropertyDescriptor(window, p),
         otherwise it would cause a TypeError with illegal invocation.
         */
        switch (from) {
          case &#x27;globalContext&#x27;:
            return Reflect.defineProperty(globalContext, p, attributes);
          default:
            return Reflect.defineProperty(target, p, attributes);
        }
      },

      deleteProperty: (target: FakeWindow, p: string | number | symbol): boolean =&gt; {
        this.registerRunningApp(name, proxy);
        if (target.hasOwnProperty(p)) {
          // @ts-ignore
          delete target[p];
          updatedValueSet.delete(p);

          return true;
        }

        return true;
      },

      // makes sure `window instanceof Window` returns truthy in micro app
      getPrototypeOf() {
        return Reflect.getPrototypeOf(globalContext);
      },
    });

    this.proxy = proxy;

    activeSandboxCount++;
  }
}
</code></pre>
<p>åŒæ ·æˆ‘ä»¬æŠŠå®ƒåˆ†æˆå‡ å—æ¥ç†è§£<strong>æ¿€æ´»æ—¶</strong></p>
<pre><code class="language-tsx">active() {
	// è®°å½•æ¿€æ´»æ²™ç®±çš„æ•°é‡
  if (!this.sandboxRunning) activeSandboxCount++;
  this.sandboxRunning = true;
}
</code></pre>
<p><strong>å¤±æ´»æ—¶</strong></p>
<pre><code class="language-tsx">inactive() {
  ...
  if (--activeSandboxCount === 0) {
		// variableWhiteListè®°å½•äº†ç™½åå•å±æ€§ï¼Œéœ€è¦åœ¨æ²™ç®±å…¨éƒ¨å¤±æ´»æ—¶è¿›è¡Œå±æ€§çš„åˆ é™¤
    variableWhiteList.forEach((p) =&gt; {
      if (this.proxy.hasOwnProperty(p)) {
        delete this.globalContext[p];
      }
    });
  }

  this.sandboxRunning = false;
}
</code></pre>
<p><strong>Proxyä»£ç†</strong></p>
<p>setéƒ¨åˆ†</p>
<pre><code class="language-tsx">set: (target: FakeWindow, p: PropertyKey, value: any): boolean =&gt; {
    if (this.sandboxRunning) {
			// è®°å½•å½“å‰è¿è¡Œçš„å¾®åº”ç”¨
      this.registerRunningApp(name, proxy);
      // å½“å‰targetä¸å­˜åœ¨ï¼Œä½†æ˜¯globalContextä¸­å­˜åœ¨è¿›è¡Œèµ‹å€¼
      if (!target.hasOwnProperty(p) &amp;&amp; globalContext.hasOwnProperty(p)) {
        const descriptor = Object.getOwnPropertyDescriptor(globalContext, p);
        const { writable, configurable, enumerable } = descriptor!;
        // åˆ¤æ–­æ˜¯å¦å¯å†™å…¥ï¼Œå†™å…¥targetå³fakeWindowä¸­
				if (writable) {
          Object.defineProperty(target, p, {
            configurable,
            enumerable,
            writable,
            value,
          });
        }
      } else {
        target[p] = value;
      }

			// å¦‚æœåœ¨ç™½åå•ä¸­ç›´æ¥åœ¨å…¨å±€èµ‹å€¼
      if (variableWhiteList.indexOf(p) !== -1) {
        globalContext[p] = value;
      }
			// å˜æ›´è®°å½•
      updatedValueSet.add(p); 
      this.latestSetProp = p;
      return true;
    }
    ...
    return true;
 },
</code></pre>
<p>getéƒ¨åˆ†</p>
<pre><code class="language-tsx">get: (target: FakeWindow, p: PropertyKey): any =&gt; {
        this.registerRunningApp(name, proxy);
				// é˜²æ­¢é€ƒé€¸ï¼Œå¯¹ä¸åŒæƒ…å†µè¿›è¡Œå¤„ç†
        if (p === Symbol.unscopables) return unscopables;
        if (p === &#x27;window&#x27; || p === &#x27;self&#x27;) {
          return proxy;
        }

        if (p === &#x27;globalThis&#x27;) {
          return proxy;
        }

        if (
          p === &#x27;top&#x27; ||
          p === &#x27;parent&#x27; ||
          (process.env.NODE_ENV === &#x27;test&#x27; &amp;&amp; (p === &#x27;mockTop&#x27; || p === &#x27;mockSafariTop&#x27;))
        ) {
          if (globalContext === globalContext.parent) {
            return proxy;
          }
          return (globalContext as any)[p];
        }

        if (p === &#x27;hasOwnProperty&#x27;) {
          return hasOwnProperty;
        }

				// ç›´æ¥è¿”å›document
        if (p === &#x27;document&#x27;) {
          return document;
        }
				
				//ç›´æ¥è¿”å›eval
        if (p === &#x27;eval&#x27;) {
          return eval;
        }
				//ä¸€äº›å¼‚å¸¸å¤„ç†è·å–valueçš„çœŸå®å€¼ï¼Œç”±äºæŸäº›å¯¹è±¡åœ¨fakeWindowä¸Šè®¿é—®ä¼šå‡ºç°éæ³•è°ƒç”¨çš„æƒ…å†µï¼Œå› æ­¤éœ€è¦åœ¨globalContextä¸Šè®¿é—®
        const value = propertiesWithGetter.has(p)
          ? (globalContext as any)[p]
          : p in target
          ? (target as any)[p]
          : (globalContext as any)[p];
        
        const boundTarget = useNativeWindowForBindingsProps.get(p) ? nativeGlobal : globalContext;
        return getTargetValue(boundTarget, value);
      }
</code></pre>
<p>å…¶ä»–æ“ä½œçš„ä¸€äº›å…¼å®¹æ€§å¤„ç†ï¼Œè¿›ä¸€æ­¥ä¿è¯äº†æ²™ç®±çš„å®‰å…¨</p>
<pre><code class="language-tsx">has(target: FakeWindow, p: string | number | symbol): boolean {...},
getOwnPropertyDescriptor(target: FakeWindow, p: string | number | symbol): PropertyDescriptor | undefined {...},
ownKeys(target: FakeWindow): ArrayLike&lt;string | symbol&gt; {...},
defineProperty(target: Window, p: PropertyKey, attributes: PropertyDescriptor): boolean {...},
deleteProperty: (target: FakeWindow, p: string | number | symbol): boolean =&gt; {...},
getPrototypeOf() {...}
</code></pre>
<p>è¯¥æ¨¡å¼æœ€å…·ä¼˜åŠ¿çš„ä¸€ç‚¹æ˜¯æ“ä½œåŸºäºwindowä¸Šæ‹·è´çš„å‰¯æœ¬FakeWindowï¼Œä»è€Œä¿è¯äº†å¤šä¸ªæ²™ç®±å®ä¾‹å¹¶è¡Œçš„æƒ…å†µã€‚</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/CSS SandBox/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CSS SandBox</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/micfrontend/æ·±å…¥ç†è§£QianKun/Loadã€Prefetch and Communication/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">åŠ è½½æµç¨‹ã€é¢„åŠ è½½ä»¥åŠé€šä¿¡</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ä»€ä¹ˆæ˜¯æ²™ç®±" class="table-of-contents__link toc-highlight">ä»€ä¹ˆæ˜¯æ²™ç®±</a></li><li><a href="#æ²™ç®±çš„åº”ç”¨åœºæ™¯" class="table-of-contents__link toc-highlight">æ²™ç®±çš„åº”ç”¨åœºæ™¯</a></li><li><a href="#jsæ²™ç®±çš„å¸¸è§è§£å†³æ–¹æ¡ˆ" class="table-of-contents__link toc-highlight">JSæ²™ç®±çš„å¸¸è§è§£å†³æ–¹æ¡ˆ</a><ul><li><a href="#with" class="table-of-contents__link toc-highlight">with</a></li><li><a href="#es6-proxy" class="table-of-contents__link toc-highlight">ES6 proxy</a></li><li><a href="#with--proxy--iframe" class="table-of-contents__link toc-highlight">with + proxy + iframe</a></li><li><a href="#web-workers" class="table-of-contents__link toc-highlight">Web Workers</a></li></ul></li><li><a href="#æ²™ç®±é€ƒé€¸" class="table-of-contents__link toc-highlight">æ²™ç®±é€ƒé€¸</a><ul><li><a href="#symbolunscopables" class="table-of-contents__link toc-highlight">Symbol.unscopables</a></li><li><a href="#windowparent" class="table-of-contents__link toc-highlight">window.parent</a></li><li><a href="#åŸå‹é“¾é€ƒé€¸" class="table-of-contents__link toc-highlight">åŸå‹é“¾é€ƒé€¸</a></li></ul></li><li><a href="#æœªæ¥å¯å°è¯•çš„æ–°æ–¹æ¡ˆ" class="table-of-contents__link toc-highlight">æœªæ¥å¯å°è¯•çš„æ–°æ–¹æ¡ˆ</a><ul><li><a href="#shadowrealms" class="table-of-contents__link toc-highlight">ShadowRealms</a></li><li><a href="#portals" class="table-of-contents__link toc-highlight"><strong><strong>Portals</strong></strong></a></li></ul></li><li><a href="#æ¢ç©¶qiankunä¸­çš„æ²™ç®±" class="table-of-contents__link toc-highlight">æ¢ç©¶QianKunä¸­çš„æ²™ç®±</a><ul><li><a href="#snapshotsandbox" class="table-of-contents__link toc-highlight">SnapshotSandbox</a></li><li><a href="#legacysandbox" class="table-of-contents__link toc-highlight">LegacySandbox</a></li><li><a href="#proxysandbox" class="table-of-contents__link toc-highlight">ProxySandbox</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Navigation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/whoami">Stuff of Legend</a></li><li class="footer__item"><a href="https://github.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">other Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sidtoons.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">SidToons.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://vocab.js.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">vocab.js.org<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tldr.palashsh.me/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TL;DR News<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright Â© 2024 Blogasaurus by Palash Shrivastava.</div></div></div></footer></div>
</body>
</html>