<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-operation system/代码在CPU如何执行？" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">代码在 CPU 中如何执行 | Zaoei Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://blog.palashsh.me/docs/operation system/代码在CPU如何执行？"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:card" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:site" content="@battleofplassey"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="代码在 CPU 中如何执行 | Zaoei Blog"><meta data-rh="true" name="description" content="我们以一段 C 代码为例，来看一下代码被编译成二进制可执行程序之后，是如何被 CPU 执行的。"><meta data-rh="true" property="og:description" content="我们以一段 C 代码为例，来看一下代码被编译成二进制可执行程序之后，是如何被 CPU 执行的。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.palashsh.me/docs/operation system/代码在CPU如何执行？"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/operation system/代码在CPU如何执行？" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/operation system/代码在CPU如何执行？" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2KDKKFPT4A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Zaoei Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Zaoei Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Zaoei Blog JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5V7R63B0J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R5V7R63B0J",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Zaoei Blog" href="/opensearch.xml">
<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><link rel="stylesheet" href="/assets/css/styles.09761036.css">
<script src="/assets/js/runtime~main.d0e4631e.js" defer="defer"></script>
<script src="/assets/js/main.46e122de.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="blog" href="/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="doc" doclink="docs/webpack-resolve/README.md" href="/docs/webpack-resolve/">docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Zaoei" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" externallink="https://github.com/Zaoei" link="external" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/algorithm">algorithm</a><button aria-label="Expand sidebar category &#x27;algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/micfrontend">micfrontend</a><button aria-label="Expand sidebar category &#x27;micfrontend&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/operating-system">operating system</a><button aria-label="Collapse sidebar category &#x27;operating system&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operation system/javaScript 如何保持上下文">javaScript 如何保持上下文</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/operation system/代码在CPU如何执行？">代码在 CPU 中如何执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operation system/现代操作系统之内存管理">现代操作系统  之内存管理读书笔记</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/single sign on/CAS">single sign on</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-optimize">webpack-optimize</a><button aria-label="Expand sidebar category &#x27;webpack-optimize&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-resolve">webpack-resolve</a><button aria-label="Expand sidebar category &#x27;webpack-resolve&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/whoami">whoami</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/operating-system"><span itemprop="name">operating system</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">代码在 CPU 中如何执行</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="代码在-cpu-中如何执行">代码在 CPU 中如何执行</h1>
<p>我们以一段 C 代码为例，来看一下代码被编译成二进制可执行程序之后，是如何被 CPU 执行的。</p>
<p>在这段代码中，只是做了非常简单的加法操作，将 x 和 y 两个数字相加得到 z，并返回结果 z。</p>
<pre><code class="language-c">int main() {
    int x = 1;
    int y = 2;
    int z = x + y;
    return z;
}
</code></pre>
<p>我们知道，CPU 并不能直接执行这段 C 代码，而是需要对其进行编译，将其转换为二进制的机器码，然后 CPU 才能按照顺序执行编译后的机器码。</p>
<p>先通过 GCC 编译器将这段 C 代码编译成二进制文件，输入以下命令让其编译成目的文件：</p>
<pre><code>gcc -O0 -o code_prog code.c
</code></pre>
<p>输入上面的命令之后回车，在文件夹中生成名为 code_prog 的可执行程序，接下来再将编译出来的 code_prog 程序进行反汇编，这样就可以看到二进制代码和对应的汇编代码。可以使用 objdump 的完成该任务，命令如下所示：</p>
<pre><code>objdump -d code_prog
</code></pre>
<p>最后编译出来的机器码如下：</p>
<pre><code>0000000100003f84 &lt;_main&gt;:
100003f84: ff 43 00 d1  	  sub	sp, sp, #16            // 开辟栈空间。即开辟了四个 4 字节空间
100003f88: ff 0f 00 b9  	  str	wzr, [sp, #12]         // 将 wzr 寄存器的数据存储到 sp 寄存器的 #12 地址上，设为0
100003f8c: 28 00 80 52  	  mov	w8, #1                 // 创建一个 x = 1，并将 1 存入 w8 寄存器中
100003f90: e8 0b 00 b9  	  str	w8, [sp, #8]           // 将 w8 寄存器的数据存入 sp 寄存器中 #8 的地址中，也就是将 x = 1 存入
100003f94: 48 00 80 52  	  mov	w8, #2                 // 创建一个 y = 2，并将 2 存入 w8 寄存器中
100003f98: e8 07 00 b9  	  str	w8, [sp, #4]           // 将 w8 寄存器的数据存入 sp 寄存器中 #4 的地址中，也就是将 y = 2 存入
100003f9c: e8 0b 40 b9  	  ldr	w8, [sp, #8]           // 读取 sp 寄存器中 #8 的数据存入 w8 寄存器中，也就是获取 x = 1
100003fa0: e9 07 40 b9  	  ldr	w9, [sp, #4]           // 读取 sp 寄存器中 #4 的数据存入 w9 寄存器中，也就是获取 y = 2
100003fa4: 08 01 09 0b  	  add	w8, w8, w9             // 将 w8、w9 寄存器的 x,y 数据进行相加，并存入 w8 寄存器中，也就是 z = 3
100003fa8: e8 03 00 b9  	  str	w8, [sp]               // 将 w8 寄存器的数据存入 sp 寄存器中
100003fac: e0 03 40 b9  	  ldr	w0, [sp]               // 读取 sp 寄存器中的数据存到 w0 寄存器中。z = 3
100003fb0: ff 43 00 91  	  add	sp, sp, #16            // 清空开辟的栈空间
100003fb4: c0 03 5f d6  	  ret                          // 返回结果
</code></pre>
<p>PS: wzr 为 32 的零寄存器，专门用来清零，也就是 sp 上 #12 指向的数据设置为 0</p>
<p>观察上方，左边就是编译生成的机器码，在这里它是使用十六进制来展示的，这主要是因为十六进制比较容易阅读，所以通常使用十六进制来展示二进制代码。</p>
<p>可以观察到上图是由很多行组成的，每一行都是一个指令，该指令可以让 CPU 执行指定的任务。</p>
<p>中间的部分是汇编代码，例如原本是二进制表示的指令，在汇编代码中可以使用单词来表示，比如 mov、add 就分别表示数据的存储和相加。</p>
<p>通常将汇编语言编写的程序转换为机器语言的过程称为“汇编”；反之，机器语言转化为汇编语言的过程称为“反汇编”，比如上图就是对 code_prog 进程进行了反汇编操作。</p>
<p>右边添加的注释，表示每条指令的具体含义。</p>
<p>这一大堆指令按照顺序集合在一起就组成了程序，所以程序的执行，本质上就是 CPU 按照顺序执行这一大堆指令的过程。</p>
<h2 id="cpu-是怎么执行程序的">CPU 是怎么执行程序的？</h2>
<p>为了更好的分析程序的执行过程，我们还需要了解一下基础的计算机硬件信息，具体如下图：
<img src="/assets/images/CPU硬件图-54ab2628d72036e9350d13fee1f4edc3.png" width="1904" height="1083"></p>
<p>这张图是比较通用的系统硬件组织模型图，它主要是由 CPU、主存储器、各种 IO 总线，还有一些外部设备组成的。</p>
<p>首先，在一个程序执行之前，程序需要被装进内存，比如在 macOS 下面，你可以通过鼠标点击一个可执行文件，当你点击该文件的时候，系统中的程序加载器会将该文件加载到内存中。</p>
<p>CPU 可以通过指定内存地址，从内存中读取数据，或者往内存中写入数据，有了内存地址，CPU 和内存就可以有序地交互。</p>
<p>内存中的每个存储空  间都有其对应的独一无二的地址：
<img src="/assets/images/内存空-e4c4dbb8d4abbe978d76a937d36312ff.png" width="521" height="754"></p>
<p>在内存中，每个存放字节的空间都有其唯一的地址，而且地址是按照顺序排放的。</p>
<p>以开头代码为例，这段代码会被编译成可执行文件，可执行文件中包含了二进制的机器码，当二进制代码被加载进了内存后，那么内存中的每条二进制代码便都有了自己对应的地址，如下图所示：</p>
<p><img src="/assets/images/内存存放指令-84431cf4e14b89a872b54a10ba5f220c.png" width="521" height="754"></p>
<p>一旦二进制代码被装载进内存，CPU 便可以从内存中取出一条指令，然后分析该指令，最后执行该指令。</p>
<p>把取出指令、分析指令、执行指令这三个过程称为一个 CPU 时钟周期。CPU 是永不停歇的，当它执行完成一条指令之后，会立即从内存中取出下一条指令，接着分析该指令，执行该指令，CPU 一直重复执行该过程，直至所有的指令执行完成。</p>
<p>CPU 是怎么知道要取出内存中的哪条指令呢？：</p>
<p><img src="/assets/images/first-execution-52812d484f2cd67ca8d66c90381d0eec.png" width="745" height="957"></p>
<p>从上图可以看到 CPU 中有一个 PC 寄存器，它保存了将要执行的指令地址，当二进制代码被装载进了内存之后，系统会将二进制代码中的第一条指令的地址写入到 PC 寄存器中，到了下一个时钟周期时，CPU 便会根据 PC 寄存器中的地址，从内存中取出指令。</p>
<p>PC 寄存器中的指令取出来之后，系统要做两件事：第一件是将下一条指令的地址更新到 PC 寄存器中，如下图所示：</p>
<p><img src="/assets/images/next-instruction-d36b361199346f077b3fe0319e11cc78.png" width="737" height="890"></p>
<p>更新了 PC 寄存器之后，CPU 就会立即做第二件事，那就是分析该指令，并识别出不同的类型的指令，以  及各种获取操作数的方法。
在指令分析完成之后，就要执行指令了。
在执行指令前，我们还需要认识一下 CPU 中的重要部件：寄存器。</p>
<h2 id="寄存器">寄存器</h2>
<p>寄存器是 CPU 中用来存放数据的设备，不同处理器中寄存器的个数也是不一样的，之所要通用寄存器，是因为 CPU 访问内存的速度很慢，所以 CPU 就在内部添加了一些存储设备，这些设备就是寄存器。</p>
<p>他们的读取速度如下：
<img src="/assets/images/内存-f9f9393cfed7b7cd802f4214e27042a1.png" width="964" height="378"></p>
<p>总结来说，寄存器容量小，读写速度快，内存容量大，读写速度慢。</p>
<p>寄存器通常用来存放数据或者内存中某块数据的地址，我们把这个地址又称为指针，通常情况下寄存器对存放的数据是没有特别的限制的，比如某个通用寄存器既可以存储数据，也可以存储指针。</p>
<p>不过由于历史原因，我们还会将某些专用的数据或者指针存储在专用的通用寄存器中 ，比如 rbp 寄存器通常用来存放栈帧指针的，rsp 寄存器用来存放栈顶指针的，PC 寄存器用来存放下一条要执行的指令等。</p>
<h3 id="特殊寄存器">特殊寄存器</h3>
<h4 id="stack-pointer-registersp">Stack Pointer register（SP）</h4>
<blockquote>
<p>The use of SP as an operand in an instruction, indicates the use of the current stack pointer.
指向当前栈指针。堆栈指针总是指向栈顶位置。一般堆栈的栈底不能动，所以数据入栈前要先修改堆栈指针，使它指向新的空余空间然后再把数据存进去，出栈的时候相反。</p>
</blockquote>
<p>堆栈指针，随时跟踪栈顶地址，按&quot;先进后出&quot;的原则存取数据。</p>
<h4 id="link-register-lr">Link Register （LR）</h4>
<p>连接寄存器，一是用来保存子程序返回地址；二是当异常发生时，LR中保存的值等于异常发生时PC的值减4（或者减2  ），因此在各种异常模式下可以根据LR的值返回到异常发生前的相应位置继续执行。</p>
<h4 id="program-counterpc">Program Counter（PC）</h4>
<blockquote>
<p>A 64-bit Program Counter holding the address of the current instruction.
保存了将要执行的指令地址</p>
</blockquote>
<h4 id="word-zero-registerwzr">Word Zero Register（WZR）</h4>
<p>零寄存器，用于给int清零</p>
<h3 id="tips">tips</h3>
<p><strong>不同指令中寄存器后 #d 有什么区别？</strong>
[#d]在ARM代表的是一个常数表达式。
如：#0x3FC、#0、#0xF0000000、#200、#0xF0000001
都是代表着一个常数。</p>
<p>在 sp 寄存器中，代表的是当前栈顶指针移动的位置。
如：</p>
<pre><code>sub	sp, sp, #16；// 获取 sp 中的栈顶指针移动 16位的位置，并把位置更新到 sp 寄存器中。实现开辟空间
</code></pre>
<p>在通用寄存器 W0 - W11 中，代表的操作的常数值。</p>
<pre><code>mov	w8, #2，// 把常数 2 添加到 w8 寄存器中
</code></pre>
<h3 id="armv7-a-中的通用寄存器">ARMv7-A 中的通用寄存器</h3>
<p>以 ARMv7-A 体型结构为例。在ARMv7-A体系结构中，有16个供软件使用的32位通用寄存器（R0-R15）。 其中15个（R0-R14）可用于通用数据存储。剩下的R15寄存器是程序计数器（PC）。
以下介绍下比较常见的通用寄存器：</p>
<ul>
<li>其中W0~W3 用于函数调用入参，其中，W0 还用于程序的返回值.</li>
<li>W4~W11用于保存局部变量。</li>
<li>W13为SP，时刻指向栈顶，当有数据入栈或出栈时，需要更新SP</li>
<li>W14为链接寄存器，主要是用作保存子程序返回的地址。</li>
<li>R15为PC寄存器，指向将要执行的下一条指令地址。</li>
</ul>
<h3 id="mov">mov</h3>
<p>数据传送指令。将立即数或寄存器(operant2)传送到目标寄存器Rd，可用于移位运算等操作。指令格式如下：</p>
<pre><code>MOV{cond}{S} Rd,operand2
</code></pre>
<p>如:</p>
<p><code>mov w8, #1</code>， 就是往 w8 寄存器中写入 #1.</p>
<p><code>mov w8, w9</code>， 就是把 w9 寄存器的数据发送到 w8 寄存器中，最终 w8 和 w9 寄存器的数据一致。如下图：</p>
<p><img src="/assets/images/mov-instruction-9e298256a335792227fd28113e7ad21f.png" width="1288" height="1192"></p>
<h3 id="ldr">ldr</h3>
<p>ldr 从内存中读取数据放入寄存器中</p>
<pre><code>LDR{cond}{T} Rd,&lt;地址&gt;;加载指定地址上的数据(字)，放入Rd中
</code></pre>
<p>如：</p>
<p><code>ldr w8, [sp, #8]</code> 读取 sp 寄存器中 #8 位置的数据存入 w8 寄存器中，改变的只有 w8 ，sp 寄存器不变</p>
<h3 id="str">str</h3>
<p>str 指令用于将寄存器中的数据保存到内存</p>
<pre><code>STR{cond}{T} Rd,&lt;地址&gt;;存储数据(字)到指定地址的存储单元，要存储的数据在Rd中
</code></pre>
<p>如：
<code>str w8, [sp]</code> ， 将 w8 寄存器的数据存入 sp 寄存器中</p>
<h3 id="add">add</h3>
<p>加法运算指令。将operand2 数据与Rn 的值相加，结果保存到Rd 寄存器。指令格式如下：</p>
<pre><code class="language-arm">ADD{cond}{S} Rd,Rn,operand2
</code></pre>
<p>以 <code>add	w8, w8, w9</code>为例，就是把 w8、w9 寄存器的 x,y 数据进行相加，并存入 w8 寄存器中</p>
<p>如下图：
<img src="/assets/images/add-instruction-345b3f387ef67727c10f2245e66e46a6.png" width="1313" height="1789"></p>
<h3 id="sub">sub</h3>
<p>减法运算指令。用寄存器Rn 减去operand2。结果保存到Rd 中。指令格式如下：</p>
<pre><code>SUB{cond}{S} Rd,Rn,operand2
</code></pre>
<p>如</p>
<p><code>sub R0,R0,#1</code> -- R0=R0-1</p>
<h3 id="执行过程">执行过程</h3>
<p>了解了以上的知识，我们再来分析一遍代码的执行过程。</p>
<p>在 C 程序中，CPU 会首先执行调用 main 函数，在调用 main 函数时，生成一块内存空间，用来存放 main 函数执行过程中的数据。</p>
<pre><code>sub	sp, sp, #16
</code></pre>
<p>将 0 写入到 #12 的字节位置上。</p>
<pre><code>str	wzr, [sp, #12]
</code></pre>
<p>接下来给 x 附值</p>
<pre><code>mov	w8, #1
str	w8, [sp, #8]
</code></pre>
<p>第一行指令是把 1 添加进寄存器中。第二行指令是把 1 存入 #8 地址的内存空间中。</p>
<p>接着给 y 附值</p>
<pre><code>mov	w8, #2
str	w8, [sp, #4]
</code></pre>
<p>第一行指令是把 2 添加进寄存器中。第二行指令是把 2 存入 #4 地址的内存空间中。</p>
<p>执行完 x， y 的生成，接下来执行 <code>z = x + y</code></p>
<pre><code>ldr	w8, [sp, #8]
ldr	w9, [sp, #4]
add	w8, w8, w9
</code></pre>
<p>第一行指令取出内存空间地址为 #8 的数据，也就是 1. 第二行指令去除内存空间地址为 #4 的数据，也就是 2，第三行指令则对取出的数据进行相加操作，并将结果 3 存入寄存器中。</p>
<pre><code>str	w8, [sp]
ldr	w0, [sp]
</code></pre>
<p>第一行指令把寄存器中的最终的数据存入内存中，第二行指令则获取内存中的结果，存入寄存器中。等待返回</p>
<pre><code>add	sp, sp, #16
</code></pre>
<p>把开辟的空间进行清理。</p>
<pre><code>ret
</code></pre>
<p>返回结果</p>
<h2 id="参考">参考</h2>
<p>-《图解 Google V8》-  李兵</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/operation system/javaScript 如何保持上下文"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">javaScript 如何保持上下文</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/operation system/现代操作系统之内存管理"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">现代操作系统之内存管理读书笔记</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cpu-是怎么执行程序的" class="table-of-contents__link toc-highlight">CPU 是怎么执行程序的？</a></li><li><a href="#寄存器" class="table-of-contents__link toc-highlight">寄存器</a><ul><li><a href="#特殊寄存器" class="table-of-contents__link toc-highlight">特殊寄存器</a></li><li><a href="#tips" class="table-of-contents__link toc-highlight">tips</a></li><li><a href="#armv7-a-中的通用寄存器" class="table-of-contents__link toc-highlight">ARMv7-A 中的通用寄存器</a></li><li><a href="#mov" class="table-of-contents__link toc-highlight">mov</a></li><li><a href="#ldr" class="table-of-contents__link toc-highlight">ldr</a></li><li><a href="#str" class="table-of-contents__link toc-highlight">str</a></li><li><a href="#add" class="table-of-contents__link toc-highlight">add</a></li><li><a href="#sub" class="table-of-contents__link toc-highlight">sub</a></li><li><a href="#执行过程" class="table-of-contents__link toc-highlight">执行过程</a></li></ul></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Navigation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/whoami">Stuff of Legend</a></li><li class="footer__item"><a href="https://github.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">other Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sidtoons.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">SidToons.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://vocab.js.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">vocab.js.org<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tldr.palashsh.me/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TL;DR News<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2024 Blogasaurus by Palash Shrivastava.</div></div></div></footer></div>
</body>
</html>