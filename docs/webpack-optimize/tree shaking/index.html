<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-webpack-optimize/tree shaking/README" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">tree-shaking | Zaoei Blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://blog.palashsh.me/docs/webpack-optimize/tree shaking/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:card" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:image" content="https://avatars.githubusercontent.com/u/35087196?v=4"><meta data-rh="true" name="twitter:site" content="@battleofplassey"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="tree-shaking | Zaoei Blog"><meta data-rh="true" name="description" content="tree-shaking 最早由 Rich Harris 在 rollup 中提出。"><meta data-rh="true" property="og:description" content="tree-shaking 最早由 Rich Harris 在 rollup 中提出。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://blog.palashsh.me/docs/webpack-optimize/tree shaking/"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/webpack-optimize/tree shaking/" hreflang="en"><link data-rh="true" rel="alternate" href="https://blog.palashsh.me/docs/webpack-optimize/tree shaking/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://2KDKKFPT4A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Zaoei Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Zaoei Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Zaoei Blog JSON Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R5V7R63B0J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R5V7R63B0J",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Zaoei Blog" href="/opensearch.xml">
<link rel="icon" href="/img/docusaurus.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)"><link rel="stylesheet" href="/assets/css/styles.09761036.css">
<script src="/assets/js/runtime~main.d0e4631e.js" defer="defer"></script>
<script src="/assets/js/main.46e122de.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="blog" href="/">Blog</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" link="doc" doclink="docs/webpack-resolve/README.md" href="/docs/webpack-resolve/">docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Zaoei" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" externallink="https://github.com/Zaoei" link="external" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="Zaoei Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/algorithm">algorithm</a><button aria-label="Expand sidebar category &#x27;algorithm&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/micfrontend">micfrontend</a><button aria-label="Expand sidebar category &#x27;micfrontend&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/operating-system">operating system</a><button aria-label="Expand sidebar category &#x27;operating system&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/single sign on/CAS">single sign on</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/webpack-optimize">webpack-optimize</a><button aria-label="Collapse sidebar category &#x27;webpack-optimize&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/Bundle Splitting/">Bundle Splitting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/Code Splitting/">Code Splitting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/Externals/">external</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/">WIP 等待填充</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/module/">module</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/resolve/">resolve</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible menu__list-item-collapsible--active"><a class="menu__link menu__link--sublist menu__link--active" aria-current="page" aria-expanded="true" tabindex="0" href="/docs/webpack-optimize/tree shaking/">tree-shaking</a><button aria-label="Collapse sidebar category &#x27;tree-shaking&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/tree shaking/webpack tree shaking">webpack tree shaking</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/压缩/">压缩代码</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/webpack-optimize/多进程 and 多线程/">多进程/多实例构建</a><button aria-label="Expand sidebar category &#x27;多进程/多实例构建&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/webpack-optimize/构建工具/">Stats 对象</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/webpack-resolve">webpack-resolve</a><button aria-label="Expand sidebar category &#x27;webpack-resolve&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/whoami">whoami</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/webpack-optimize"><span itemprop="name">webpack-optimize</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">tree-shaking</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="tree-shaking">tree-shaking</h1>
<p><code>tree-shaking</code> 最早由 <a href="https://github.com/Rich-Harris">Rich Harris</a> 在 <code>rollup</code> 中提出。</p>
<p>为了减少最终构建体积而诞生。</p>
<p>以下是 <a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Tree_shaking">MDN</a> 中的说明：</p>
<blockquote>
<p>tree-shaking 是一个通常用于描述移除 JavaScript 上下文中的未引用代码(dead-code) 行为的术语。</p>
<p>它依赖于 ES2015 中的 import 和 export 语句，用来检测代码模块是否被导出、导入，且被 JavaScript 文件使用。</p>
<p>在现代 JavaScript 应用程序中，我们使用模块打包(如 webpack 或 Rollup)将多个 JavaScript 文件打包为单个文件时自动删除未引用的代码。这对于准备预备发布代码的工作非常重要，这样可以使最终文件具有简洁的结构和最小化大小。</p>
</blockquote>
<h2 id="tree-shaking-vs-dead-code-elimination">tree-shaking VS dead code elimination</h2>
<p>说起 <code>tree-shaking</code> 不得不说起 <code>dead code elimination</code>，简称 <code>DCE</code>。</p>
<p>很多人往往把 <code>tree-shaking</code> 当作是一种实现 <code>DCE</code> 的技术。如果都是同一种东西，最终的目标是一致的（更少的代码）。为什么要重新起一个名字叫做 <code>tree-shaking</code> 呢？</p>
<p><code>tree-shaking</code> 术语的发明者 <a href="https://github.com/Rich-Harris">Rich Harris</a> 在他写的一篇<a href="https://medium.com/@Rich_Harris/%60tree-shaking%60-versus-dead-code-elimination-d3765df85c80">《tree-shaking versus dead code elimination》</a>告诉了我们答案。</p>
<p>Rich Harris 引用了一个做蛋糕的例子。原文如下：</p>
<blockquote>
<p>Bad analogy time: imagine that you made cakes by throwing whole eggs into the mixing bowl and smashing them up, instead of cracking them open and pouring the contents out. Once the cake comes out of the oven, you remove the fragments of eggshell, except that’s quite tricky so most of the eggshell gets left in there.</p>
<p>You’d probably eat less cake, for one thing.</p>
<p>That’s what dead code elimination consists of — taking the finished product, and imperfectly removing bits you don’t want. tree-shaking, on the other hand, asks the opposite question: given that I want to make a cake, which bits of what ingredients do I need to include in the mixing bowl?</p>
<p>Rather than excluding dead code, we’re including live code. Ideally the end result would be the same, but because of the limitations of static analysis in JavaScript that’s not the case. Live code inclusion gets better results, and is prima facie a more logical approach to the problem of preventing our users from downloading unused code.</p>
</blockquote>
<p>简单来说：<code>DCE</code> 好比做蛋糕时，直接放入整个鸡蛋，做完时再从蛋糕中取出蛋壳。而 <code>tree-shaking</code> 则是先取出蛋壳，在进行做蛋糕。两者结果相同，但是过程是完全不同的。</p>
<h3 id="dead-code">dead code</h3>
<p><code>dead code</code> 一般具有以下几个特征:</p>
<ul>
<li>代码不会被执行，不可到达</li>
<li>代码执行的结果不会被用到</li>
<li>代码只会影响死变量（只写不读）</li>
</ul>
<p>使用 <code>webpack</code> 在 <code>mode: development</code> 模式下对以下代码进行打包：</p>
<pre><code class="language-js">function app() {
  var test = &#x27;我是app&#x27;;
  function set() {
    return 1;
  }
  return test;
  test = &#x27;无法执行&#x27;;
  return test;
}

export default app;
</code></pre>
<p>最终打包结果:</p>
<pre><code class="language-js">eval(
  &quot;function app() {\n    var test = &#x27;我是app&#x27;;\n    function set() {\n        return 1;\n    }\n    return test;\n    test = &#x27;无法执行&#x27;;\n    return test;\n}\n\napp();\n\n\n//# sourceURL=webpack://webpack/./src/main.js?&quot;
);
</code></pre>
<p>可以看到打包的结果内，还是存在无法执行到的代码块。</p>
<p><code>webpack</code> 不支持 <code>dead code elimination</code> 吗？是的，<code>webpack</code> 不支持。</p>
<p>原来，在 <code>webpack</code> 中实现 <code>dead code elimination</code> 功能并不是 <code>webpack</code> 本身, 而是大名鼎鼎的 <a href="https://github.com/mishoo/UglifyJS">uglify</a>。</p>
<p>通过阅读源码发现，在 <code>mode: development</code> 模式下，不会加载 <code>terser-webpack-plugin</code> 插件。</p>
<pre><code class="language-js">// lib/config/defaults.js
D(optimization, &#x27;minimize&#x27;, production);
A(optimization, &#x27;minimizer&#x27;, () =&gt; [
  {
    apply: (compiler) =&gt; {
      // Lazy load the Terser plugin
      const TerserPlugin = require(&#x27;terser-webpack-plugin&#x27;);
      new TerserPlugin({
        terserOptions: {
          compress: {
            passes: 2
          }
        }
      }).apply(compiler);
    }
  }
]);

// lib/WebpackOptionsApply.js
if (options.optimization.minimize) {
  for (const minimizer of options.optimization.minimizer) {
    if (typeof minimizer === &#x27;function&#x27;) {
      minimizer.call(compiler, compiler);
    } else if (minimizer !== &#x27;...&#x27;) {
      minimizer.apply(compiler);
    }
  }
}
</code></pre>
<p>而 <code>terser-webpack-plugin</code> 插件内部使用了 <code>uglify</code> 实现的。</p>
<p>我们在 <code>mode: production</code> 模式下进行打包。</p>
<pre><code class="language-js">// 格式化后结果
(() =&gt; {
    var r = {
            225: (r) =&gt; {
                r.exports = &#x27;我是app&#x27;;
            }
        },
    // ...
})();
</code></pre>
<p>可以看到最终的结果，已经删除了不可执行部分的代码。除此之外，还帮我们压缩了代码，删除了注释等功能。</p>
<h3 id="tree-shaking-无效">tree shaking 无效？</h3>
<p><code>tree shaking</code> 本质上是通过分析静态的 ES 模块，来剔除未使用代码的。</p>
<blockquote>
<p><em><code>ESModule</code> 的特点</em></p>
<p>只能作为模块顶层的语句出现，不能出现在 function 里面或是 if 里面。（ECMA-262 15.2)
import 的模块名只能是字符串常量。(ECMA-262 15.2.2)
不管 import 的语句出现的位置在哪里，在模块初始化的时候所有的 import 都必须已经导入完成。(ECMA-262 15.2.1.16.4 - 8.a)
import binding 是 immutable 的，类似 const。比如说你不能 <code>import { a } from ‘./a’</code> 然后给 a 赋值个其他什么东西。(ECMA-262 15.2.1.16.4 - 12.c.3)
—–引用自尤雨溪</p>
</blockquote>
<p>我们来看看 <code>tree shaking</code> 的功效。</p>
<p>我们有一个模块</p>
<pre><code class="language-js">// ./src/app.js
export const firstName = &#x27;firstName&#x27;;

export function square(x) {
  return x.a;
}

square({ a: 123 });

export function app(x) {
  return x * x * x;
}

export default app;
</code></pre>
<p>底下是 7 个实例。</p>
<pre><code class="language-js">// 1*********************************************
// import App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     return test;
// }

// console.log(main)

// 2*********************************************

// import App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     console.log(App(1))
//     return test;
// }

// console.log(main)

// 3*********************************************

// import App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     App.square(1)
//     return test;
// }

// console.log(main)

// 4*********************************************

// import App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     let methodName = &#x27;square&#x27;
//     App[methodName](1)
//     return test;
// }

// console.log(main)

// 6*********************************************

// import * as App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     App.square(1)
//     return test;
// }

// console.log(main)

// 7*********************************************

// import * as App from &#x27;./app&#x27;

// export function main() {
//     var test = &#x27;我是index&#x27;;
//     let methodName = &#x27;square&#x27;
//     App[methodName](1)
//     return test;
// }

// console.log(main)
</code></pre>
<p>使用 最简单的<code>webpack</code>配置进行打包</p>
<pre><code class="language-js">// webpack.config.js
module.exports = {
  entry: &#x27;./src/index.js&#x27;,
  output: {
    filename: &#x27;dist.js&#x27;
  },
  mode: &#x27;production&#x27;
};
</code></pre>
<p>通过结果可以看到，前 6 中的打包结果，都对死代码进行了消除，只有第 7 种，消除失败。</p>
<pre><code class="language-js">/* ... */
const r = &#x27;firstName&#x27;;
function o(e) {
  return e.a;
}
function n(e) {
  return e * e * e;
}
o({ a: 123 });
const a = n;
console.log(function () {
  return t.square(1), &#x27;我是index&#x27;;
});
</code></pre>
<p>本人没有详细了解过，只能猜测下，由于 <code>JavaScript</code> 动态语言的特性使得静态分析比较困难，目前的的解析器是通过静态解析的，还无法分析全量导入，动态使用的语法。</p>
<p>对于更多 <code>tree shaking</code> 执行相关的可以参考一下链接：</p>
<ul>
<li><a href="https://github.com/rollup/rollup/issues/349">Tree shaking class methods</a></li>
<li><a href="https://segmentfault.com/a/1190000012794598">你的 tree-shaking 并没什么卵用</a></li>
<li><a href="https://segmentfault.com/a/1190000037595350">tree-shaking 效果探讨</a></li>
</ul>
<p>当然了，机智的程序员是不会被这个给难住的，既然静态分析不行，那就由开发者手动来将文件标记为无副作用(side-effect-free)。</p>
<h4 id="tree-shaking-和-sideeffects">tree shaking 和 sideEffects</h4>
<p><code>sideEffects</code> 支持两种写法，一种是 <code>false</code>，另一种是数组</p>
<ul>
<li>如果所有代码都不包含副作用，我们就可以简单地将该属性标记为 <code>false</code></li>
<li>如果你的代码确实有一些副作用，可以改为提供一个数组</li>
</ul>
<p>可以在 <code>package.js</code> 中进行设置。</p>
<pre><code class="language-js">// boolean
{
  &quot;sideEffects&quot;: false
}

// array
{
  &quot;sideEffects&quot;: [&quot;./src/app.js&quot;, &quot;*.css&quot;]
}
</code></pre>
<p>也可以在 <code>module.rules</code> 中进行设置。</p>
<pre><code class="language-js">module.exports = {
  module: {
    rules: [
      {
        test: /\.jsx?$/,
        exclude: /(node_modules)/,
        use: {
          loader: &#x27;babel-loader&#x27;
        },
        sideEffects: false || []
      }
    ]
  }
};
</code></pre>
<p>设置了 <code>sideEffects: false</code>，后在重新打包</p>
<pre><code class="language-js"> var e = {
            225: (e, r, t) =&gt; {
                (e = t.hmd(e)).exports = &#x27;我是main&#x27;;
            }
        },
</code></pre>
<p>只剩下 <code>main.js</code> 模块的代码，已经把 <code>app.js</code> 的代码消除了。</p>
<h4 id="usedexports">usedExports</h4>
<p><code>webpack</code> 中除了 <code>sideEffects</code> 还提供了一种另一种标记消除的方式。那就是通过配置项 <code>usedExports</code> 。</p>
<blockquote>
<p>由 optimization.usedExports 收集的信息会被其它优化手段或者代码生成使用，比如未使用的导出内容不会被生成，当所有的使用都适配，导出名称会被处理做单个标记字符。 在压缩工具中的无用代码清除会受益于该选项，而且能够去除未使用的导出内容。</p>
</blockquote>
<p><code>mode: productions</code> 下是默认开启的。</p>
<pre><code class="language-js">module.exports = {
  //...
  optimization: {
    usedExports: true
  }
};
</code></pre>
<p><code>usedExports</code> 会使用 <code>terser</code> 判断代码有没有 <code>sideEffect</code>，如果没有用到，又没有 <code>sideEffect</code> 的话，就会在打包时替它标记上 unused harmony。
<img src="/assets/images/usedExports-dist-164bce755595c46fb53cd341aa409891.png" width="2004" height="73"></p>
<p>最后由 <code>Terser</code>、<code>UglifyJS</code> 等 <code>DCE</code> 工具“摇”掉这部分无效代码。</p>
<p><a href="https://try.terser.org/">terser 测试</a></p>
<h2 id="tree-shaking-实现原理">tree shaking 实现原理</h2>
<p><code>tree shaking</code> 本身也是采用静态分析的方法。</p>
<blockquote>
<p>程序静态分析（Static Code Analysis）是指在不运行代码的方式下，通过词法分析、语法分析、控制流分析、数据流分析等技术对程序代码进行扫描，验证代码是否满足规范性、安全性、可靠性、可维护性等指标的一种代码分析技术</p>
</blockquote>
<p><code>tree shaking</code> 使用的前提是模块必须采用<code>ES6Module</code>语法，因为<code>tree Shaking</code> 依赖 ES6 的语法：<code>import</code> 和 <code>export</code>。</p>
<p>接下来我们来看看远古版本的 <code>rollup</code> 是怎么实现 <code>tree shaking</code> 的。</p>
<h3 id="rollup">rollup</h3>
<ol>
<li>根据入口模块内容初始化 <code>Module</code>，并使用 <code>acorn</code> 进行 <code>ast</code> 转化</li>
<li>分析 <code>ast</code>。 寻找 <code>import</code> 和 <code>export</code> 关键字，建立依赖关系</li>
<li>分析 <code>ast</code>，收集当前模块存在的函数、变量等信息</li>
<li>再一次分析 <code>ast</code>, 收集各函数变量的使用情况，因为我们是根据依赖关系进行收集代码，如果函数变量未被使用，</li>
<li>根据收集到的函数变量标识符等信息，进行判断，如果是 <code>import</code>，则进行 <code>Module</code> 的创建，重新走上几步。否则的话，把对应的代码信息存放到一个统一的 <code>result</code> 中。</li>
<li>根据最终的结果生成 <code>bundle</code>。</li>
</ol>
<p><img src="/assets/images/tree-shaking-cec7faefe8684ab167f7b0d14fe4d9b0.png" width="249" height="1161"></p>
<blockquote>
<p>源码版本：<a href="https://github.com/rollup/rollup/tree/v0.3.1">v0.3.1</a></p>
</blockquote>
<p>通过 <code>entry</code> 入口文件进行创建 <code>bundle</code>，执行 <code>build</code> 方法，开始进行打包。</p>
<pre><code class="language-js">export function rollup(entry, options = {}) {
  const bundle = new Bundle({
    entry,
    resolvePath: options.resolvePath
  });

  return bundle.build().then(() =&gt; {
    return {
      generate: (options) =&gt; bundle.generate(options),
      write: (dest, options = {}) =&gt; {
        let { code, map } = bundle.generate({
          dest,
          format: options.format,
          globalName: options.globalName
        });

        code += `\n//# ${SOURCEMAPPING_URL}=${basename(dest)}.map`;

        return Promise.all([writeFile(dest, code), writeFile(dest + &#x27;.map&#x27;, map.toString())]);
      }
    };
  });
}
</code></pre>
<p><code>build</code> 内部执行 <code>fetchModule</code> 方法，根据文件名，<code>readFile</code> 读取文件内容，创建 <code>Module</code>。</p>
<pre><code class="language-js">build () {
    // bring in top-level AST nodes from the entry module
    return this.fetchModule( this.entryPath, null )
        .then( entryModule =&gt; {
            this.entryModule = entryModule;

            if ( entryModule.exports.default ) {
                let defaultExportName = makeLegalIdentifier( basename( this.entryPath ).slice( 0, -extname( this.entryPath ).length ) );
                while ( entryModule.ast._scope.contains( defaultExportName ) ) {
                    defaultExportName = `_${defaultExportName}`;
                }

                entryModule.suggestName( &#x27;default&#x27;, defaultExportName );
            }

            return entryModule.expandAllStatements( true );
        })
        .then( statements =&gt; {
            this.statements = statements;
            this.deconflict();
        });
}

fetchModule ( importee, importer ) {
    return Promise.resolve( importer === null ? importee : this.resolvePath( importee, importer ) )
        .then( path =&gt; {
                /*
                    缓存处理
                */

                this.modulePromises[ path ] = readFile( path, { encoding: &#x27;utf-8&#x27; })
                    .then( code =&gt; {
                        const module = new Module({
                            path,
                            code,
                            bundle: this
                        });

                        return module;
                    });

            return this.modulePromises[ path ];
        });
}
</code></pre>
<p>根据读取到的文件内容，使用 <code>acorn</code> 编译器进行进行 <code>ast</code> 的转化。</p>
<pre><code class="language-js">//
export default class Module {
    constructor ({ path, code, bundle }) {
		/*
        初始化
        */
		this.ast = parse(code, {
			ecmaVersion: 6,
			sourceType: &#x27;module&#x27;,
			onComment: (block, text, start, end) =&gt;
			this.comments.push({ block, text, start, end })
		});
		this.analyse();
	}
</code></pre>
<p><img src="/assets/images/ast-9a58d91e3f6dbddb793d7162609b453a.png" width="873" height="828"></p>
<p>遍历节点信息。寻找 <code>import</code> 和 <code>export</code> 关键字，这一步就是我们常说的根据 <code>esm</code> 的静态结构进行分析。</p>
<p>把 <code>import</code> 的信息，收集到 <code>this.imports</code> 对象中，把 <code>exports</code> 的信息，收集到 <code>this.exports</code> 中.</p>
<pre><code class="language-js">this.ast.body.forEach( node =&gt; {
	let source;
	if ( node.type === &#x27;ImportDeclaration&#x27; ) {
		source = node.source.value;

		node.specifiers.forEach( specifier =&gt; {
			const isDefault = specifier.type === &#x27;ImportDefaultSpecifier&#x27;;
			const isNamespace = specifier.type === &#x27;ImportNamespaceSpecifier&#x27;;

			const localName = specifier.local.name;
			const name = isDefault ? &#x27;default&#x27; : isNamespace ? &#x27;*&#x27; : specifier.imported.name;

			if ( has( this.imports, localName ) ) {
				const err = new Error( `Duplicated import &#x27;${localName}&#x27;` );
				err.file = this.path;
				err.loc = getLocation( this.code.original, specifier.start );
				throw err;
			}

			this.imports[ localName ] = {
				source, // 模块id
				name,
				localName
			};
		});
	}

	else if ( /^Export/.test( node.type ) ) {
		if ( node.type === &#x27;ExportDefaultDeclaration&#x27; ) {
			const isDeclaration = /Declaration$/.test( node.declaration.type );

			this.exports.default = {
				node,
				name: &#x27;default&#x27;,
				localName: isDeclaration ? node.declaration.id.name : &#x27;default&#x27;,
				isDeclaration
			};
		}

		// export { foo, bar, baz }
		// export var foo = 42;
		// export function foo () {}
		else if ( node.type === &#x27;ExportNamedDeclaration&#x27; ) {
			// export { foo } from &#x27;./foo&#x27;;
			source = node.source &amp;&amp; node.source.value;

			if ( node.specifiers.length ) {
				// export { foo, bar, baz }
				node.specifiers.forEach( specifier =&gt; {
					const localName = specifier.local.name;
					const exportedName = specifier.exported.name;

					this.exports[ exportedName ] = {
						localName,
						exportedName
					};

					if ( source ) {
						this.imports[ localName ] = {
							source,
							localName,
							name: exportedName
						};
					}
				});
			}

			else {
				let declaration = node.declaration;

				let name;

				if ( declaration.type === &#x27;VariableDeclaration&#x27; ) {
					// export var foo = 42
					name = declaration.declarations[0].id.name;
				} else {
					// export function foo () {}
					name = declaration.id.name;
				}

				this.exports[ name ] = {
					node,
					localName: name,
					expression: declaration
				};
			}
		}
	}
}
</code></pre>
<p><img src="/assets/images/module-1-7d2b39b84fd35f8f399be242478a5923.png" width="1790" height="314"></p>
<pre><code class="language-js">	analyse () {
		// imports and exports, indexed by ID
		this.imports = {};
		this.exports = {};

        // 遍历 ast 查找对应的 import、export 关联
		this.ast.body.forEach( node =&gt; {
			let source;

			// import foo from &#x27;./foo&#x27;;
			// import { bar } from &#x27;./bar&#x27;;
			if ( node.type === &#x27;ImportDeclaration&#x27; ) {
				source = node.source.value;

				node.specifiers.forEach( specifier =&gt; {
					const isDefault = specifier.type === &#x27;ImportDefaultSpecifier&#x27;;
					const isNamespace = specifier.type === &#x27;ImportNamespaceSpecifier&#x27;;

					const localName = specifier.local.name;
					const name = isDefault ? &#x27;default&#x27; : isNamespace ? &#x27;*&#x27; : specifier.imported.name;

					if ( has( this.imports, localName ) ) {
						const err = new Error( `Duplicated import &#x27;${localName}&#x27;` );
						err.file = this.path;
						err.loc = getLocation( this.code.original, specifier.start );
						throw err;
					}

					this.imports[ localName ] = {
						source, // 模块id
						name,
						localName
					};
				});
			}

			else if ( /^Export/.test( node.type ) ) {
				// export default function foo () {}
				// export default foo;
				// export default 42;
				if ( node.type === &#x27;ExportDefaultDeclaration&#x27; ) {
					const isDeclaration = /Declaration$/.test( node.declaration.type );

					this.exports.default = {
						node,
						name: &#x27;default&#x27;,
						localName: isDeclaration ? node.declaration.id.name : &#x27;default&#x27;,
						isDeclaration
					};
				}

				// export { foo, bar, baz }
				// export var foo = 42;
				// export function foo () {}
				else if ( node.type === &#x27;ExportNamedDeclaration&#x27; ) {
					// export { foo } from &#x27;./foo&#x27;;
					source = node.source &amp;&amp; node.source.value;

					if ( node.specifiers.length ) {
						// export { foo, bar, baz }
						node.specifiers.forEach( specifier =&gt; {
							const localName = specifier.local.name;
							const exportedName = specifier.exported.name;

							this.exports[ exportedName ] = {
								localName,
								exportedName
							};

							if ( source ) {
								this.imports[ localName ] = {
									source,
									localName,
									name: exportedName
								};
							}
						});
					}

					else {
						let declaration = node.declaration;

						let name;

						if ( declaration.type === &#x27;VariableDeclaration&#x27; ) {
							// export var foo = 42
							name = declaration.declarations[0].id.name;
						} else {
							// export function foo () {}
							name = declaration.id.name;
						}

						this.exports[ name ] = {
							node,
							localName: name,
							expression: declaration
						};
					}
				}
			}
		}

        // 查找函数，变量，类，块级作用与等,并根据引用关系进行关联
        analyse( this.ast, this.code, this );
        /*
        初始化数据
        */


}
</code></pre>
<p>接下来查找函数，变量，类，块级作用与等,并根据引用关系进行关联。</p>
<p>使用 <code>magicString</code> 为每一个 <code>statement</code> 节点增加内容修改的功能。</p>
<p>遍历整颗 <code>ast</code> 树，先初始化一个 <code>Scope</code>，作为当前模块的命名空间。如果是函数或块级作用域等则新建一个 <code>Scope</code>。各 <code>Scope</code> 之间通过 <code>parent</code> 进行关联，建立起一个根据命名空间关系树。</p>
<p>如果是变量和函数，则与当前的 <code>Scope</code> 进行关联, 把对应的标识符名称增加到 <code>Scope</code> 的中。到这一步，已经收集到了各节点上出现的函数和变量。</p>
<p><img src="/assets/images/scope-1db39e2b09b0cd28c0ecb5cb2d27b755.png" width="943" height="307"></p>
<p>接下来，再一次遍历 <code>ast</code>。查找变量函数，是否只是被读取过，或者只是修改过。</p>
<p>根据 <code>Identifier</code> 类型查找标识符，如果当前标识符能在 <code>Scope</code> 中找到，说明有对其进行过读取。存放在 <code>_dependsOn</code> 集合中。</p>
<p><img src="/assets/images/search-node-e4d650b586ba17caa036efd87f1b60fd.png" width="884" height="355"></p>
<p>接下来根据 <code>AssignmentExpression</code>、<code>UpdateExpression</code> 和 <code>CallExpression</code> 类型节点，收集我们的标识符，有没有被修改过或被当前参数传递过。并将结果存放在 <code>_modifies</code> 中。</p>
<pre><code class="language-js">function analyse(ast, magicString, module) {
  var scope = new Scope();
  var currentTopLevelStatement = undefined;

  function addToScope(declarator) {
    var name = declarator.id.name;
    scope.add(name, false);

    if (!scope.parent) {
      currentTopLevelStatement._defines[name] = true;
    }
  }

  function addToBlockScope(declarator) {
    var name = declarator.id.name;
    scope.add(name, true);

    if (!scope.parent) {
      currentTopLevelStatement._defines[name] = true;
    }
  }

  // first we need to generate comprehensive scope info
  var previousStatement = null;
  var commentIndex = 0;

  ast.body.forEach(function (statement) {
    currentTopLevelStatement = statement; // so we can attach scoping info

    Object.defineProperties(statement, {
      _defines: { value: {} },
      _modifies: { value: {} },
      _dependsOn: { value: {} },
      _included: { value: false, writable: true },
      _module: { value: module },
      _source: { value: magicString.snip(statement.start, statement.end) }, // TODO don&#x27;t use snip, it&#x27;s a waste of memory
      _margin: { value: [0, 0] },
      _leadingComments: { value: [] },
      _trailingComment: { value: null, writable: true }
    });

    var trailing = !!previousStatement;

    // attach leading comment
    do {
      var comment = module.comments[commentIndex];

      if (!comment || comment.end &gt; statement.start) break;

      // attach any trailing comment to the previous statement
      if (trailing &amp;&amp; !/\n/.test(magicString.slice(previousStatement.end, comment.start))) {
        previousStatement._trailingComment = comment;
      }

      // then attach leading comments to this statement
      else {
        statement._leadingComments.push(comment);
      }

      commentIndex += 1;
      trailing = false;
    } while (module.comments[commentIndex]);

    // determine margin
    var previousEnd = previousStatement
      ? (previousStatement._trailingComment || previousStatement).end
      : 0;
    var start = (statement._leadingComments[0] || statement).start;

    var gap = magicString.original.slice(previousEnd, start);
    var margin = gap.split(&#x27;\n&#x27;).length;

    if (previousStatement) previousStatement._margin[1] = margin;
    statement._margin[0] = margin;

    walk(statement, {
      enter: function (node) {
        var newScope = undefined;

        magicString.addSourcemapLocation(node.start);

        switch (node.type) {
          case &#x27;FunctionExpression&#x27;:
          case &#x27;FunctionDeclaration&#x27;:
          case &#x27;ArrowFunctionExpression&#x27;:
            var names = node.params.map(getName);

            if (node.type === &#x27;FunctionDeclaration&#x27;) {
              addToScope(node);
            } else if (node.type === &#x27;FunctionExpression&#x27; &amp;&amp; node.id) {
              names.push(node.id.name);
            }

            newScope = new Scope({
              parent: scope,
              params: names, // TODO rest params?
              block: false
            });

            break;

          case &#x27;BlockStatement&#x27;:
            newScope = new Scope({
              parent: scope,
              block: true
            });

            break;

          case &#x27;CatchClause&#x27;:
            newScope = new Scope({
              parent: scope,
              params: [node.param.name],
              block: true
            });

            break;

          case &#x27;VariableDeclaration&#x27;:
            node.declarations.forEach(node.kind === &#x27;let&#x27; ? addToBlockScope : addToScope); // TODO const?
            break;

          case &#x27;ClassDeclaration&#x27;:
            addToScope(node);
            break;
        }

        if (newScope) {
          Object.defineProperty(node, &#x27;_scope&#x27;, { value: newScope });
          scope = newScope;
        }
      },
      leave: function (node) {
        if (node === currentTopLevelStatement) {
          currentTopLevelStatement = null;
        }

        if (node._scope) {
          scope = scope.parent;
        }
      }
    });

    previousStatement = statement;
  });

  // then, we need to find which top-level dependencies this statement has,
  // and which it potentially modifies
  ast.body.forEach(function (statement) {
    function checkForReads(node, parent) {
      if (node.type === &#x27;Identifier&#x27;) {
        // disregard the `bar` in `foo.bar` - these appear as Identifier nodes
        if (parent.type === &#x27;MemberExpression&#x27; &amp;&amp; node !== parent.object) {
          return;
        }

        // disregard the `bar` in { bar: foo }
        if (parent.type === &#x27;Property&#x27; &amp;&amp; node !== parent.value) {
          return;
        }

        var definingScope = scope.findDefiningScope(node.name);

        if ((!definingScope || definingScope.depth === 0) &amp;&amp; !statement._defines[node.name]) {
          statement._dependsOn[node.name] = true;
        }
      }
    }

    function checkForWrites(node) {
      function addNode(node, disallowImportReassignments) {
        while (node.type === &#x27;MemberExpression&#x27;) {
          node = node.object;
        }

        // disallow assignments/updates to imported bindings and namespaces
        if (
          disallowImportReassignments &amp;&amp;
          has(module.imports, node.name) &amp;&amp;
          !scope.contains(node.name)
        ) {
          var err = new Error(&quot;Illegal reassignment to import &#x27;&quot; + node.name + &quot;&#x27;&quot;);
          err.file = module.path;
          err.loc = getLocation(module.code.toString(), node.start);
          throw err;
        }

        if (node.type !== &#x27;Identifier&#x27;) {
          return;
        }

        statement._modifies[node.name] = true;
      }

      if (node.type === &#x27;AssignmentExpression&#x27;) {
        addNode(node.left, true);
      } else if (node.type === &#x27;UpdateExpression&#x27;) {
        addNode(node.argument, true);
      } else if (node.type === &#x27;CallExpression&#x27;) {
        node.arguments.forEach(function (arg) {
          return addNode(arg, false);
        });
      }

      // TODO UpdateExpressions, method calls?
    }

    walk(statement, {
      enter: function (node, parent) {
        // skip imports
        if (/^Import/.test(node.type)) return this.skip();

        if (node._scope) scope = node._scope;

        checkForReads(node, parent);
        checkForWrites(node, parent);

        //if ( node.type === &#x27;ReturnStatement&#x27;)
      },
      leave: function (node) {
        if (node._scope) scope = scope.parent;
      }
    });
  });

  ast._scope = scope;
}
</code></pre>
<p>执行完结果如下：</p>
<p><img src="/assets/images/module-2-3e0462951c327ce9e21284000a9e9b2d.png" width="1880" height="1344"></p>
<p>在上一步种，我们为函数，变量，类，块级作用与等声明与我们当前节点进行了关联，现在要把节点上的这些信息，统一收集起来，放到 <code>Module</code> 中</p>
<pre><code class="language-js">//
this.ast.body.forEach((statement) =&gt; {
  Object.keys(statement._defines).forEach((name) =&gt; {
    this.definitions[name] = statement;
  });

  Object.keys(statement._modifies).forEach((name) =&gt; {
    if (!has(this.modifications, name)) {
      this.modifications[name] = [];
    }

    this.modifications[name].push(statement);
  });
});
</code></pre>
<p><img src="/assets/images/module-2-3e0462951c327ce9e21284000a9e9b2d.png" width="1880" height="1344"></p>
<p>从中我们可以看到每个 <code>statement</code> 中，依赖了哪些，修改了哪些。</p>
<p>当我们在入口模块的操作完成后，在遍历 <code>statement</code> 节点，根据 <code>_dependsOn</code> 的中的信息，执行 <code>define</code> 。</p>
<p>如果 <code>_dependsOn</code> 的数据，在 <code>this.imports</code> 中，能够找到，说明该标识符是一个导入模块，调用 <code>fetchModule</code> 方法，重复上面的逻辑。</p>
<p>如果是正常函数变量之类的，则收集对应 <code>statement</code> 。执行到最后，我们就可以把相关联的 <code>statement</code> 都收集起来，未被收集到，说明其就是无用代码，已经被过滤了。</p>
<p>最后在重组成 <code>bundle</code>，通过 <code>fs</code> 在发送到我们的文件。</p>
<h3 id="webpack">webpack</h3>
<p><code>webpack</code> 实现 <code>tree shaking</code> 与 <code>rollup</code> 是同一个原理。</p>
<p>以下信息来自于 <a href="https://zhuanlan.zhihu.com/p/403901557">Webpack 原理系列九：tree-shaking 实现原理</a>，结合个人理解，进行修改。</p>
<p>在 <code>make</code> 阶段  中，<code>webpack</code> 通过 <code>compilation</code> 对象进行模块的编译分析等工作。</p>
<h4 id="收集模块导出">收集模块导出</h4>
<p>在对模块进行 <code>parse</code> 的时候，也是使用 <code>acorn</code> 编译器进行进行 <code>ast</code> 的转化。与 <code>rollup</code> 一样，也是通过 <code>esm</code> 的静态结构语法 <code>import</code> 和 <code>export</code> 进行分析。</p>
<p>所有模块都编译完毕后，触发 <code>compilation.hooks.finishModules</code> 钩子，开始执行 <code>FlagDependencyExportsPlugin</code> 插件回调</p>
<p><code>FlagDependencyExportsPlugin</code> 插件从 <code>entry</code> 开始读取 <code>ModuleGraph</code> 中存储的模块信息，遍历所有 <code>module</code> 对象</p>
<p>遍历 <code>module</code> 对象的 <code>dependencies</code> 数组，找到所有 <code>HarmonyExportXXXDependency</code> 类型的依赖对象，将其转换为 <code>ExportInfo</code> 对象并记录到 <code>ModuleGraph</code> 体系中</p>
<p>经过 <code>FlagDependencyExportsPlugin</code> 插件处理后，所有 <code>ESM</code> 风格的 <code>export</code> 语句都会记录在 <code>ModuleGraph</code> 体系内，后续操作就可以从 <code>ModuleGraph</code> 中直接读取出模块的导出值。</p>
<h4 id="标记模块导出">标记模块导出</h4>
<p>模块导出信息收集完毕后，<code>webpack</code> 需要标记出各个模块的导出列表中，哪些导出值有被其它模块用到，哪些没有，这一过程发生在 <code>Seal</code> 阶段，也就是处理 <code>chunk</code> 的阶段，主流程：</p>
<p>触发 <code>compilation.hooks.optimizeDependencies</code> 钩子，开始执行 <code>FlagDependencyUsagePlugin</code> 插件逻辑</p>
<p>在 <code>FlagDependencyUsagePlugin</code> 插件中，从 <code>entry</code> 开始逐步遍历 <code>ModuleGraph</code> 存储的所有 <code>module</code> 对象</p>
<p>遍历 <code>module</code> 对象对应的 <code>exportInfo</code> 数组为每  一个 <code>exportInfo</code> 对象执行 <code>compilation.getDependencyReferencedExports</code> 方法，确定其对应的 <code>dependency</code> 对象有否被其它模块使用</p>
<p>被任意模块使用到的导出值，调用 <code>exportInfo.setUsedConditionally</code> 方法将其标记为已被使用。</p>
<p><code>exportInfo.setUsedConditionally</code> 内部修改 <code>exportInfo._usedInRuntime</code> 属性，记录该导出被如何使用</p>
<h4 id="生成代码">生成代码</h4>
<p>打包阶段，调用 <code>HarmonyExportXXXDependency.Template.apply</code> 方法生成代码</p>
<p>在 <code>apply</code> 方法内，读取 <code>ModuleGraph</code> 中存储的 <code>exportsInfo</code> 信息，判断哪些导出值被使用，哪些未被使用</p>
<p>对已经被使用及未被使用的导出值，分别创建对应的 <code>HarmonyExportInitFragment</code> 对象，保存到 <code>initFragments</code> 数组</p>
<p>遍历 <code>initFragments</code> 数组，生成最终结果</p>
<h4 id="删除-dead-code">删除 Dead Code</h4>
<p>最后由 <code>Terser</code>、<code>UglifyJS</code> 等 <code>DCE</code> 工具“摇”掉这部分无效代码，构成完整的 <code>Tree Shaking</code> 操作</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://github.com/happylindz/blog/issues/6">深入理解 webpack 文件打包机制</a></li>
<li><a href="https://github.com/rollup/rollup/issues/349">Tree shaking class methods</a></li>
<li><a href="https://segmentfault.com/a/1190000012794598">你的 tree-shaking 并没什么卵用</a></li>
<li><a href="https://juejin.cn/post/7002410645316436004#heading-2">Webpack 原理系列九：tree-shaking 实现原理</a></li>
<li><a href="https://segmentfault.com/a/1190000037595350">tree-shaking 效果探讨</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/webpack-optimize/resolve/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">resolve</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/webpack-optimize/tree shaking/webpack tree shaking"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">webpack tree shaking</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tree-shaking-vs-dead-code-elimination" class="table-of-contents__link toc-highlight">tree-shaking VS dead code elimination</a><ul><li><a href="#dead-code" class="table-of-contents__link toc-highlight">dead code</a></li><li><a href="#tree-shaking-无效" class="table-of-contents__link toc-highlight">tree shaking 无效？</a></li></ul></li><li><a href="#tree-shaking-实现原理" class="table-of-contents__link toc-highlight">tree shaking 实现原理</a><ul><li><a href="#rollup" class="table-of-contents__link toc-highlight">rollup</a></li><li><a href="#webpack" class="table-of-contents__link toc-highlight">webpack</a></li></ul></li><li><a href="#参考资料" class="table-of-contents__link toc-highlight">参考资料</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://instagram.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Navigation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/whoami">Stuff of Legend</a></li><li class="footer__item"><a href="https://github.com/battleofplassey" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">other Projects</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://sidtoons.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">SidToons.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://vocab.js.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">vocab.js.org<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tldr.palashsh.me/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TL;DR News<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/blogasaurus_secondary.svg" alt="Zaoei Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></div><div class="footer__copyright">Copyright © 2024 Blogasaurus by Palash Shrivastava.</div></div></div></footer></div>
</body>
</html>